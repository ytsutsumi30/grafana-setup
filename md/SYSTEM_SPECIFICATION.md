# ç”Ÿç”£ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.2.0
**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç¨®åˆ¥**: ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸

---

## ğŸ“‹ ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#1-ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#2-ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#3-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
4. [APIä»•æ§˜](#4-apiä»•æ§˜)
5. [ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä»•æ§˜](#5-ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä»•æ§˜)
6. [ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£](#6-ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£)
7. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#7-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
8. [é‹ç”¨ãƒ»ä¿å®ˆ](#8-é‹ç”¨ä¿å®ˆ)

---

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ã‚·ã‚¹ãƒ†ãƒ åç§°

**ç”Ÿç”£ç®¡ç†ãƒ»å‡ºè·æ¤œå“çµ±åˆã‚·ã‚¹ãƒ†ãƒ **

### 1.2 ç›®çš„

è£½é€ æ¥­ã«ãŠã‘ã‚‹ç”Ÿç”£è¨ˆç”»ã‹ã‚‰å‡ºè·æ¤œå“ã¾ã§ã®å…¨å·¥ç¨‹ã‚’çµ±åˆç®¡ç†ã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªåœ¨åº«ç®¡ç†ã¨QRã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®æ¤œå“ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šã€æ¥­å‹™åŠ¹ç‡åŒ–ã¨å“è³ªå‘ä¸Šã‚’å®Ÿç¾ã™ã‚‹ã€‚

### 1.3 ä¸»è¦æ©Ÿèƒ½

```mermaid
mindmap
  root((ç”Ÿç”£ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ))
    ç”Ÿç”£ç®¡ç†
      ç”Ÿç”£è¨ˆç”»ç®¡ç†
      ç”Ÿç”£å®Ÿç¸¾è¨˜éŒ²
      å“è³ªã‚°ãƒ¬ãƒ¼ãƒ‰ç®¡ç†
    åœ¨åº«ç®¡ç†
      ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«è¿½è·¡
      å¼•å½“åœ¨åº«ç®¡ç†
      è‡ªå‹•åœ¨åº«è¨ˆç®—
    å‡ºè·ç®¡ç†
      å‡ºè·æŒ‡ç¤ºä½œæˆ
      å„ªå…ˆåº¦ç®¡ç†
      è¤‡æ•°æ‹ ç‚¹å¯¾å¿œ
      ç´å…¥å ´æ‰€ç®¡ç†
    QRæ¤œå“ã‚·ã‚¹ãƒ†ãƒ 
      QRã‚¹ã‚­ãƒ£ãƒ³æ¤œå“
      åŒæ¢±ç‰©ãƒã‚§ãƒƒã‚¯
      åœ¨åº«è‡ªå‹•æ›´æ–°
    å‡ºè·æ¤œå“
      æ¤œå“ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
      æœ€çµ‚æ‰¿èª
      æ¢±åŒ…çŠ¶æ…‹ç¢ºèª
    åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆ
      Grafanaãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
      KPIç›£è¦–
      ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ãƒãƒ¼ãƒˆ
```

### 1.4 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|---------|------|-----------|
| **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰** | HTML5, CSS3, JavaScript | - |
| **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰** | Node.js + Express | 18.x |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | PostgreSQL | 15.5 |
| **ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·** | nginx | Alpine |
| **ç›£è¦–** | Grafana + Prometheus | Latest |
| **ã‚³ãƒ³ãƒ†ãƒŠ** | Docker + Docker Compose | - |
| **ã‚¤ãƒ³ãƒ•ãƒ©** | AWS (Terraform) | - |

### 1.5 å¯¾å¿œãƒ‡ãƒã‚¤ã‚¹

- **ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—**: Windows/Mac/Linux (Chrome, Firefox, Edge)
- **ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ**: iPad Mini (7.9ã‚¤ãƒ³ãƒ)
- **ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³**: iPhone 6ä»¥é™ (4.7ã‚¤ãƒ³ãƒã€œ)
- **PWAå¯¾å¿œ**: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã€ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ 

---

## 2. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2.1 å…¨ä½“æ§‹æˆå›³

```mermaid
graph TB
    subgraph "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå±¤"
        A[Webãƒ–ãƒ©ã‚¦ã‚¶]
        B[ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹]
        C[ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ]
    end

    subgraph "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤"
        D[nginx<br/>Reverse Proxy]
    end

    subgraph "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤"
        E[Node.js API<br/>Express Server<br/>Port: 3001]
        F[Grafana<br/>Port: 3000]
        G[Prometheus<br/>Port: 9090]
    end

    subgraph "ãƒ‡ãƒ¼ã‚¿å±¤"
        H[(PostgreSQL 15<br/>Port: 5432)]
    end

    A --> D
    B --> D
    C --> D
    D -->|/api/*| E
    D -->|/grafana/*| F
    D -->|/prometheus/*| G
    D -->|static files| D
    E --> H
    F --> H
    G --> E

    style D fill:#f9f,stroke:#333,stroke-width:2px
    style E fill:#bbf,stroke:#333,stroke-width:2px
    style H fill:#bfb,stroke:#333,stroke-width:2px
```

### 2.2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```mermaid
graph LR
    subgraph "Frontend"
        A[index.html<br/>ãƒ¡ã‚¤ãƒ³ç”»é¢]
        B[shipping-inspection<br/>æ¤œå“ç”»é¢]
        C[JavaScript Modules]
        D[CSS Styles]
    end

    subgraph "Backend API"
        E[Express Router]
        F[Business Logic]
        G[Data Access Layer]
        H[Validation<br/>Joi]
        I[Logger<br/>Winston]
    end

    subgraph "Database"
        J[(PostgreSQL)]
    end

    A --> E
    B --> E
    C --> E
    E --> F
    F --> H
    F --> G
    F --> I
    G --> J

    style E fill:#e1f5ff,stroke:#333
    style J fill:#d4edda,stroke:#333
```

### 2.3 Dockeræ§‹æˆ

```mermaid
graph TB
    subgraph "Docker Network: production-network"
        A[nginx Container<br/>Port: 80, 443]
        B[production-api<br/>Node.js 18-alpine<br/>Port: 3001]
        C[grafana<br/>Port: 3000]
        D[prometheus<br/>Port: 9090]
    end

    E[(RDS PostgreSQL<br/>External)]

    F[Volume: grafana-storage]
    G[Volume: prometheus-storage]
    H[Local: ./api]
    I[Local: ./web]
    J[Local: ./nginx]

    A --> B
    A --> C
    A --> D
    B --> E
    C --> E
    C -.-> F
    D -.-> G
    B -.-> H
    A -.-> I
    A -.-> J

    style A fill:#ffcccc
    style B fill:#ccffcc
    style E fill:#ccccff
```

### 2.4 ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ§‹æˆ (AWS)

```mermaid
graph TB
    subgraph "AWS Cloud - ap-northeast-1"
        subgraph "VPC: 10.0.0.0/16"
            subgraph "Public Subnet: 10.0.1.0/24 - AZ-1a"
                A[EC2 Instance<br/>t3.micro<br/>Amazon Linux 2023]
                B[Elastic IP]
            end

            subgraph "DB Subnet Group"
                C[(RDS PostgreSQL 15<br/>db.t3.micro<br/>Single-AZ)]
            end
        end

        D[EventBridge Scheduler<br/>Auto Start/Stop]
        E[CloudWatch Logs]
        F[IAM Roles]
    end

    G[Internet Gateway]
    H((ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ))

    H --> G
    G --> B
    B --> A
    A --> C
    D -.-> A
    D -.-> C
    A --> E
    F --> A

    style A fill:#ff9999
    style C fill:#99ccff
    style D fill:#ffcc99
```

### 2.5 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant U as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant N as nginx
    participant A as API Server
    participant D as PostgreSQL
    participant G as Grafana

    Note over U,G: å‡ºè·æŒ‡ç¤ºç…§ä¼šãƒ•ãƒ­ãƒ¼
    U->>N: GET /
    N->>U: index.html
    U->>N: GET /api/shipping-instructions
    N->>A: Forward Request
    A->>D: SELECT shipping_instructions
    D->>A: Result Set
    A->>U: JSON Response

    Note over U,G: QRæ¤œå“ãƒ•ãƒ­ãƒ¼
    U->>A: POST /qr-inspections
    A->>D: INSERT qr_inspections
    D->>A: Inspection ID
    A->>U: Inspection Created
    U->>A: POST /qr-inspections/:id/scan
    A->>D: INSERT scan record
    A->>D: UPDATE scanned count
    D->>A: Success
    A->>U: Scan Result
    U->>A: PATCH /qr-inspections/:id/complete
    A->>D: UPDATE inventory (stock)
    A->>D: UPDATE inspection status
    D->>A: Success
    A->>U: Inspection Completed

    Note over U,G: åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆ
    U->>N: GET /grafana/
    N->>G: Forward Request
    G->>D: Query metrics
    D->>G: Data
    G->>U: Dashboard
```

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 3.1 ERå›³

```mermaid
erDiagram
    products ||--o{ production_plans : "è¨ˆç”»å¯¾è±¡"
    products ||--o{ production_records : "ç”Ÿç”£å®Ÿç¸¾"
    products ||--o{ shipping_instructions : "å‡ºè·å¯¾è±¡"
    products ||--o{ product_components : "åŒæ¢±ç‰©"
    products ||--o| inventory : "åœ¨åº«"

    production_plans ||--o{ production_records : "å®Ÿç¸¾è¨˜éŒ²"

    shipping_locations ||--o{ shipping_instructions : "å‡ºè·å…ƒ"
    delivery_locations ||--o{ shipping_instructions : "ç´å…¥å…ˆ"

    shipping_instructions ||--o{ shipping_inspections : "æ¤œå“è¨˜éŒ²"
    shipping_instructions ||--o{ qr_inspections : "QRæ¤œå“"

    qr_inspections ||--o{ qr_inspection_details : "æ¤œå“è©³ç´°"
    product_components ||--o{ qr_inspection_details : "ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡"

    production_records ||--o{ inspections : "å“è³ªæ¤œæŸ»"

    products {
        serial id PK
        varchar product_code UK
        varchar product_name
        text description
        decimal unit_price
        varchar category
        timestamp created_at
        timestamp updated_at
    }

    production_plans {
        serial id PK
        varchar plan_id UK
        int product_id FK
        int planned_quantity
        date planned_start_date
        date planned_end_date
        varchar status
        timestamp created_at
    }

    shipping_instructions {
        serial id PK
        varchar instruction_id UK
        int product_id FK
        int quantity
        date shipping_date
        int shipping_location_id FK
        int delivery_location_id FK
        varchar customer_name
        varchar priority
        varchar status
        varchar tracking_number
        text notes
        timestamp created_at
    }

    inventory {
        serial id PK
        int product_id FK
        int current_stock
        int reserved_stock
        int available_stock "GENERATED"
        varchar location
        timestamp last_updated
    }

    qr_inspections {
        serial id PK
        int shipping_instruction_id FK
        int product_id FK
        varchar inspector_name
        int total_components
        int scanned_components
        int passed_quantity
        int current_stock_before
        int current_stock_after
        varchar status
        text notes
        timestamp created_at
        timestamp completed_at
    }
```

### 3.2 ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

#### 3.2.1 è£½å“ãƒã‚¹ã‚¿ (products)

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|----|----|------|
| id | SERIAL | PRIMARY KEY | è£½å“ID |
| product_code | VARCHAR(50) | UNIQUE, NOT NULL | è£½å“ã‚³ãƒ¼ãƒ‰ |
| product_name | VARCHAR(255) | NOT NULL | è£½å“å |
| description | TEXT | - | èª¬æ˜ |
| unit_price | DECIMAL(10,2) | - | å˜ä¾¡ |
| category | VARCHAR(100) | - | ã‚«ãƒ†ã‚´ãƒª |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | æ›´æ–°æ—¥æ™‚ |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: `idx_products_code` ON (product_code)

#### 3.2.2 å‡ºè·æŒ‡ç¤º (shipping_instructions)

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|----|----|------|
| id | SERIAL | PRIMARY KEY | å‡ºè·æŒ‡ç¤ºID |
| instruction_id | VARCHAR(50) | UNIQUE, NOT NULL | å‡ºè·æŒ‡ç¤ºç•ªå· |
| product_id | INTEGER | FK â†’ products(id) | è£½å“ID |
| quantity | INTEGER | NOT NULL | æ•°é‡ |
| shipping_date | DATE | - | å‡ºè·äºˆå®šæ—¥ |
| shipping_location_id | INTEGER | FK â†’ shipping_locations(id) | å‡ºè·å ´æ‰€ID |
| delivery_location_id | INTEGER | FK â†’ delivery_locations(id) | ç´å…¥å ´æ‰€ID |
| customer_name | VARCHAR(255) | - | é¡§å®¢å |
| priority | VARCHAR(20) | DEFAULT 'normal' | å„ªå…ˆåº¦ (high/normal/low) |
| status | VARCHAR(20) | DEFAULT 'pending' | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| tracking_number | VARCHAR(100) | - | è¿½è·¡ç•ªå· |
| notes | TEXT | - | å‚™è€ƒ |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | æ›´æ–°æ—¥æ™‚ |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: `idx_shipping_instructions_status` ON (status)

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»**:
```mermaid
stateDiagram-v2
    [*] --> pending: å‡ºè·æŒ‡ç¤ºä½œæˆ
    pending --> processing: QRæ¤œå“å®Œäº†
    processing --> shipped: å‡ºè·å®Œäº†
    shipped --> delivered: é…é€å®Œäº†
    pending --> cancelled: ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    processing --> cancelled: ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    delivered --> [*]
    cancelled --> [*]
```

#### 3.2.3 åœ¨åº« (inventory)

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|----|----|------|
| id | SERIAL | PRIMARY KEY | åœ¨åº«ID |
| product_id | INTEGER | FK â†’ products(id) | è£½å“ID |
| current_stock | INTEGER | NOT NULL, DEFAULT 0 | ç¾åœ¨åº« |
| reserved_stock | INTEGER | NOT NULL, DEFAULT 0 | å¼•å½“åœ¨åº« |
| available_stock | INTEGER | GENERATED ALWAYS AS | åˆ©ç”¨å¯èƒ½åœ¨åº« (è‡ªå‹•è¨ˆç®—) |
| location | VARCHAR(100) | - | ä¿ç®¡å ´æ‰€ |
| last_updated | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | æœ€çµ‚æ›´æ–°æ—¥æ™‚ |

**è¨ˆç®—ã‚«ãƒ©ãƒ **:
```sql
available_stock = current_stock - reserved_stock
```

#### 3.2.4 QRæ¤œå“ (qr_inspections)

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|----|----|------|
| id | SERIAL | PRIMARY KEY | QRæ¤œå“ID |
| shipping_instruction_id | INTEGER | FK â†’ shipping_instructions(id) | å‡ºè·æŒ‡ç¤ºID |
| product_id | INTEGER | FK â†’ products(id) | è£½å“ID |
| inspector_name | VARCHAR(100) | NOT NULL | æ¤œå“è€…å |
| total_components | INTEGER | NOT NULL, DEFAULT 0 | ç·åŒæ¢±ç‰©æ•° |
| scanned_components | INTEGER | NOT NULL, DEFAULT 0 | ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆæ•° |
| passed_quantity | INTEGER | DEFAULT 0 | åˆæ ¼æ•° |
| current_stock_before | INTEGER | - | æ¤œå“å‰åœ¨åº« |
| current_stock_after | INTEGER | - | æ¤œå“å¾Œåœ¨åº« |
| status | VARCHAR(20) | DEFAULT 'in_progress' | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| notes | TEXT | - | å‚™è€ƒ |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ä½œæˆæ—¥æ™‚ |
| completed_at | TIMESTAMP | - | å®Œäº†æ—¥æ™‚ |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | æ›´æ–°æ—¥æ™‚ |

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: `in_progress`, `completed`, `failed`

### 3.3 ãƒ“ãƒ¥ãƒ¼å®šç¾©

#### shipping_instruction_summary

å‡ºè·æŒ‡ç¤ºã®ã‚µãƒãƒªãƒ¼æƒ…å ±ã‚’æä¾›ã™ã‚‹ãƒ“ãƒ¥ãƒ¼

```sql
CREATE VIEW shipping_instruction_summary AS
SELECT
    si.instruction_id,
    p.product_code,
    p.product_name,
    si.quantity as ordered_quantity,
    si.customer_name,
    si.shipping_date,
    si.status as shipping_status,
    sl.location_name as shipping_location_name,
    dl.location_name as delivery_location_name,
    dl.location_code as delivery_location_code,
    shi.inspector_name,
    shi.inspection_date,
    shi.passed_quantity,
    shi.final_approval
FROM shipping_instructions si
LEFT JOIN products p ON si.product_id = p.id
LEFT JOIN shipping_locations sl ON si.shipping_location_id = sl.id
LEFT JOIN delivery_locations dl ON si.delivery_location_id = dl.id
LEFT JOIN shipping_inspections shi ON si.id = shi.shipping_instruction_id
ORDER BY si.created_at DESC;
```

---

## 4. APIä»•æ§˜

### 4.1 APIæ¦‚è¦

**ãƒ™ãƒ¼ã‚¹URL**: `http://localhost/api` (ãƒ­ãƒ¼ã‚«ãƒ«) / `http://<EC2-IP>/api` (AWS)

**èªè¨¼**: ç¾åœ¨æœªå®Ÿè£… (POCç’°å¢ƒ)

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼**: JSON

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
```json
{
  "error": "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
}
```

### 4.2 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

```mermaid
graph LR
    A[API Server] --> B[è£½å“é–¢é€£]
    A --> C[å‡ºè·æŒ‡ç¤ºé–¢é€£]
    A --> D[QRæ¤œå“é–¢é€£]
    A --> E[å‡ºè·æ¤œå“é–¢é€£]
    A --> F[ãƒ¬ãƒãƒ¼ãƒˆé–¢é€£]
    A --> G[ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯]

    B --> B1[GET /products]
    B --> B2[GET /products/:id]
    B --> B3[GET /products/:id/components]

    C --> C1[GET /shipping-instructions]
    C --> C2[GET /shipping-instructions/:id]
    C --> C3[GET /shipping-instructions/summary/by-delivery-location]
    C --> C4[PATCH /shipping-instructions/:id/picking]

    D --> D1[POST /qr-inspections]
    D --> D2[POST /qr-inspections/:id/scan]
    D --> D3[PATCH /qr-inspections/:id/complete]
    D --> D4[GET /qr-inspections/:id]

    E --> E1[GET /shipping-inspections]
    E --> E2[POST /shipping-inspections]

    F --> F1[GET /reports/shipping-summary]
    F --> F2[GET /reports/dashboard-stats]

    G --> G1[GET /health]
    G --> G2[GET /db-test]
```

### 4.3 ä¸»è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè©³ç´°

#### 4.3.1 è£½å“ä¸€è¦§å–å¾—

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /products`

**èª¬æ˜**: å…¨è£½å“ã®ä¸€è¦§ã‚’åœ¨åº«æƒ…å ±ã¨ã¨ã‚‚ã«å–å¾—

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
[
  {
    "id": 1,
    "product_code": "PROD001",
    "product_name": "è£½å“A",
    "description": "æ¨™æº–è£½å“A",
    "unit_price": "1000.00",
    "category": "Category1",
    "current_stock": 75,
    "available_stock": 25
  }
]
```

#### 4.3.2 å‡ºè·æŒ‡ç¤ºä¸€è¦§å–å¾—

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /shipping-instructions`

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `status`: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ (pending, processing, shipped, delivered)
- `priority`: å„ªå…ˆåº¦ãƒ•ã‚£ãƒ«ã‚¿ (high, normal, low)
- `shipping_location`: å‡ºè·å ´æ‰€ã‚³ãƒ¼ãƒ‰
- `delivery_location`: ç´å…¥å ´æ‰€ã‚³ãƒ¼ãƒ‰
- `shipping_date_from`: å‡ºè·æ—¥From (YYYY-MM-DD)
- `shipping_date_to`: å‡ºè·æ—¥To (YYYY-MM-DD)
- `instruction_id`: å‡ºè·æŒ‡ç¤ºç•ªå· (éƒ¨åˆ†ä¸€è‡´)

**ä¾‹**: `GET /api/shipping-instructions?status=pending&priority=high`

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
[
  {
    "id": 1,
    "instruction_id": "SHIP001",
    "product_id": 1,
    "product_code": "PROD001",
    "product_name": "è£½å“A",
    "quantity": 50,
    "shipping_date": "2024-08-27",
    "shipping_location_id": 1,
    "shipping_location_name": "æ±äº¬æœ¬ç¤¾å€‰åº«",
    "shipping_location_code": "TOKYO_MAIN",
    "delivery_location_id": 1,
    "delivery_location_name": "æ±äº¬å–¶æ¥­æ‰€",
    "delivery_location_code": "TOKYO_BRANCH",
    "delivery_address": "æ±äº¬éƒ½åƒä»£ç”°åŒºä¸¸ã®å†…1-1-1",
    "delivery_phone": "03-1234-5678",
    "customer_name": "ABCå•†äº‹",
    "priority": "high",
    "status": "pending",
    "tracking_number": null,
    "notes": "ç·Šæ€¥å‡ºè·",
    "created_at": "2024-08-26T10:00:00.000Z",
    "updated_at": "2024-08-26T10:00:00.000Z"
  }
]
```

#### 4.3.3 QRæ¤œå“é–‹å§‹

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /qr-inspections`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**:
```json
{
  "shipping_instruction_id": 1,
  "inspector_name": "ç”°ä¸­å¤ªéƒ"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "id": 1,
  "shipping_instruction_id": 1,
  "product_id": 1,
  "inspector_name": "ç”°ä¸­å¤ªéƒ",
  "total_components": 5,
  "scanned_components": 0,
  "passed_quantity": 0,
  "current_stock_before": 75,
  "current_stock_after": null,
  "status": "in_progress",
  "notes": null,
  "created_at": "2024-08-26T10:00:00.000Z",
  "completed_at": null,
  "updated_at": "2024-08-26T10:00:00.000Z"
}
```

#### 4.3.4 QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /qr-inspections/:id/scan`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**:
```json
{
  "qr_code": "PROD001-MAIN-001"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (æˆåŠŸ)**:
```json
{
  "success": true,
  "message": "ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ",
  "component": {
    "id": 1,
    "product_id": 1,
    "component_name": "æœ¬ä½“",
    "component_type": "main",
    "qr_code": "PROD001-MAIN-001",
    "is_required": true
  },
  "data": {
    "id": 1,
    "qr_inspection_id": 1,
    "product_component_id": 1,
    "qr_code": "PROD001-MAIN-001",
    "status": "scanned",
    "scanned_at": "2024-08-26T10:05:00.000Z"
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (ã‚¨ãƒ©ãƒ¼ - é‡è¤‡)**:
```json
{
  "success": false,
  "message": "æ—¢ã«ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿ã§ã™",
  "component": { ... }
}
```

#### 4.3.5 QRæ¤œå“å®Œäº†

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `PATCH /qr-inspections/:id/complete`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**:
```json
{
  "notes": "æ¤œå“å®Œäº† - å•é¡Œãªã—"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "id": 1,
  "shipping_instruction_id": 1,
  "product_id": 1,
  "inspector_name": "ç”°ä¸­å¤ªéƒ",
  "total_components": 5,
  "scanned_components": 5,
  "passed_quantity": 50,
  "current_stock_before": 75,
  "current_stock_after": 25,
  "status": "completed",
  "notes": "æ¤œå“å®Œäº† - å•é¡Œãªã—",
  "created_at": "2024-08-26T10:00:00.000Z",
  "completed_at": "2024-08-26T10:10:00.000Z",
  "updated_at": "2024-08-26T10:10:00.000Z"
}
```

**å‡¦ç†å†…å®¹**:
1. å…¨åŒæ¢±ç‰©ãŒã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿ã‹ç¢ºèª
2. åˆæ ¼ã®å ´åˆã€åœ¨åº«ã‚’æ¸›ç®— (current_stock - passed_quantity)
3. å‡ºè·æŒ‡ç¤ºã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ `processing` ã«æ›´æ–°
4. QRæ¤œå“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ `completed` ã«æ›´æ–°

### 4.4 ãƒ¬ãƒ¼ãƒˆåˆ¶é™

**è¨­å®š**:
- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: 15åˆ†
- æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°: 100
- ãƒ—ãƒ­ã‚­ã‚·å¯¾å¿œ: æœ‰åŠ¹

**è¶…éæ™‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```http
HTTP/1.1 429 Too Many Requests
{
  "error": "Too many requests"
}
```

### 4.5 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼

HelmetãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«ã‚ˆã‚Šä»¥ä¸‹ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è‡ªå‹•è¨­å®š:

- `X-DNS-Prefetch-Control`
- `X-Frame-Options`
- `X-Content-Type-Options`
- `Strict-Transport-Security`
- `X-Download-Options`
- `X-Permitted-Cross-Domain-Policies`

---

## 5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä»•æ§˜

### 5.1 ç”»é¢æ§‹æˆ

```mermaid
graph TD
    A[ãƒ‡ãƒã‚¤ã‚¹ãƒ¢ãƒ¼ãƒ‰é¸æŠ] --> B{ãƒ¢ãƒ¼ãƒ‰é¸æŠ}
    B -->|iPad Mini| C[ãƒ¡ã‚¤ãƒ³ç”»é¢<br/>2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ]
    B -->|iPhone 6| D[ãƒ¡ã‚¤ãƒ³ç”»é¢<br/>1ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ]

    C --> E[ç´å…¥å ´æ‰€åˆ¥è¡¨ç¤º]
    D --> E

    E --> F[ç´å…¥å ´æ‰€è©³ç´°]
    F --> G[QRæ¤œå“ç”»é¢]

    C --> H[é…é€ãƒãƒƒãƒ—]
    D --> H

    G --> I[æ¤œå“å®Œäº†]
    I --> E

    style A fill:#ffe6e6
    style C fill:#e6f3ff
    style D fill:#e6ffe6
    style G fill:#fff3e6
```

### 5.2 ä¸»è¦ç”»é¢ä»•æ§˜

#### 5.2.1 ãƒ‡ãƒã‚¤ã‚¹ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢

**ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒã‚¤ã‚¹ã«æœ€é©åŒ–ã•ã‚ŒãŸUIã‚’æä¾›

**ãƒ¢ãƒ¼ãƒ‰**:
1. **iPad Mini ãƒ¢ãƒ¼ãƒ‰** (768Ã—1024)
   - 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
   - å¤§ããªæ–‡å­—ã‚µã‚¤ã‚º
   - åºƒã„ä½œæ¥­ã‚¨ãƒªã‚¢

2. **iPhone 6 ãƒ¢ãƒ¼ãƒ‰** (375Ã—667)
   - 1ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
   - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º
   - ç‰‡æ‰‹æ“ä½œå¯¾å¿œ

**æ©Ÿèƒ½**:
- LocalStorageã«é¸æŠã‚’ä¿å­˜
- ç”»é¢å³ä¸Šã®ãƒœã‚¿ãƒ³ã§åˆ‡ã‚Šæ›¿ãˆå¯èƒ½

#### 5.2.2 ãƒ¡ã‚¤ãƒ³ç”»é¢ (ç´å…¥å ´æ‰€åˆ¥è¡¨ç¤º)

**è¡¨ç¤ºå†…å®¹**:
- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
  - å‡ºè·å ´æ‰€
  - ç´å…¥å ´æ‰€
  - å‡ºè·æ—¥ç¯„å›²
  - å‡ºè·æŒ‡ç¤ºç•ªå·
- ç´å…¥å ´æ‰€åˆ¥ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
  - ç·å“ç›®æ•°
  - ç·æ•°é‡
  - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆ
  - é…é€æ–¹æ³•
  - æœ€æ—©ãƒ»æœ€é…å‡ºè·æ—¥

**æ“ä½œ**:
- ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ç”»é¢ã¸é·ç§»
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢
- ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°

#### 5.2.3 ç´å…¥å ´æ‰€è©³ç´°ç”»é¢

**è¡¨ç¤ºå†…å®¹**:
- ç´å…¥å ´æ‰€æƒ…å ±
  - åç§°ã€ä½æ‰€ã€é›»è©±ç•ªå·
  - æ‹…å½“è€…ã€é…é€æ–¹æ³•
- å“ç›®ãƒªã‚¹ãƒˆ
  - è£½å“ã‚³ãƒ¼ãƒ‰ãƒ»åç§°
  - æ•°é‡
  - å‡ºè·äºˆå®šæ—¥
  - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  - å„ªå…ˆåº¦

**æ“ä½œ**:
- QRæ¤œå“é–‹å§‹ãƒœã‚¿ãƒ³
- å€‹åˆ¥å“ç›®ã®è©³ç´°è¡¨ç¤º

#### 5.2.4 QRæ¤œå“ç”»é¢

**è¡¨ç¤ºå†…å®¹**:
- æ¤œå“æƒ…å ±ãƒ˜ãƒƒãƒ€ãƒ¼
  - å‡ºè·æŒ‡ç¤ºç•ªå·
  - è£½å“å
  - æ•°é‡
  - æ¤œå“è€…å
- é€²æ—è¡¨ç¤º
  - ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
  - ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿/ç·æ•°
- åŒæ¢±ç‰©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
  - æœ¬ä½“
  - ä»˜å±å“
  - èª¬æ˜æ›¸
  - ä¿è¨¼æ›¸
- QRã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼

**æ“ä½œãƒ•ãƒ­ãƒ¼**:
```mermaid
sequenceDiagram
    participant U as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as QRæ¤œå“ç”»é¢
    participant CAM as ã‚«ãƒ¡ãƒ©
    participant API as API Server

    U->>UI: æ¤œå“é–‹å§‹ãƒœã‚¿ãƒ³
    UI->>API: POST /qr-inspections
    API->>UI: Inspection ID

    U->>UI: QRã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
    UI->>CAM: ã‚«ãƒ¡ãƒ©èµ·å‹•
    CAM->>UI: QRã‚³ãƒ¼ãƒ‰æ¤œå‡º
    UI->>API: POST /scan (QRã‚³ãƒ¼ãƒ‰)
    API->>UI: ã‚¹ã‚­ãƒ£ãƒ³çµæœ
    UI->>U: ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯è¡¨ç¤º

    Note over U,API: å…¨åŒæ¢±ç‰©ã‚’ã‚¹ã‚­ãƒ£ãƒ³

    U->>UI: æ¤œå“å®Œäº†ãƒœã‚¿ãƒ³
    UI->>API: PATCH /complete
    API->>UI: å®Œäº†é€šçŸ¥
    UI->>U: å®Œäº†ç”»é¢è¡¨ç¤º
```

**æ©Ÿèƒ½**:
- Safariæœ€é©åŒ–QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼
- é‡è¤‡ã‚¹ã‚­ãƒ£ãƒ³æ¤œå‡º
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- éŸ³å£°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

### 5.3 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ

```mermaid
graph TB
    A[app.js<br/>ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³] --> B[delivery-map.js<br/>é…é€ãƒãƒƒãƒ—æ©Ÿèƒ½]
    A --> C[qr-scanner.js<br/>QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼æ©Ÿèƒ½]
    A --> D[inventory-manager.js<br/>åœ¨åº«ç®¡ç†æ©Ÿèƒ½]
    A --> E[device-mode.js<br/>ãƒ‡ãƒã‚¤ã‚¹ãƒ¢ãƒ¼ãƒ‰ç®¡ç†]

    F[main.css<br/>ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«] --> G[delivery.css<br/>é…é€ç”»é¢ã‚¹ã‚¿ã‚¤ãƒ«]
    F --> H[map.css<br/>ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«]
    F --> I[qr-scanner.css<br/>QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«]
    F --> J[mobile.css<br/>ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–]
    F --> K[device-mode.css<br/>ãƒ‡ãƒã‚¤ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«]

    style A fill:#ffcccc
    style F fill:#ccccff
```

### 5.4 PWAå¯¾å¿œ

**manifest.json**:
```json
{
  "name": "å‡ºè·æŒ‡ç¤ºç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ",
  "short_name": "å‡ºè·ç®¡ç†",
  "start_url": "/",
  "display": "standalone",
  "theme_color": "#2563eb",
  "background_color": "#ffffff",
  "icons": [
    {
      "src": "icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    }
  ]
}
```

**æ©Ÿèƒ½**:
- ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ 
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ (Service Worker)
- ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ (å°†æ¥å®Ÿè£…äºˆå®š)

---

## 6. ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£

### 6.1 ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ (Docker Compose)

**æ§‹æˆ**:
```yaml
services:
  - nginx (Port: 80, 443)
  - production-api (Port: 3001)
  - postgres (Port: 5432)
  - grafana (Port: 3000)
  - prometheus (Port: 9090)
```

**èµ·å‹•æ–¹æ³•**:
```bash
./manage.sh start
```

### 6.2 AWSç’°å¢ƒ (Terraform)

#### 6.2.1 ãƒªã‚½ãƒ¼ã‚¹æ§‹æˆ

```mermaid
graph TB
    subgraph "AWS Region: ap-northeast-1"
        subgraph "VPC: 10.0.0.0/16"
            A[Public Subnet<br/>10.0.1.0/24<br/>AZ: ap-northeast-1a]
            B[DB Subnet<br/>10.0.2.0/24<br/>AZ: ap-northeast-1c]

            C[EC2: t3.micro<br/>Amazon Linux 2023<br/>Docker Host]
            D[(RDS: db.t3.micro<br/>PostgreSQL 15<br/>Single-AZ)]

            E[Internet Gateway]
            F[Security Group: EC2]
            G[Security Group: RDS]
            H[Elastic IP]
        end

        I[EventBridge Scheduler<br/>Start: Mon-Fri 9:00 JST<br/>Stop: Mon-Fri 19:00 JST]
        J[CloudWatch Logs]
        K[IAM Role: EC2]
        L[IAM Role: Scheduler]
    end

    M((Internet))

    M --> E
    E --> H
    H --> C
    C --> D
    I -.-> C
    I -.-> D
    C --> J
    K --> C
    L --> I
    F --> C
    G --> D

    style C fill:#ff9999
    style D fill:#99ccff
    style I fill:#ffcc99
```

#### 6.2.2 ã‚³ã‚¹ãƒˆæ§‹æˆ (æœˆé¡)

**POCç’°å¢ƒ (160æ™‚é–“/æœˆç¨¼åƒ)**:

| ãƒªã‚½ãƒ¼ã‚¹ | ã‚¹ãƒšãƒƒã‚¯ | ç¨¼åƒæ™‚é–“ | æœˆé¡ |
|---------|---------|---------|------|
| EC2 | t3.micro (1vCPU, 1GB) | 160h | $3-4 |
| RDS | db.t3.micro (2vCPU, 1GB) | 160h | $12-15 |
| EBS | gp3 30GB | 720h | $3 |
| Elastic IP | - | 160h | $0 |
| Data Transfer | ~1GB | - | $1-2 |
| **åˆè¨ˆ** | | | **$19-24** |

**ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š**:
```hcl
start_schedule = "cron(0 0 ? * MON-FRI *)"   # 9:00 AM JST
stop_schedule  = "cron(0 10 ? * MON-FRI *)"  # 7:00 PM JST
timezone       = "Asia/Tokyo"
```

#### 6.2.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ§‹æˆ

**EC2 Security Group**:
| ã‚¿ã‚¤ãƒ— | ãƒãƒ¼ãƒˆ | ã‚½ãƒ¼ã‚¹ | èª¬æ˜ |
|-------|--------|--------|------|
| HTTP | 80 | 0.0.0.0/0 | Webã‚¢ã‚¯ã‚»ã‚¹ |
| HTTPS | 443 | 0.0.0.0/0 | ã‚»ã‚­ãƒ¥ã‚¢Webã‚¢ã‚¯ã‚»ã‚¹ |
| SSH | 22 | ç®¡ç†è€…IP | SSHç®¡ç†ã‚¢ã‚¯ã‚»ã‚¹ |

**RDS Security Group**:
| ã‚¿ã‚¤ãƒ— | ãƒãƒ¼ãƒˆ | ã‚½ãƒ¼ã‚¹ | èª¬æ˜ |
|-------|--------|--------|------|
| PostgreSQL | 5432 | EC2 SG | EC2ã‹ã‚‰ã®DBæ¥ç¶š |

**IAM Policies**:
- EC2: SSM Session Manager, CloudWatch Logs
- Scheduler: EC2 Start/Stop, RDS Start/Stop

### 6.3 ç›£è¦–ãƒ»ãƒ­ã‚°

#### 6.3.1 CloudWatch Logs

**ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒ **:
- `/aws/rds/instance/poc-production-db/postgresql`
- `/aws/ec2/production-management`

#### 6.3.2 Grafana ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹**:
- å‡ºè·æŒ‡ç¤ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆ
- æ¤œå“å®Œäº†ç‡
- åœ¨åº«æ¨ç§»
- API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 

#### 6.3.3 ã‚¢ãƒ©ãƒ¼ãƒˆ

**è¨­å®šé …ç›®**:
- EC2 CPUä½¿ç”¨ç‡ > 80%
- RDS æ¥ç¶šæ•° > 50
- ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ > 80%
- API ã‚¨ãƒ©ãƒ¼ç‡ > 5%

---

## 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 7.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ä¸€è¦§

```mermaid
mindmap
  root((ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£))
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤
      Helmet ãƒ˜ãƒƒãƒ€ãƒ¼
      CORSè¨­å®š
      ãƒ¬ãƒ¼ãƒˆåˆ¶é™
      å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
    ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤
      Security Group
      ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ
      VPCåˆ†é›¢
    ãƒ‡ãƒ¼ã‚¿å±¤
      EBSæš—å·åŒ–
      RDSæš—å·åŒ–
      ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æš—å·åŒ–
    ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†
      IAM Role
      SSH Keyèªè¨¼
      IPåˆ¶é™
    ç›£è¦–
      CloudWatch Logs
      ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°
      ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
```

### 7.2 å®Ÿè£…æ¸ˆã¿ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

#### 7.2.1 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«

**Helmet.js**:
```javascript
app.use(helmet());
```
è¨­å®šã•ã‚Œã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼:
- `X-DNS-Prefetch-Control: off`
- `X-Frame-Options: SAMEORIGIN`
- `X-Content-Type-Options: nosniff`
- `Strict-Transport-Security`
- `X-Download-Options: noopen`

**CORS**:
```javascript
app.use(cors());
```

**ãƒ¬ãƒ¼ãƒˆåˆ¶é™**:
```javascript
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15åˆ†
  max: 100,                   // 100ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  trustProxy: true
});
```

**å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ (Joi)**:
```javascript
const shippingInspectionSchema = Joi.object({
  shipping_instruction_id: Joi.number().required(),
  inspector_name: Joi.string().max(100).required(),
  inspected_quantity: Joi.number().min(0).required(),
  // ...
});
```

**SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–**:
```javascript
// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª
pool.query('SELECT * FROM products WHERE id = $1', [id]);
```

#### 7.2.2 ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«

**æš—å·åŒ–**:
- EBS: æœ‰åŠ¹
- RDS: æœ‰åŠ¹
- é€šä¿¡: HTTPSå¯¾å¿œ (SSLè¨¼æ˜æ›¸é…ç½®æ¸ˆã¿)

**ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**:
- EC2: SSH Keyèªè¨¼
- RDS: VPCå†…éƒ¨ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹
- API: ãƒ¬ãƒ¼ãƒˆåˆ¶é™

### 7.3 æ¨å¥¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

**æœ¬ç•ªç’°å¢ƒã§ã®å¯¾å¿œäº‹é …**:

1. **èªè¨¼ãƒ»èªå¯ã®å®Ÿè£…**
   - JWTèªè¨¼
   - ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ (RBAC)
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

2. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
   - WAFå°å…¥ (AWS WAF)
   - DDoSå¯¾ç­– (AWS Shield)
   - VPNæ¥ç¶š

3. **ç›£æŸ»ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹**
   - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°åˆ†æ
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
   - è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³

4. **ãƒ‡ãƒ¼ã‚¿ä¿è­·**
   - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¬ãƒ™ãƒ«æš—å·åŒ–
   - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æš—å·åŒ–
   - ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°

---

## 8. é‹ç”¨ãƒ»ä¿å®ˆ

### 8.1 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

#### 8.1.1 RDSè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

**è¨­å®š**:
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: 03:00-04:00 UTC (12:00-13:00 JST)
- ä¿æŒæœŸé–“: 7æ—¥é–“
- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ: è‡ªå‹•

**å¾©å…ƒæ‰‹é †**:
```bash
# ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¸€è¦§
aws rds describe-db-snapshots \
  --db-instance-identifier poc-production-db

# å¾©å…ƒ
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier new-instance \
  --db-snapshot-identifier snapshot-id
```

#### 8.1.2 æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**:
```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
./manage.sh backup

# ã¾ãŸã¯
docker-compose exec postgres pg_dump \
  -U production_user production_db > backup.sql

# å¾©å…ƒ
docker-compose exec -T postgres psql \
  -U production_user -d production_db < backup.sql
```

**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**:
```bash
# ã‚³ãƒ¼ãƒ‰: Gitç®¡ç†
git push origin main

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
tar -czf config-backup.tar.gz \
  .env docker-compose.yml nginx/ grafana/
```

### 8.2 ç›£è¦–é …ç›®

```mermaid
graph TB
    A[ç›£è¦–é …ç›®] --> B[ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹]
    A --> C[ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³]
    A --> D[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹]
    A --> E[ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯]

    B --> B1[CPUä½¿ç”¨ç‡]
    B --> B2[ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡]
    B --> B3[ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡]
    B --> B4[ãƒ‡ã‚£ã‚¹ã‚¯I/O]

    C --> C1[API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ]
    C --> C2[ã‚¨ãƒ©ãƒ¼ç‡]
    C --> C3[ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°]
    C --> C4[ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³]

    D --> D1[æ¥ç¶šæ•°]
    D --> D2[ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹]
    D --> D3[ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶]
    D --> D4[ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨ç‡]

    E --> E1[ãƒ‡ãƒ¼ã‚¿è»¢é€é‡]
    E --> E2[ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·]
    E --> E3[ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹]
```

### 8.3 ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤

| é …ç›® | Warning | Critical |
|-----|---------|----------|
| CPUä½¿ç”¨ç‡ | 70% | 90% |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ | 75% | 90% |
| ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ | 80% | 90% |
| DBæ¥ç¶šæ•° | 40 | 50 |
| APIã‚¨ãƒ©ãƒ¼ç‡ | 3% | 5% |
| ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  | 1000ms | 3000ms |

### 8.4 ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥

#### 8.4.1 å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° (ã‚¹ãƒšãƒƒã‚¯ã‚¢ãƒƒãƒ—)

**EC2**:
```hcl
# terraform.tfvars
instance_type = "t3.small"   # 1GB â†’ 2GB RAM
# ã¾ãŸã¯
instance_type = "t3.medium"  # 1GB â†’ 4GB RAM
```

**RDS**:
```hcl
db_instance_class = "db.t3.small"   # 1GB â†’ 2GB RAM
# ã¾ãŸã¯
db_instance_class = "db.t3.medium"  # 1GB â†’ 4GB RAM
```

#### 8.4.2 æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° (ECSç§»è¡Œ)

**å°†æ¥ã®æ‹¡å¼µè¨ˆç”»**:
1. ECS Fargateç§»è¡Œ
2. ALBã«ã‚ˆã‚‹è² è·åˆ†æ•£
3. RDS Read Replicaè¿½åŠ 
4. ElastiCacheå°å…¥

### 8.5 ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ‰‹é †

#### 8.5.1 å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

**é€±æ¬¡**:
- ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª
- ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç¢ºèª
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª

**æœˆæ¬¡**:
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
- ã‚³ã‚¹ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼

**å››åŠæœŸ**:
- ç½å®³å¾©æ—§ãƒ†ã‚¹ãƒˆ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°

#### 8.5.2 ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

**EC2ãŒèµ·å‹•ã—ãªã„**:
```bash
# ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ç¢ºèª
aws ec2 get-console-output \
  --instance-id i-xxxxx

# ãƒ­ã‚°ç¢ºèª
ssh ec2-user@<IP>
sudo journalctl -u production-management
```

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼**:
```bash
# æ¥ç¶šãƒ†ã‚¹ãƒˆ
docker run --rm -it postgres:15-alpine \
  psql -h <RDS_ENDPOINT> -U production_user -d production_db

# ãƒ­ã‚°ç¢ºèª
aws logs tail /aws/rds/instance/poc-production-db/postgresql
```

**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼**:
```bash
# ã‚³ãƒ³ãƒ†ãƒŠãƒ­ã‚°ç¢ºèª
docker-compose logs production-api

# APIãƒ­ã‚°ç¢ºèª
tail -f api/error.log
tail -f api/combined.log
```

### 8.6 ç½å®³å¾©æ—§è¨ˆç”» (DR)

#### 8.6.1 RPO/RTOç›®æ¨™

| é …ç›® | ç›®æ¨™ |
|-----|------|
| **RPO** (Recovery Point Objective) | 24æ™‚é–“ |
| **RTO** (Recovery Time Objective) | 4æ™‚é–“ |

#### 8.6.2 å¾©æ—§æ‰‹é †

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹éšœå®³**:
1. æœ€æ–°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰å¾©å…ƒ
2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¥ç¶šå…ˆå¤‰æ›´
3. å‹•ä½œç¢ºèª

**EC2éšœå®³**:
1. æ–°ã—ã„EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•
2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
3. Elastic IPä»˜ã‘æ›¿ãˆ
4. å‹•ä½œç¢ºèª

**å®Œå…¨éšœå®³**:
1. åˆ¥ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«Terraformé©ç”¨
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¾©å…ƒ
3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
4. DNSãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°

---

## ä»˜éŒ²

### A. ç”¨èªé›†

| ç”¨èª | èª¬æ˜ |
|-----|------|
| **QRæ¤œå“** | QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦è£½å“ã®åŒæ¢±ç‰©ã‚’ç¢ºèªã™ã‚‹æ¤œå“æ–¹å¼ |
| **å¼•å½“åœ¨åº«** | å‡ºè·äºˆå®šã¨ã—ã¦ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹åœ¨åº« |
| **åˆ©ç”¨å¯èƒ½åœ¨åº«** | ç¾åœ¨åº«ã‹ã‚‰å¼•å½“åœ¨åº«ã‚’å¼•ã„ãŸå®Ÿéš›ã«ä½¿ç”¨å¯èƒ½ãªåœ¨åº« |
| **å‡ºè·å ´æ‰€** | è£½å“ã‚’å‡ºè·ã™ã‚‹å€‰åº«ã‚„æ‹ ç‚¹ |
| **ç´å…¥å ´æ‰€** | è£½å“ã‚’é…é€ã™ã‚‹é¡§å®¢ã®å–¶æ¥­æ‰€ã‚„å€‰åº« |
| **Single-AZ** | å˜ä¸€ã®ã‚¢ãƒ™ã‚¤ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚¾ãƒ¼ãƒ³ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’é…ç½®ã™ã‚‹æ§‹æˆ |

### B. å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|-----------|------|----------|
| 1.0.0 | 2024-08 | åˆç‰ˆãƒªãƒªãƒ¼ã‚¹ - åŸºæœ¬æ©Ÿèƒ½ |
| 1.1.0 | 2024-09 | QRæ¤œå“ã‚·ã‚¹ãƒ†ãƒ è¿½åŠ  |
| 1.2.0 | 2025-10 | AWSå¯¾å¿œã€Terraformæ§‹æˆè¿½åŠ  |

### C. å‚è€ƒè³‡æ–™

- [Docker Documentation](https://docs.docker.com/)
- [PostgreSQL 15 Documentation](https://www.postgresql.org/docs/15/)
- [Express.js Guide](https://expressjs.com/)
- [Terraform AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [AWS Well-Architected Framework](https://aws.amazon.com/architecture/well-architected/)

---

**æ–‡æ›¸ç®¡ç†æƒ…å ±**

- **ä½œæˆè€…**: Claude Code
- **æ‰¿èªè€…**: -
- **é…å¸ƒå…ˆ**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼
- **æ©Ÿå¯†åŒºåˆ†**: ç¤¾å¤–ç§˜
- **æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼**: 2025-11

---

**æœ¬æ›¸ã«é–¢ã™ã‚‹ãŠå•ã„åˆã‚ã›**

æŠ€è¡“çš„ãªè³ªå•ã‚„ä¸æ˜ç‚¹ã«ã¤ã„ã¦ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®Issueã§ç®¡ç†ã—ã¦ãã ã•ã„ã€‚
