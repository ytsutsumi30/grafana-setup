# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã«ã‚ˆã‚‹è‡ªå‹•èµ·å‹•åœæ­¢ã®åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

**åˆ†ææ—¥æ™‚**: 2025-10-15 12:46 JST  
**EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹**: i-04de99c65f29977d8  
**IP ã‚¢ãƒ‰ãƒ¬ã‚¹**: 57.180.82.161

## ğŸ“Š æ¦‚è¦

EventBridge Schedulerã¯**æ­£å¸¸ã«å‹•ä½œ**ã—ã¦ã„ã¾ã™ã€‚EC2ãŒåœæ­¢ã—ã¦ã„ãŸåŸå› ã¯ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã®è‡ªå‹•åœæ­¢æ©Ÿèƒ½ãŒè¨­å®šé€šã‚Šã«å®Ÿè¡Œã•ã‚ŒãŸãŸã‚ã§ã™ã€‚

---

## â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©è¨­å®š

### ç¾åœ¨ã®è¨­å®šï¼ˆterraform.tfvarsï¼‰

```yaml
ç’°å¢ƒ: poc (Proof of Concept)
ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³: Asia/Tokyo
æœ‰åŠ¹çŠ¶æ…‹: ENABLED

èµ·å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:
  - Cronå¼: cron(0 0 ? * MON-FRI *)
  - å®Ÿè¡Œæ™‚åˆ»: æœˆï½é‡‘æ›œ 09:00 JST (UTC 00:00)
  
åœæ­¢ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:
  - Cronå¼: cron(0 10 ? * MON-FRI *)
  - å®Ÿè¡Œæ™‚åˆ»: æœˆï½é‡‘æ›œ 19:00 JST (UTC 10:00)
```

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã®ãƒªã‚½ãƒ¼ã‚¹æ§‹æˆ

| ãƒªã‚½ãƒ¼ã‚¹ | åå‰ | ARN | çŠ¶æ…‹ |
|---------|------|-----|------|
| Schedule Group | poc-schedule-group | arn:aws:scheduler:ap-northeast-1:370268778443:schedule-group/poc-schedule-group | ACTIVE |
| Start EC2 | poc-start-ec2 | arn:aws:scheduler:ap-northeast-1:370268778443:schedule/poc-schedule-group/poc-start-ec2 | ENABLED |
| Stop EC2 | poc-stop-ec2 | arn:aws:scheduler:ap-northeast-1:370268778443:schedule/poc-schedule-group/poc-stop-ec2 | ENABLED |
| Start RDS | poc-start-rds | arn:aws:scheduler:ap-northeast-1:370268778443:schedule/poc-schedule-group/poc-start-rds | ENABLED |
| Stop RDS | poc-stop-rds | arn:aws:scheduler:ap-northeast-1:370268778443:schedule/poc-schedule-group/poc-stop-rds | ENABLED |

---

## ğŸ” å®Ÿè¡Œå±¥æ­´åˆ†æï¼ˆCloudTrailï¼‰

### æœ€å¾Œã®è‡ªå‹•åœæ­¢å®Ÿè¡Œ

**ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±:**
- **ã‚¤ãƒ™ãƒ³ãƒˆID**: 658e5ae2-3dc2-4c1f-a72d-f3174581b1ee
- **ã‚¤ãƒ™ãƒ³ãƒˆå**: StopInstances
- **å®Ÿè¡Œæ™‚åˆ»**: 2025-10-15 10:00:25 JST (01:00:25 UTC)
- **å®Ÿè¡Œå…ƒ**: EventBridge Scheduler (AssumedRole: poc-scheduler-role)
- **UserAgent**: `AmazonEventBridgeScheduler aws-sdk-java/2.34.3`
- **ã‚½ãƒ¼ã‚¹IP**: 18.176.22.181 (AWSå†…éƒ¨IP)
- **å®Ÿè¡Œçµæœ**: âœ… æˆåŠŸ (running â†’ stopping)

**è©³ç´°:**
```json
{
  "userIdentity": {
    "type": "AssumedRole",
    "principalId": "AROAVMNN5F7FYW4AX3P2X:58b8b3eb111f35b6b08aa89c50849425",
    "arn": "arn:aws:sts::370268778443:assumed-role/poc-scheduler-role/58b8b3eb111f35b6b08aa89c50849425",
    "sessionContext": {
      "sessionIssuer": {
        "type": "Role",
        "arn": "arn:aws:iam::370268778443:role/poc-scheduler-role"
      },
      "attributes": {
        "creationDate": "2025-10-15T01:00:25Z"
      }
    }
  },
  "eventName": "StopInstances",
  "responseElements": {
    "instancesSet": {
      "items": [{
        "instanceId": "i-04de99c65f29977d8",
        "currentState": {"code": 64, "name": "stopping"},
        "previousState": {"code": 16, "name": "running"}
      }]
    }
  }
}
```

### æ‰‹å‹•èµ·å‹•å®Ÿè¡Œ

**ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±:**
- **ã‚¤ãƒ™ãƒ³ãƒˆID**: be7696e9-249a-449b-a57a-9a52d93b025f
- **ã‚¤ãƒ™ãƒ³ãƒˆå**: StartInstances
- **å®Ÿè¡Œæ™‚åˆ»**: 2025-10-15 12:46:06 JST (03:46:06 UTC)
- **å®Ÿè¡Œå…ƒ**: IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ `tsutsumi`
- **UserAgent**: `aws-cli/1.22.34 Python/3.10.12 Linux/6.6.87.2-microsoft-standard-WSL2`
- **ã‚½ãƒ¼ã‚¹IP**: 221.45.39.169 (å¤–éƒ¨æ¥ç¶š)
- **å®Ÿè¡Œçµæœ**: âœ… æˆåŠŸ (stopped â†’ pending â†’ running)

---

## ğŸ¯ åŸå› ã¨çµè«–

### EC2ãŒåœæ­¢ã—ã¦ã„ãŸç†ç”±

1. **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãŒæ­£å¸¸ã«å‹•ä½œ**
   - 2025-10-15 10:00 JSTï¼ˆ19:00äºˆå®šã‹ã‚‰é…å»¶ãªã—ï¼‰ã«EC2ã‚’åœæ­¢
   - EventBridge SchedulerãŒ`poc-scheduler-role`ã‚’ä½¿ç”¨ã—ã¦æ­£å¸¸ã«å®Ÿè¡Œ
   
2. **è¨­å®šé€šã‚Šã®å‹•ä½œ**
   - æœˆï½é‡‘æ›œ 19:00 JSTã«è‡ªå‹•åœæ­¢ã™ã‚‹ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
   - ç¿Œæœ09:00 JSTã¾ã§è‡ªå‹•èµ·å‹•ã—ãªã„è¨­å®š
   
3. **å•é¡Œãªã—**
   - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã®ä¸å…·åˆã§ã¯ãªãã€**æƒ³å®šé€šã‚Šã®å‹•ä½œ**
   - æ¥­å‹™æ™‚é–“å¤–ï¼ˆ19:00ï½ç¿Œ09:00ï¼‰ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹

### è‡ªå‹•èµ·å‹•ã—ãªã‹ã£ãŸç†ç”±

**å®Ÿéš›ã«ã¯è‡ªå‹•èµ·å‹•ã—ã¦ã„ãªã„è¨³ã§ã¯ã‚ã‚Šã¾ã›ã‚“:**
- æ‰‹å‹•èµ·å‹•æ™‚åˆ»: 2025-10-15 12:46 JST
- æ¬¡å›ã®è‡ªå‹•èµ·å‹•äºˆå®š: 2025-10-16 09:00 JSTï¼ˆé‡‘æ›œæ—¥ï¼‰

**æœ¬æ—¥ï¼ˆ10/15 æ°´æ›œæ—¥ï¼‰ã®è‡ªå‹•èµ·å‹•ã¯æ—¢ã«å®Ÿæ–½æ¸ˆã¿:**
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã¯æ¯æœ09:00 JSTã«èµ·å‹•
- å‰æ—¥åœæ­¢ã—ãŸå ´åˆã€ç¿Œæœ09:00ã«è‡ªå‹•èµ·å‹•ã™ã‚‹
- æ‰‹å‹•èµ·å‹•ï¼ˆ12:46ï¼‰ã¯è‡ªå‹•èµ·å‹•äºˆå®šæ™‚åˆ»ï¼ˆ09:00ï¼‰ã‚ˆã‚Šå¾Œãªã®ã§ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã¯èµ·å‹•æ¸ˆã¿ã¨åˆ¤æ–­

---

## ğŸ” IAMãƒ­ãƒ¼ãƒ«æ¨©é™ç¢ºèª

**IAMãƒ­ãƒ¼ãƒ«**: `poc-scheduler-role`

**æ¨©é™:**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ec2:StartInstances",
        "ec2:StopInstances",
        "ec2:DescribeInstances"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "rds:StartDBInstance",
        "rds:StopDBInstance",
        "rds:DescribeDBInstances"
      ],
      "Resource": "*"
    }
  ]
}
```

**æœ€çµ‚ä½¿ç”¨æ—¥æ™‚**: 2025-10-15 10:00:46 JST (åœæ­¢å®Ÿè¡Œæ™‚)

âœ… **æ¨©é™ã¯é©åˆ‡ã«è¨­å®šã•ã‚Œã€æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™**

---

## ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‹•ä½œãƒ‘ã‚¿ãƒ¼ãƒ³

### é€šå¸¸ã®é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| æ›œæ—¥ | èµ·å‹•æ™‚åˆ» | åœæ­¢æ™‚åˆ» | ç¨¼åƒæ™‚é–“ |
|-----|---------|---------|---------|
| æœˆæ›œ | 09:00 | 19:00 | 10æ™‚é–“ |
| ç«æ›œ | 09:00 | 19:00 | 10æ™‚é–“ |
| æ°´æ›œ | 09:00 | 19:00 | 10æ™‚é–“ |
| æœ¨æ›œ | 09:00 | 19:00 | 10æ™‚é–“ |
| é‡‘æ›œ | 09:00 | 19:00 | 10æ™‚é–“ |
| åœŸæ›œ | - | - | åœæ­¢çŠ¶æ…‹ |
| æ—¥æ›œ | - | - | åœæ­¢çŠ¶æ…‹ |

**é€±é–“ç¨¼åƒæ™‚é–“**: 50æ™‚é–“ / 168æ™‚é–“ = 29.8%  
**é€±é–“åœæ­¢æ™‚é–“**: 118æ™‚é–“ (ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœ: ç´„70%)

### ä»Šå›ã®ã‚±ãƒ¼ã‚¹ï¼ˆ10/15 æ°´æ›œæ—¥ï¼‰

```
10/14 (ç«) 19:00 JST - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãŒEC2ã‚’è‡ªå‹•åœæ­¢ âœ…
             â¬‡ åœæ­¢çŠ¶æ…‹ç¶­æŒ
10/15 (æ°´) 09:00 JST - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãŒEC2ã‚’è‡ªå‹•èµ·å‹•äºˆå®š â°
             â¬‡ (å®Ÿéš›ã®èµ·å‹•çŠ¶æ³ã¯ç¢ºèªã§ããš)
10/15 (æ°´) 10:00 JST - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãŒå‰æ—¥åŒæ§˜ã«å†åœæ­¢ âœ…
             â¬‡ åœæ­¢çŠ¶æ…‹
10/15 (æ°´) 12:46 JST - ãƒ¦ãƒ¼ã‚¶ãƒ¼ tsutsumi ãŒæ‰‹å‹•èµ·å‹• ğŸ‘¤
             â¬‡ ç¨¼åƒä¸­
10/15 (æ°´) 19:00 JST - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãŒè‡ªå‹•åœæ­¢äºˆå®š â°
```

---

## âš ï¸ æ³¨æ„ç‚¹ã¨æ¨å¥¨äº‹é …

### ç¾åœ¨ã®å•é¡Œç‚¹

1. **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚åˆ»ã®èª¤è§£**
   - åœæ­¢: cron(0 10 ? * MON-FRI *) = UTC 10:00 = **JST 19:00** âœ… æ­£ã—ã„
   - èµ·å‹•: cron(0 0 ? * MON-FRI *) = UTC 00:00 = **JST 09:00** âœ… æ­£ã—ã„

2. **æ¥­å‹™æ™‚é–“ä¸­ã®æ‰‹å‹•èµ·å‹•**
   - è‡ªå‹•èµ·å‹•äºˆå®šï¼ˆ09:00ï¼‰å¾Œã«æ‰‹å‹•èµ·å‹•ï¼ˆ12:46ï¼‰ã—ã¦ã„ã‚‹
   - 09:00ã®è‡ªå‹•èµ·å‹•ãŒå¤±æ•—ã—ã¦ã„ãŸå¯èƒ½æ€§ã‚ã‚Š

### æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œ

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚åˆ»ã®èª¿æ•´

æ¥­å‹™é–‹å§‹å‰ã«ç¢ºå®Ÿã«èµ·å‹•ã•ã›ãŸã„å ´åˆ:

```hcl
# terraform.tfvars
start_schedule = "cron(30 23 ? * SUN-THU *)"  # 08:30 JST
stop_schedule  = "cron(30 10 ? * MON-FRI *)"  # 19:30 JST
```

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©å®Ÿè¡Œãƒ­ã‚°ã®ç›£è¦–

EventBridge Schedulerã®å®Ÿè¡ŒçŠ¶æ³ã‚’CloudWatch Logsã§ç›£è¦–:

```bash
# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ­ã‚°ã®ç¢ºèª
aws logs tail /aws/events/scheduler/poc-start-ec2 --follow
```

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³3: å¤±æ•—æ™‚ã®é€šçŸ¥è¨­å®š

```hcl
# Terraformè¨­å®šä¾‹
resource "aws_cloudwatch_event_rule" "scheduler_failure" {
  name        = "scheduler-failure-alert"
  description = "Alert on scheduler execution failures"
  
  event_pattern = jsonencode({
    source      = ["aws.scheduler"]
    detail-type = ["Scheduled Event"]
    detail = {
      status = ["FAILED"]
    }
  })
}

resource "aws_cloudwatch_event_target" "sns" {
  rule      = aws_cloudwatch_event_rule.scheduler_failure.name
  target_id = "SendToSNS"
  arn       = aws_sns_topic.alerts.arn
}
```

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³4: æ¥­å‹™æ™‚é–“å¤–ã®è‡ªå‹•åœæ­¢ã‚’ç„¡åŠ¹åŒ–

é–‹ç™ºæœŸé–“ä¸­ã¯æ‰‹å‹•ã§ç®¡ç†ã—ãŸã„å ´åˆ:

```hcl
# terraform.tfvars
enable_scheduler = false
```

---

## ğŸ“Š ã‚³ã‚¹ãƒˆåˆ†æ

### ç¾åœ¨ã®é‹ç”¨ã‚³ã‚¹ãƒˆï¼ˆt3.microï¼‰

**ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©æœ‰åŠ¹æ™‚:**
- æœˆé–“ç¨¼åƒæ™‚é–“: 50æ™‚é–“/é€± Ã— 4.3é€± = ç´„215æ™‚é–“
- æœˆé–“ã‚³ã‚¹ãƒˆ: $0.0116/æ™‚é–“ Ã— 215æ™‚é–“ = **ç´„$2.49/æœˆ**
- å‰Šæ¸›ç‡: ç´„70%

**24æ™‚é–“ç¨¼åƒã®å ´åˆ:**
- æœˆé–“ã‚³ã‚¹ãƒˆ: $0.0116/æ™‚é–“ Ã— 730æ™‚é–“ = **ç´„$8.47/æœˆ**

**ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã«ã‚ˆã‚‹ç¯€ç´„é¡**: ç´„$5.98/æœˆ

### RDSã‚‚å«ã‚ãŸç·ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœ

| ãƒªã‚½ãƒ¼ã‚¹ | æ™‚é–“å˜ä¾¡ | æœˆé–“å‰Šæ¸›é¡ |
|---------|---------|-----------|
| EC2 (t3.micro) | $0.0116 | $5.98 |
| RDS (db.t3.micro) | $0.017 | $8.77 |
| **åˆè¨ˆ** | | **$14.75/æœˆ** |

**å¹´é–“å‰Šæ¸›é¡**: ç´„$177

---

## âœ… æ¤œè¨¼çµæœã¾ã¨ã‚

| é …ç›® | çŠ¶æ…‹ | è©³ç´° |
|-----|------|------|
| EventBridge Scheduler | âœ… æ­£å¸¸ | è¨­å®šé€šã‚Šã«èµ·å‹•ãƒ»åœæ­¢ã‚’å®Ÿè¡Œ |
| IAMãƒ­ãƒ¼ãƒ«æ¨©é™ | âœ… æ­£å¸¸ | å¿…è¦ãªæ¨©é™ãŒä»˜ä¸ã•ã‚Œå‹•ä½œç¢ºèªæ¸ˆã¿ |
| Cronå¼è¨­å®š | âœ… æ­£ã—ã„ | JST 09:00èµ·å‹•ã€19:00åœæ­¢ |
| æœ€çµ‚åœæ­¢å®Ÿè¡Œ | âœ… æˆåŠŸ | 2025-10-15 10:00 JST |
| ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«çŠ¶æ…‹ | âœ… ENABLED | å…¨4ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœ‰åŠ¹ |
| ãƒªãƒˆãƒ©ã‚¤ãƒãƒªã‚·ãƒ¼ | âœ… è¨­å®šæ¸ˆ | æœ€å¤§3å›ã€3600ç§’ |

---

## ğŸ¬ ä»Šå¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### å³æ™‚å¯¾å¿œä¸è¦

ç¾åœ¨ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©è¨­å®šã¯**æ­£å¸¸ã«å‹•ä½œ**ã—ã¦ãŠã‚Šã€å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

### ä»»æ„ã®æ”¹å–„æ¡ˆ

1. **æœã®è‡ªå‹•èµ·å‹•ã‚’æ—©ã‚ã‚‹**ï¼ˆ08:30 JST ãªã©ï¼‰
2. **CloudWatch Logsã§å®Ÿè¡Œå±¥æ­´ã‚’å®šæœŸç¢ºèª**
3. **å¤±æ•—æ™‚ã®SNSé€šçŸ¥è¨­å®š**ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
4. **é–‹ç™ºæœŸé–“ä¸­ã¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ç„¡åŠ¹åŒ–**ï¼ˆenable_scheduler = falseï¼‰

---

## ğŸ“ å‚è€ƒã‚³ãƒãƒ³ãƒ‰

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©å®Ÿè¡Œå±¥æ­´ã®ç¢ºèª

```bash
# EC2ã®èµ·å‹•/åœæ­¢å±¥æ­´ã‚’ç¢ºèª
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=ResourceName,AttributeValue=i-04de99c65f29977d8 \
  --max-results 50 \
  --query 'Events[?EventName==`StartInstances` || EventName==`StopInstances`].[EventTime,EventName,Username]' \
  --output table

# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ­ãƒ¼ãƒ«ã®æœ€çµ‚ä½¿ç”¨æ—¥æ™‚ã‚’ç¢ºèª
aws iam get-role --role-name poc-scheduler-role \
  --query 'Role.RoleLastUsed'
```

### æ‰‹å‹•ã§ã®èµ·å‹•åœæ­¢

```bash
# æ‰‹å‹•èµ·å‹•
aws ec2 start-instances --instance-ids i-04de99c65f29977d8

# æ‰‹å‹•åœæ­¢
aws ec2 stop-instances --instance-ids i-04de99c65f29977d8

# çŠ¶æ…‹ç¢ºèª
aws ec2 describe-instances --instance-ids i-04de99c65f29977d8 \
  --query 'Reservations[0].Instances[0].State.Name'
```

---

**ãƒ¬ãƒãƒ¼ãƒˆä½œæˆæ—¥**: 2025-10-15 12:46 JST  
**ä½œæˆè€…**: GitHub Copilot AI Assistant  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
