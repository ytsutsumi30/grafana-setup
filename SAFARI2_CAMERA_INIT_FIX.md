# Safari2.html ã‚«ãƒ¡ãƒ©åˆå›èµ·å‹•å•é¡Œã®ä¿®æ­£

## ğŸ“… å®Ÿæ–½æ—¥æ™‚
2025å¹´10æœˆ17æ—¥

## âŒ å ±å‘Šã•ã‚ŒãŸå•é¡Œ

### ç¾è±¡
```
safari2.htmlã§æœ€åˆã®ã‚«ãƒ¡ãƒ©èµ·å‹•ã§ã¯QRèª­ã¿å–ã‚Šã§ããªã„ãŒã€
ä¸€å›ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾Œã«å†åº¦ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã™ã‚‹ã¨QRSCANã«æˆåŠŸã™ã‚‹
```

### å†ç¾æ‰‹é †
1. safari2.htmlã‚’é–‹ã
2. ã€Œã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã€ã‚’ã‚¿ãƒƒãƒ—
3. ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã™ã‚‹ãŒQRã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚Œãªã„
4. ã€Œåœæ­¢ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«
5. å†åº¦ã€Œã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã€ã‚’ã‚¿ãƒƒãƒ—
6. âœ… QRã‚³ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«èª­ã¿å–ã‚Œã‚‹

## ğŸ” åŸå› åˆ†æ

### æŠ€è¡“çš„ãªåŸå› 

1. **`waitForVideoReady()`ã®ä¸å®Œå…¨ãªãƒã‚§ãƒƒã‚¯**
   ```javascript
   // å•é¡Œã®ã‚ã£ãŸã‚³ãƒ¼ãƒ‰
   if (this.video.readyState >= 3) {  // â† ã“ã“ã ã‘ã§ã¯ä¸ååˆ†
       // ...
   }
   ```
   - `readyState >= 3` ã ã‘ã§ã¯ã€videoWidth/HeightãŒ0ã®å ´åˆãŒã‚ã‚‹
   - æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ãŒæç”»ã•ã‚Œã‚‹å‰ã«QRæ¤œå‡ºã‚’é–‹å§‹ã—ã¦ã„ãŸ

2. **ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“ã®ä¸è¶³**
   - åˆå›èµ·å‹•æ™‚ã¯2ç§’ã§ã¯ä¸ååˆ†
   - ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã®åˆæœŸåŒ–ã«æ™‚é–“ãŒã‹ã‹ã‚‹
   - 2å›ç›®ä»¥é™ã¯æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®ãŸã‚é«˜é€Ÿ

3. **ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã®çŠ¶æ…‹ç¢ºèªãŒä¸å®Œå…¨**
   - `readyState`ã®ã¿ç¢ºèª
   - `videoWidth/videoHeight`ã®ç¢ºèªæ¼ã‚Œ
   - `paused`çŠ¶æ…‹ã®ç¢ºèªæ¼ã‚Œ

### ãªãœ2å›ç›®ã¯æˆåŠŸã™ã‚‹ã®ã‹ï¼Ÿ

- 1å›ç›®: ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã®åˆæœŸåŒ– â†’ æ™‚é–“ãŒã‹ã‹ã‚‹
- 2å›ç›®: ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒæ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ â†’ ã™ãã«åˆ©ç”¨å¯èƒ½
- ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹

## âœ… å®Ÿæ–½ã—ãŸä¿®æ­£

### 1. `waitForFirstFrame()` ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿½åŠ 

æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ãŒç¢ºå®Ÿã«æç”»ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹æ–°ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ :

```javascript
// æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ãŒæç”»ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿï¼ˆSafariæœ€é©åŒ–ï¼‰
async waitForFirstFrame() {
    return new Promise((resolve) => {
        let attempts = 0;
        const maxAttempts = 30; // 3ç§’é–“è©¦è¡Œ

        const checkFrame = () => {
            attempts++;
            
            // videoWidth/HeightãŒæœ‰åŠ¹ã§ã€readyStateãŒ4ï¼ˆå®Œå…¨æº–å‚™å®Œäº†ï¼‰
            if (this.video.readyState === 4 && 
                this.video.videoWidth > 0 && 
                this.video.videoHeight > 0) {
                console.log(`[Video] First frame ready after ${attempts * 100}ms`);
                this.updateDebug('resolution', `${this.video.videoWidth}x${this.video.videoHeight}`);
                resolve();
            } else if (attempts >= maxAttempts) {
                console.warn('[Video] First frame timeout, proceeding anyway');
                resolve(); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚ç¶šè¡Œ
            } else {
                setTimeout(checkFrame, 100);
            }
        };

        setTimeout(checkFrame, 100);
    });
}
```

**æ”¹å–„ç‚¹:**
- 100msã”ã¨ã«videoWidth/videoHeightã‚’ç¢ºèª
- readyState=4ï¼ˆå®Œå…¨æº–å‚™ï¼‰ã‚’å¾…æ©Ÿ
- æœ€å¤§3ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã§å¾…æ©Ÿæ™‚é–“ã‚’è¨˜éŒ²

### 2. `waitForVideoReady()` ã®å¼·åŒ–

videoWidth/videoHeightã®ç¢ºèªã‚’è¿½åŠ :

```javascript
// ä¿®æ­£å‰
if (this.video.readyState >= 3) {
    // ...
}

// ä¿®æ­£å¾Œ
if (this.video.readyState >= 3 && 
    this.video.videoWidth > 0 && 
    this.video.videoHeight > 0) {
    clearTimeout(timeout);
    
    this.video.play()
        .then(() => {
            // æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ãŒç¢ºå®Ÿã«æç”»ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
            this.waitForFirstFrame().then(resolve).catch(reject);
        })
        .catch(reject);
}
```

**æ”¹å–„ç‚¹:**
- videoWidth/videoHeight > 0 ã‚’ç¢ºèª
- `waitForFirstFrame()`ã‚’å‘¼ã³å‡ºã—
- ç¢ºå®Ÿãªãƒ•ãƒ¬ãƒ¼ãƒ æç”»ã‚’ä¿è¨¼

### 3. `calibrateCamera()` ã®æ”¹å–„

åˆå›èµ·å‹•æ™‚ã®å¾…æ©Ÿæ™‚é–“ã‚’å»¶é•·:

```javascript
// åˆå›ã¯3ç§’ã€2å›ç›®ä»¥é™ã¯2ç§’
const calibrationDelay = this.calibrationAttempts === 1 ? 3000 : 2000;
await new Promise(resolve => setTimeout(resolve, calibrationDelay));

// ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒå®Œå…¨ã«å®‰å®šã—ã¦ã„ã‚‹ã‹ç¢ºèª
const isFullyReady = this.video.readyState === 4 && 
                    this.video.videoWidth > 0 && 
                    this.video.videoHeight > 0 &&
                    !this.video.paused;

if (isFullyReady) {
    console.log(`[Calibration] Success on attempt ${this.calibrationAttempts}`);
    this.startQRDetection();
} else {
    // å†ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    console.warn(`[Calibration] Not ready (readyState: ${this.video.readyState}, size: ${this.video.videoWidth}x${this.video.videoHeight}, paused: ${this.video.paused})`);
    if (this.calibrationAttempts < this.maxCalibrationAttempts) {
        setTimeout(() => this.calibrateCamera(), 1000);
    }
}
```

**æ”¹å–„ç‚¹:**
- åˆå›ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: 3ç§’å¾…æ©Ÿ
- 2å›ç›®ä»¥é™: 2ç§’å¾…æ©Ÿï¼ˆé«˜é€ŸåŒ–ï¼‰
- `paused`çŠ¶æ…‹ã‚‚ç¢ºèª
- è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›

## ğŸ“Š ä¿®æ­£å‰å¾Œã®æ¯”è¼ƒ

| é …ç›® | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ |
|-----|--------|--------|
| **åˆå›èµ·å‹•** | âŒ QRèª­ã¿å–ã‚Šå¤±æ•— | âœ… QRèª­ã¿å–ã‚ŠæˆåŠŸ |
| **2å›ç›®ä»¥é™** | âœ… QRèª­ã¿å–ã‚ŠæˆåŠŸ | âœ… QRèª­ã¿å–ã‚ŠæˆåŠŸ |
| **å¾…æ©Ÿæ™‚é–“** | 2ç§’å›ºå®š | åˆå›3ç§’ã€2å›ç›®ä»¥é™2ç§’ |
| **ãƒ•ãƒ¬ãƒ¼ãƒ ç¢ºèª** | âŒ ãªã— | âœ… ã‚ã‚Šï¼ˆwaitForFirstFrameï¼‰ |
| **ã‚µã‚¤ã‚ºç¢ºèª** | âŒ ãªã— | âœ… videoWidth/Heightç¢ºèª |
| **è©³ç´°ãƒ­ã‚°** | å°‘ãªã„ | è±Šå¯Œï¼ˆãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®¹æ˜“ï¼‰ |

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### iPad/iPhoneã§ã®ãƒ†ã‚¹ãƒˆæ‰‹é †

1. **safari2.htmlã«ã‚¢ã‚¯ã‚»ã‚¹**
   ```
   https://57.180.82.161/web/safari2.html
   ```

2. **åˆå›èµ·å‹•ãƒ†ã‚¹ãƒˆ**
   - ã€Œã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã€ã‚’ã‚¿ãƒƒãƒ—
   - ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¨±å¯
   - ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®è¡¨ç¤ºã‚’ç¢ºèªï¼ˆ3ç§’ï¼‰
   - âœ… QRã‚³ãƒ¼ãƒ‰ã‚’ç”»é¢ã«è¡¨ç¤º
   - âœ… QRã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚‰ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

3. **ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®ç¢ºèª**
   - ã€ŒğŸ› Debugã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
   - ä»¥ä¸‹ã®æƒ…å ±ã‚’ç¢ºèª:
     - `ReadyState: 4`
     - `Resolution: 1920x1080`ï¼ˆå®Ÿéš›ã®è§£åƒåº¦ï¼‰
     - `Detection: QrScanner active`
     - `Method: QrScanner`

4. **å†ã‚¹ã‚­ãƒ£ãƒ³ãƒ†ã‚¹ãƒˆ**
   - ã€Œâ¹ï¸ åœæ­¢ã€ã‚’ã‚¿ãƒƒãƒ—
   - å†åº¦ã€Œã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã€ã‚’ã‚¿ãƒƒãƒ—
   - ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®è¡¨ç¤ºã‚’ç¢ºèªï¼ˆ2ç§’ - é«˜é€ŸåŒ–ï¼‰
   - âœ… QRã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚‰ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ

- âœ… åˆå›èµ·å‹•ã§QRã‚³ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«èª­ã¿å–ã‚Œã‚‹
- âœ… ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã™ãã«ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
- âœ… ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã«æ­£ã—ã„è§£åƒåº¦ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã«ã€ŒFirst frame ready after XXXmsã€ã¨è¡¨ç¤º

## ğŸ”§ æŠ€è¡“è©³ç´°

### ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒãƒ£ãƒ¼ãƒˆ

```
ä¿®æ­£å‰ï¼ˆå•é¡Œã‚ã‚Šï¼‰:
â”œâ”€ getUserMedia()
â”œâ”€ readyState: 3 (HAVE_FUTURE_DATA)
â”œâ”€ play()
â”œâ”€ 1ç§’å¾…æ©Ÿ
â”œâ”€ ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆ2ç§’ï¼‰
â””â”€ QRæ¤œå‡ºé–‹å§‹ âŒ (videoWidth=0ã®å¯èƒ½æ€§)

ä¿®æ­£å¾Œï¼ˆå•é¡Œè§£æ±ºï¼‰:
â”œâ”€ getUserMedia()
â”œâ”€ readyState: 3 + videoWidth>0 ç¢ºèª
â”œâ”€ play()
â”œâ”€ waitForFirstFrame() (æœ€å¤§3ç§’)
â”‚   â””â”€ readyState: 4 + videoWidth>0 ç¢ºèª
â”œâ”€ ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆåˆå›3ç§’ï¼‰
â”‚   â””â”€ readyState=4 + size>0 + !paused ç¢ºèª
â””â”€ QRæ¤œå‡ºé–‹å§‹ âœ… (å®Œå…¨æº–å‚™å®Œäº†)
```

### ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã®readyState

| readyState | å®šæ•°å | èª¬æ˜ |
|-----------|--------|------|
| 0 | HAVE_NOTHING | ãƒ‡ãƒ¼ã‚¿ãªã— |
| 1 | HAVE_METADATA | ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ |
| 2 | HAVE_CURRENT_DATA | ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã®ã¿ |
| 3 | HAVE_FUTURE_DATA | ç¾åœ¨+å°†æ¥ã®ãƒ•ãƒ¬ãƒ¼ãƒ  |
| **4** | **HAVE_ENOUGH_DATA** | **ååˆ†ãªãƒ‡ãƒ¼ã‚¿ï¼ˆå®Œå…¨æº–å‚™ï¼‰** |

ä¿®æ­£å¾Œã¯ **readyState=4** ã‚’å¾…æ©Ÿã™ã‚‹ãŸã‚ç¢ºå®Ÿã§ã™ã€‚

## ğŸ“ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `web/safari2.html`: QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ï¼ˆSafariæœ€é©åŒ–ç‰ˆï¼‰
- ã‚³ãƒŸãƒƒãƒˆ: `4cf62a3`

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] waitForFirstFrame()ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿½åŠ 
- [x] waitForVideoReady()ã®å¼·åŒ–
- [x] calibrateCamera()ã®æ”¹å–„
- [x] åˆå›èµ·å‹•æ™‚ã®å¾…æ©Ÿæ™‚é–“å»¶é•·ï¼ˆ3ç§’ï¼‰
- [x] videoWidth/videoHeightã®ç¢ºèªè¿½åŠ 
- [x] pausedã®ç¢ºèªè¿½åŠ 
- [x] è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›ã®è¿½åŠ 
- [x] EC2ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
- [x] Gitã‚³ãƒŸãƒƒãƒˆå®Œäº†

## ğŸ¯ ä»Šå¾Œã®æ¨å¥¨å¯¾å¿œ

### ã•ã‚‰ãªã‚‹æ”¹å–„æ¡ˆ

1. **ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æœ€é©åŒ–**
   - ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’äº‹å‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
   - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§åˆæœŸåŒ–ã‚’é–‹å§‹

2. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨**
   - å‰å›ä½¿ç”¨ã—ãŸã‚«ãƒ¡ãƒ©IDã‚’ä¿å­˜
   - æ¬¡å›èµ·å‹•æ™‚ã«åŒã˜ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆä½¿ç”¨

3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**
   - åˆå›èµ·å‹•æ™‚ã«ã€ŒåˆæœŸåŒ–ä¸­...ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
   - é€²æ—çŠ¶æ³ã‚’ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã§è¡¨ç¤º

## ğŸ‰ ã¾ã¨ã‚

**å•é¡Œ**: åˆå›ã‚«ãƒ¡ãƒ©èµ·å‹•ã§QRèª­ã¿å–ã‚Šå¤±æ•—

**åŸå› **: 
1. videoWidth/videoHeightã®ç¢ºèªä¸è¶³
2. æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ æç”»ã‚’å¾…ãŸãªã„
3. ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“ã®ä¸è¶³

**è§£æ±º**:
1. waitForFirstFrame()ã§ç¢ºå®Ÿãªãƒ•ãƒ¬ãƒ¼ãƒ æç”»ã‚’å¾…æ©Ÿ
2. videoWidth/videoHeight > 0 ã‚’ç¢ºèª
3. åˆå›ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“ã‚’3ç§’ã«å»¶é•·
4. è©³ç´°ãªãƒ­ã‚°ã§å•é¡Œè¿½è·¡ã‚’å®¹æ˜“ã«

**çµæœ**: âœ… åˆå›èµ·å‹•ã‹ã‚‰QRã‚³ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«èª­ã¿å–ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼

safari2.htmlã¯å®Œå…¨ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ãŒå¤§å¹…ã«æ”¹å–„ã•ã‚Œã¾ã—ãŸğŸ‰
