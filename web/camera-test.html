<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¡ãƒ©APIè¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background: #f5f5f5;
        }
        .result-box {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-ok {
            color: #28a745;
        }
        .status-error {
            color: #dc3545;
        }
        .status-warning {
            color: #ffc107;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .test-video {
            width: 100%;
            max-width: 640px;
            background: #000;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">ğŸ“± ã‚«ãƒ¡ãƒ©APIè¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="result-box">
            <h3>ğŸ” ç’°å¢ƒæƒ…å ±</h3>
            <table class="table table-sm">
                <tr>
                    <th width="200">ãƒ—ãƒ­ãƒˆã‚³ãƒ«</th>
                    <td id="protocol"></td>
                </tr>
                <tr>
                    <th>ãƒ›ã‚¹ãƒˆå</th>
                    <td id="hostname"></td>
                </tr>
                <tr>
                    <th>å®Œå…¨URL</th>
                    <td id="fullurl"></td>
                </tr>
                <tr>
                    <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</th>
                    <td id="useragent" style="font-size: 0.85em; word-break: break-all;"></td>
                </tr>
            </table>
        </div>

        <div class="result-box">
            <h3>ğŸ¥ ã‚«ãƒ¡ãƒ©APIå¯¾å¿œçŠ¶æ³</h3>
            <table class="table table-sm">
                <tr>
                    <th width="200">navigator</th>
                    <td id="has-navigator"></td>
                </tr>
                <tr>
                    <th>navigator.mediaDevices</th>
                    <td id="has-mediadevices"></td>
                </tr>
                <tr>
                    <th>getUserMedia</th>
                    <td id="has-getusermedia"></td>
                </tr>
                <tr>
                    <th>enumerateDevices</th>
                    <td id="has-enumerate"></td>
                </tr>
                <tr>
                    <th>ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ</th>
                    <td id="is-secure"></td>
                </tr>
            </table>
        </div>

        <div class="result-box">
            <h3>ğŸ“¹ ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§</h3>
            <div id="devices-list">
                <button class="btn btn-primary" id="btn-enumerate">ãƒ‡ãƒã‚¤ã‚¹ã‚’åˆ—æŒ™</button>
            </div>
        </div>

        <div class="result-box">
            <h3>ğŸš€ ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ</h3>
            <button class="btn btn-success mb-3" id="btn-test-camera">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãƒ†ã‚¹ãƒˆ</button>
            <button class="btn btn-danger mb-3 ms-2" id="btn-stop-camera" style="display:none;">ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢</button>
            <div id="camera-status" class="alert" style="display:none;"></div>
            <video id="test-video" class="test-video" playsinline webkit-playsinline muted autoplay style="display:none;"></video>
        </div>

        <div class="result-box">
            <h3>ğŸ’¡ æ¨å¥¨äº‹é …</h3>
            <div id="recommendations"></div>
        </div>

        <div class="result-box">
            <h3>ğŸ“‹ è¨ºæ–­çµæœï¼ˆJSONï¼‰</h3>
            <button class="btn btn-secondary btn-sm mb-2" id="btn-copy-json">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
            <pre id="json-output"></pre>
        </div>
    </div>

    <script>
        const diagnostics = {};

        // ç’°å¢ƒæƒ…å ±ã®åé›†
        function collectEnvironmentInfo() {
            diagnostics.environment = {
                protocol: window.location.protocol,
                hostname: window.location.hostname,
                port: window.location.port,
                fullUrl: window.location.href,
                userAgent: navigator.userAgent,
                isSecureContext: window.isSecureContext
            };

            document.getElementById('protocol').innerHTML = 
                `<strong class="${diagnostics.environment.protocol === 'https:' ? 'status-ok' : 'status-error'}">${diagnostics.environment.protocol}</strong>`;
            document.getElementById('hostname').textContent = diagnostics.environment.hostname;
            document.getElementById('fullurl').textContent = diagnostics.environment.fullUrl;
            document.getElementById('useragent').textContent = diagnostics.environment.userAgent;
        }

        // APIå¯¾å¿œçŠ¶æ³ã®ç¢ºèª
        function checkAPISupport() {
            diagnostics.apiSupport = {
                hasNavigator: !!navigator,
                hasMediaDevices: !!navigator.mediaDevices,
                hasGetUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                hasEnumerateDevices: !!(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices),
                isSecureContext: window.isSecureContext
            };

            const statusHtml = (supported) => supported 
                ? '<span class="status-ok">âœ… ã‚µãƒãƒ¼ãƒˆã‚ã‚Š</span>' 
                : '<span class="status-error">âŒ ã‚µãƒãƒ¼ãƒˆãªã—</span>';

            document.getElementById('has-navigator').innerHTML = statusHtml(diagnostics.apiSupport.hasNavigator);
            document.getElementById('has-mediadevices').innerHTML = statusHtml(diagnostics.apiSupport.hasMediaDevices);
            document.getElementById('has-getusermedia').innerHTML = statusHtml(diagnostics.apiSupport.hasGetUserMedia);
            document.getElementById('has-enumerate').innerHTML = statusHtml(diagnostics.apiSupport.hasEnumerateDevices);
            document.getElementById('is-secure').innerHTML = diagnostics.apiSupport.isSecureContext
                ? '<span class="status-ok">âœ… ã¯ã„ï¼ˆHTTPS or localhostï¼‰</span>'
                : '<span class="status-error">âŒ ã„ã„ãˆï¼ˆHTTPï¼‰</span>';
        }

        // ãƒ‡ãƒã‚¤ã‚¹åˆ—æŒ™
        async function enumerateDevices() {
            const container = document.getElementById('devices-list');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                container.innerHTML = '<div class="alert alert-danger">enumerateDevices APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                diagnostics.devices = devices.map(d => ({
                    kind: d.kind,
                    label: d.label,
                    deviceId: d.deviceId
                }));

                const videoInputs = devices.filter(d => d.kind === 'videoinput');
                
                if (videoInputs.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning">ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
                } else {
                    let html = `<div class="alert alert-success">ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹: ${videoInputs.length}å°</div>`;
                    html += '<ul class="list-group">';
                    videoInputs.forEach((device, index) => {
                        html += `<li class="list-group-item">
                            <strong>ã‚«ãƒ¡ãƒ© ${index + 1}:</strong> ${device.label || 'ï¼ˆãƒ©ãƒ™ãƒ«ãªã—ï¼‰'}<br>
                            <small class="text-muted">Device ID: ${device.deviceId}</small>
                        </li>`;
                    });
                    html += '</ul>';
                    container.innerHTML = html;
                }
            } catch (error) {
                diagnostics.deviceError = error.message;
                container.innerHTML = `<div class="alert alert-danger">ãƒ‡ãƒã‚¤ã‚¹åˆ—æŒ™ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ
        let currentStream = null;
        async function testCamera() {
            const video = document.getElementById('test-video');
            const statusDiv = document.getElementById('camera-status');
            const startBtn = document.getElementById('btn-test-camera');
            const stopBtn = document.getElementById('btn-stop-camera');

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusDiv.className = 'alert alert-danger';
                statusDiv.textContent = 'getUserMedia APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“';
                statusDiv.style.display = 'block';
                return;
            }

            try {
                startBtn.disabled = true;
                statusDiv.className = 'alert alert-info';
                statusDiv.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...';
                statusDiv.style.display = 'block';

                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                diagnostics.cameraTest = {
                    success: true,
                    tracks: currentStream.getVideoTracks().map(track => ({
                        label: track.label,
                        enabled: track.enabled,
                        muted: track.muted,
                        readyState: track.readyState,
                        settings: track.getSettings()
                    }))
                };

                video.srcObject = currentStream;
                video.style.display = 'block';
                
                statusDiv.className = 'alert alert-success';
                statusDiv.textContent = 'âœ… ã‚«ãƒ¡ãƒ©ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼';
                
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';

                updateJSON();
            } catch (error) {
                diagnostics.cameraTest = {
                    success: false,
                    error: error.message,
                    errorName: error.name
                };

                statusDiv.className = 'alert alert-danger';
                statusDiv.innerHTML = `<strong>ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:</strong><br>${error.name}: ${error.message}`;
                
                startBtn.disabled = false;
                updateJSON();
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            const video = document.getElementById('test-video');
            video.srcObject = null;
            video.style.display = 'none';
            
            const statusDiv = document.getElementById('camera-status');
            statusDiv.style.display = 'none';
            
            document.getElementById('btn-test-camera').style.display = 'inline-block';
            document.getElementById('btn-test-camera').disabled = false;
            document.getElementById('btn-stop-camera').style.display = 'none';
        }

        // æ¨å¥¨äº‹é …ã®è¡¨ç¤º
        function showRecommendations() {
            const container = document.getElementById('recommendations');
            const recommendations = [];

            if (diagnostics.environment.protocol !== 'https:' && 
                diagnostics.environment.hostname !== 'localhost' && 
                diagnostics.environment.hostname !== '127.0.0.1') {
                recommendations.push({
                    level: 'error',
                    icon: 'ğŸš«',
                    text: '<strong>HTTPSãŒå¿…è¦ã§ã™:</strong> ã‚«ãƒ¡ãƒ©APIã¯ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆHTTPS or localhostï¼‰ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚',
                    action: `<code>https://${diagnostics.environment.hostname}</code> ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã€<code>./setup-ssl.sh</code> ã‚’å®Ÿè¡Œã—ã¦SSLã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚`
                });
            }

            if (!diagnostics.apiSupport.hasGetUserMedia) {
                recommendations.push({
                    level: 'error',
                    icon: 'âŒ',
                    text: '<strong>getUserMedia APIãŒã‚ã‚Šã¾ã›ã‚“:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¤ã„ã‹ã€æ©Ÿèƒ½ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚',
                    action: 'ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æœ€æ–°ç‰ˆã«æ›´æ–°ã™ã‚‹ã‹ã€Safariè¨­å®šã§ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
                });
            }

            if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
                recommendations.push({
                    level: 'info',
                    icon: 'ğŸ“±',
                    text: '<strong>iOSãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œå‡º:</strong>',
                    action: 'è¨­å®š â†’ Safari â†’ ã‚«ãƒ¡ãƒ© ã§ã€Œè¨±å¯ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ â†’ ã‚«ãƒ¡ãƒ©ã§Safariã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚'
                });
            }

            if (diagnostics.apiSupport.hasGetUserMedia && diagnostics.environment.protocol === 'https:') {
                recommendations.push({
                    level: 'success',
                    icon: 'âœ…',
                    text: '<strong>ã™ã¹ã¦ã®æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™!</strong>',
                    action: 'QRã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ãŒä½¿ç”¨ã§ãã¾ã™ã€‚ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
                });
            }

            if (recommendations.length === 0) {
                container.innerHTML = '<div class="alert alert-info">ç‰¹ã«å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
            } else {
                let html = '';
                recommendations.forEach(rec => {
                    const alertClass = rec.level === 'error' ? 'alert-danger' : 
                                      rec.level === 'warning' ? 'alert-warning' : 
                                      rec.level === 'success' ? 'alert-success' : 'alert-info';
                    html += `
                        <div class="alert ${alertClass}">
                            <div class="mb-2">${rec.icon} ${rec.text}</div>
                            <div style="font-size: 0.9em;">${rec.action}</div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
        }

        // JSONã®æ›´æ–°
        function updateJSON() {
            document.getElementById('json-output').textContent = JSON.stringify(diagnostics, null, 2);
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyToClipboard() {
            const json = JSON.stringify(diagnostics, null, 2);
            navigator.clipboard.writeText(json).then(() => {
                alert('è¨ºæ–­çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            collectEnvironmentInfo();
            checkAPISupport();
            showRecommendations();
            updateJSON();

            document.getElementById('btn-enumerate').addEventListener('click', () => {
                enumerateDevices();
                updateJSON();
            });

            document.getElementById('btn-test-camera').addEventListener('click', testCamera);
            document.getElementById('btn-stop-camera').addEventListener('click', stopCamera);
            document.getElementById('btn-copy-json').addEventListener('click', copyToClipboard);
        });
    </script>
</body>
</html>
