<!DOCTYPE html>
<html>
   <head>
      <!-- Must set compatibility to IE9 or greater -->
      <meta http-equiv="X-UA-Compatible" content="IE=9" >
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <!-- include the mongoose UserControl.js library -->
      <!-- NOTE: MAKE SURE TO MAKE THE src PATH RELATIVE TO THIS FILE  -->
      <script type="text/javascript" src="../$app/scripts/UserControl.js"></script>
      <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
      
      <style>
         body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 12px;
            margin: 20px;
            background-color: #f5f5f5;
         }
         
         .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
         }
         
         .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
         }
         
         .qr-section {
            background: #e8f4fd;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
         }
         
         .qr-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
         }
         
         .qr-display {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            min-height: 100px;
            font-family: monospace;
            white-space: pre-wrap;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
         }
         
         table {
            width: 100%;
            border-collapse: collapse;
            background: white;
         }
         
         td {
            padding: 8px;
            border: 1px solid #ddd;
            vertical-align: top;
         }
         
         tr:first-child {
            background-color: #99CCFF;
            font-weight: bold;
         }
         
         tr:nth-child(even) {
            background-color: #eeeeee;
         }
         
         input[type="text"], input[type="button"] {
            padding: 6px;
            margin: 2px;
            border: 1px solid #ccc;
            border-radius: 4px;
         }
         
         input[type="button"] {
            background: #3498db;
            color: white;
            cursor: pointer;
            font-weight: bold;
         }
         
         input[type="button"]:hover {
            background: #2980b9;
         }
         
         .btn-qr {
            background: #27ae60;
         }
         
         .btn-qr:hover {
            background: #229954;
         }
         
         .btn-set {
            background: #e74c3c;
         }
         
         .btn-set:hover {
            background: #c0392b;
         }
         
         .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 4/3;
            margin-bottom: 15px;
            max-width: 400px;
            display: none;
         }
         
         #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
         }
         
         .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px dashed rgba(255, 255, 255, 0.8);
            border-radius: 8px;
         }
         
         .status-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
         }
         
         .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
         .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
         .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
      </style>
      
      <script type="text/javascript">
         var qrScanner = null;
         var lastQRValue = '';
         
         MGTest = {
            // QR Code Scanner Functions
            startQRScan: function() {
               var videoElement = document.getElementById("qr-video");
               var container = document.querySelector('.video-container');
               
               container.style.display = 'block';
               
               if (typeof QrScanner !== 'undefined') {
                  qrScanner = new QrScanner(
                     videoElement,
                     function(result) {
                        MGTest.handleQRResult(result.data || result);
                     },
                     {
                        returnDetailedScanResult: true,
                        highlightScanRegion: false,
                        highlightCodeOutline: false
                     }
                  );
                  
                  qrScanner.start().then(function() {
                     MGTest.showStatus('QRコードをスキャン中...', 'info');
                  }).catch(function(error) {
                     MGTest.showStatus('カメラアクセスエラー: ' + error.message, 'error');
                  });
               } else {
                  MGTest.showStatus('QRスキャナーライブラリが読み込まれていません', 'error');
               }
            },
            
            stopQRScan: function() {
               if (qrScanner) {
                  qrScanner.stop();
                  qrScanner.destroy();
                  qrScanner = null;
               }
               document.querySelector('.video-container').style.display = 'none';
               MGTest.showStatus('QRスキャンを停止しました', 'info');
            },
            
            handleQRResult: function(data) {
               lastQRValue = data;
               document.getElementById("qrResult").value = data;
               document.getElementById("qrDisplay").textContent = 'QR読み取り結果:\n' + data;
               MGTest.stopQRScan();
               MGTest.showStatus('QRコードを読み取りました', 'success');
               
               // 自動で値を設定フィールドにコピー
               MGTest.copyQRToFields();
            },
            
            copyQRToFields: function() {
               var qrValue = document.getElementById("qrResult").value;
               if (qrValue) {
                  // QRコードの値をコンポーネントとVariable両方にコピー
                  document.getElementById("pGetCompValue").value = qrValue;
                  document.getElementById("pGetVarValue").value = qrValue;
                  MGTest.showStatus('QR値をフィールドにコピーしました', 'success');
               }
            },
            
            setQRToComponent: function() {
               var compName = document.getElementById("pGetCompName").value;
               var qrValue = document.getElementById("qrResult").value;
               
               if (!compName) {
                  MGTest.showStatus('コンポーネント名を入力してください', 'error');
                  return;
               }
               
               if (!qrValue) {
                  MGTest.showStatus('QRコードを読み取ってください', 'error');
                  return;
               }
               
               WSForm.setCompValue(compName, qrValue, function(result) {
                  document.getElementById("results").value = "QR->Comp: " + result;
                  MGTest.showStatus('QR値をコンポーネント [' + compName + '] に設定しました', 'success');
               });
            },
            
            setQRToVariable: function() {
               var varName = document.getElementById("pGetVarName").value;
               var qrValue = document.getElementById("qrResult").value;
               
               if (!varName) {
                  MGTest.showStatus('変数名を入力してください', 'error');
                  return;
               }
               
               if (!qrValue) {
                  MGTest.showStatus('QRコードを読み取ってください', 'error');
                  return;
               }
               
               WSForm.setVarValue(varName, qrValue, function(result) {
                  document.getElementById("results").value = "QR->Var: " + result;
                  MGTest.showStatus('QR値を変数 [' + varName + '] に設定しました', 'success');
               });
            },
            
            // Original Functions
            getCompValue: function() {
               var name = document.getElementById("pGetCompName").value;
               WSForm.getCompValue(name, function(value) {
                  document.getElementById("pGetCompValue").value = value;
                  MGTest.showStatus('コンポーネント値を取得しました', 'success');
               });
            },

            setCompValue: function() {
               var name = document.getElementById("pGetCompName").value,
                   value = document.getElementById("pGetCompValue").value;
               WSForm.setCompValue(name, value, function(result) {
                  document.getElementById("results").value = "setComp: " + result;
                  MGTest.showStatus('コンポーネント値を設定しました', 'success');
               });
            },

            getVarValue: function() {
               var name = document.getElementById("pGetVarName").value;
               WSForm.getVarValue(name, function(value) {
                  document.getElementById("pGetVarValue").value = value;
                  MGTest.showStatus('変数値を取得しました', 'success');
               });
            },
            
            setVarValue: function() {
               var name = document.getElementById("pGetVarName").value,
                   value = document.getElementById("pGetVarValue").value;
               WSForm.setVarValue(name, value, function(result) {
                  document.getElementById("results").value = "setVar: " + result;
                  MGTest.showStatus('変数値を設定しました', 'success');
               });
            },
            
            generate: function() {
               var name = document.getElementById("eventName").value;
               WSForm.generate(name, function(result) {
                  document.getElementById("results").value = "generate: " + result;
                  MGTest.showStatus('イベントを生成しました', 'success');
               });
            },
            
            invoke: function() {
               var name = document.getElementById("methodName").value,
                   value = document.getElementById("methodArgs").value.split(',');
               WSForm.invoke.apply(window, [].concat(name, value, function(result) {
                  document.getElementById("results").value = "invoke: " + result;
                  MGTest.showStatus('メソッドを実行しました', 'success');
               }));
            },
            
            showStatus: function(message, type) {
               var statusDiv = document.getElementById("statusMessage");
               statusDiv.className = "status-message " + type;
               statusDiv.textContent = message;
               statusDiv.style.display = 'block';
               
               setTimeout(function() {
                  statusDiv.style.display = 'none';
               }, 3000);
            },
            
            manualQRInput: function() {
               var input = prompt('QRコードの内容を手入力してください:');
               if (input && input.trim()) {
                  MGTest.handleQRResult(input.trim());
               }
            }
         };
      </script>
   </head>
   <body>
      
      <div id="statusMessage" class="status-message" style="display: none;"></div>
      
      <!-- QRコード読み取りセクション -->
      <div class="container">
         <div class="qr-section">
            <h3>QRコード読み取り</h3>
            <div class="qr-controls">
               <input type="button" value="QRスキャン開始" onclick="MGTest.startQRScan()" class="btn-qr"/>
               <input type="button" value="スキャン停止" onclick="MGTest.stopQRScan()"/>
               <input type="button" value="手入力" onclick="MGTest.manualQRInput()"/>
               <input type="button" value="フィールドにコピー" onclick="MGTest.copyQRToFields()"/>
            </div>
            
            <div class="video-container">
               <video id="qr-video" playsinline></video>
               <div class="scan-overlay"></div>
            </div>
            
            <div>
               <label>QR読み取り値:</label><br>
               <input type="text" id="qrResult" style="width: 100%; margin-bottom: 10px;" readonly/>
            </div>
            
            <div id="qrDisplay" class="qr-display">
               QRコードをスキャンしてください
            </div>
         </div>
      </div>
      
      <!-- メイン操作テーブル -->
      <div class="container">
         <table cellpadding="6">
            <tr><td><b>Command</b></td><td><b>Parameters</b></td><td><b>Actions</b></td></tr>
            
            <tr>
               <td>Component<br><small>(CSI Form Element)</small></td>
               <td>
                  Name: <input type="text" id="pGetCompName" placeholder="例: txtLotNumber"/>
                  <br />
                  Value: <input type="text" id="pGetCompValue"/>
               </td>
               <td>
                  <input type="button" value="Get" onclick="MGTest.getCompValue()"/>
                  <input type="button" value="Set" onclick="MGTest.setCompValue()"/>
                  <br><br>
                  <input type="button" value="QR値で設定" onclick="MGTest.setQRToComponent()" class="btn-set"/>
               </td>
            </tr>
            
            <tr>
               <td>Variable<br><small>(Form/Global Variable)</small></td>
               <td>
                  Name: <input type="text" id="pGetVarName" placeholder="例: CurrentLot"/>
                  <br />
                  Value: <input type="text" id="pGetVarValue"/>
               </td>
               <td>
                  <input type="button" value="Get" onclick="MGTest.getVarValue()"/>
                  <input type="button" value="Set" onclick="MGTest.setVarValue()"/>
                  <br><br>
                  <input type="button" value="QR値で設定" onclick="MGTest.setQRToVariable()" class="btn-set"/>
               </td>
            </tr>

            <tr>
               <td>Method<br><small>(Business Logic)</small></td>
               <td>
                  Name: <input type="text" id="methodName" placeholder="例: ProcessLot"/>
                  <br />
                  Args: <input type="text" id="methodArgs" placeholder="引数をカンマ区切り"/>
               </td>
               <td>
                  <input type="button" value="Invoke" onclick="MGTest.invoke()"/>
               </td>
            </tr>

            <tr>
               <td>Generate Event<br><small>(User Events)</small></td>
               <td>
                  Name: <input type="text" id="eventName" placeholder="例: LotScanned"/>
               </td>
               <td>
                  <input type="button" value="Generate" onclick="MGTest.generate()"/>
               </td>
            </tr>
         </table>
      </div>
      
      <!-- 結果表示 -->
      <div class="container">
         <h3>実行結果</h3>
         Result: <br />
         <input type="text" id="results" style="width: 100%; padding: 8px;" readonly/>
      </div>
      
      <!-- 使用例 -->
      <div class="container">
         <h3>INFOR CSI/Factory Track 使用例</h3>
         <ul>
            <li><b>ロット番号読み取り:</b> QRスキャン → Component[txtLotNumber] または Variable[CurrentLot] に設定</li>
            <li><b>作業指示書:</b> QRスキャン → Component[txtWorkOrder] に設定 → Method[ProcessWorkOrder] 実行</li>
            <li><b>在庫移動:</b> QRスキャン → Variable[ScannedItem] に設定 → Event[ItemScanned] 生成</li>
            <li><b>検品処理:</b> QRスキャン → Method[ValidateItem] 実行 → 結果確認</li>
         </ul>
      </div>
   </body>
</html>