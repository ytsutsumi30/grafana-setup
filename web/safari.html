<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ï¼ˆSafariæœ€é©åŒ–ï¼‹URLè‡ªå‹•é·ç§»ï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <style>
        .scan-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 240px;
            height: 240px;
            border: 2px dashed rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            pointer-events: none;
        }
        
        .scan-corners {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 240px;
            height: 240px;
            pointer-events: none;
        }
        
        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #60a5fa;
        }
        
        .corner-tl { top: -3px; left: -3px; border-right: none; border-bottom: none; }
        .corner-tr { top: -3px; right: -3px; border-left: none; border-bottom: none; }
        .corner-bl { bottom: -3px; left: -3px; border-right: none; border-top: none; }
        .corner-br { bottom: -3px; right: -3px; border-left: none; border-top: none; }
        
        @keyframes scanning {
            0% { background-position: 0% 0%; }
            100% { background-position: 0% 100%; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes pulse-green {
            0%, 100% { background-color: #16a34a; }
            50% { background-color: #22c55e; }
        }
        
        .scanning-line {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 240px;
            height: 240px;
            background: linear-gradient(180deg, transparent 0%, transparent 45%, #60a5fa 50%, transparent 55%, transparent 100%);
            background-size: 100% 200%;
            animation: scanning 2s linear infinite;
            border-radius: 12px;
            pointer-events: none;
        }
        
        .calibrating {
            animation: pulse 1s ease-in-out infinite;
        }
        
        .pulse-green {
            animation: pulse-green 1s ease-in-out infinite;
        }
        
        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }
        
        .permission-guide {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }
        
        .url-indicator {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 2px solid #16a34a;
        }
        
        .debug-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-family: monospace;
            max-width: 200px;
        }
        
        .countdown {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 2rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-white shadow-sm border-b border-gray-200">
            <div class="px-4 py-4">
                <h1 class="text-xl font-bold text-gray-900 text-center flex items-center justify-center gap-2">
                    <span class="text-2xl">ğŸ“±</span>
                    QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ï¼ˆSafariæœ€é©åŒ–ï¼‹URLè‡ªå‹•é·ç§»ï¼‰
                </h1>
            </div>
        </div>

        <div class="flex-1 p-4 space-y-4">
            <!-- è¨­å®šãƒ‘ãƒãƒ« -->
            <div class="bg-white rounded-xl shadow-sm p-4">
                <h3 class="font-semibold text-gray-900 mb-3">ğŸ”§ å‹•ä½œè¨­å®š</h3>
                <div class="space-y-3">
                    <label class="flex items-center gap-3">
                        <input type="checkbox" id="auto-open-urls" checked class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded">
                        <span class="text-sm text-gray-700">URLã‚’è‡ªå‹•ã§æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã</span>
                    </label>
                    <label class="flex items-center gap-3">
                        <input type="checkbox" id="confirm-before-open" checked class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded">
                        <span class="text-sm text-gray-700">é–‹ãå‰ã«ç¢ºèªã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰</span>
                    </label>
                    <div class="flex items-center gap-3">
                        <label class="text-sm text-gray-700">è‡ªå‹•é·ç§»ã¾ã§ã®ç§’æ•°:</label>
                        <select id="countdown-seconds" class="px-3 py-1 border border-gray-300 rounded">
                            <option value="3">3ç§’</option>
                            <option value="5" selected>5ç§’</option>
                            <option value="10">10ç§’</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- åˆæœŸç”»é¢ -->
            <div id="initial-screen" class="text-center py-8">
                <div class="bg-white rounded-xl shadow-sm p-8 mb-6">
                    <div class="text-6xl mb-4">ğŸ“·</div>
                    <h2 class="text-xl font-semibold mb-3 text-gray-900">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h2>
                    <p class="text-gray-600 mb-6 max-w-sm mx-auto">
                        Safariæœ€é©åŒ–ç‰ˆï¼šURLã‚’è‡ªå‹•ã§æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™
                    </p>
                    <button id="start-scan" class="bg-blue-600 text-white px-8 py-4 rounded-xl font-medium hover:bg-blue-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
                    </button>
                </div>
                
                <!-- Safariå°‚ç”¨æ³¨æ„äº‹é … -->
                <div class="bg-amber-50 border border-amber-200 rounded-xl shadow-sm p-6 text-left max-w-md mx-auto">
                    <h3 class="font-semibold text-amber-800 mb-3">ğŸ iPhone/iPad Safariæœ€é©åŒ–</h3>
                    <ul class="text-sm text-amber-700 space-y-1">
                        <li>â€¢ æ®µéšçš„ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã§å®‰å®šæ€§å‘ä¸Š</li>
                        <li>â€¢ iOSç‰¹æœ‰ã®é…å»¶å•é¡Œã‚’è§£æ±º</li>
                        <li>â€¢ è‡ªå‹•ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½æ­è¼‰</li>
                        <li>â€¢ URLè‡ªå‹•é·ç§»æ©Ÿèƒ½ä»˜ã</li>
                        <li>â€¢ è¤‡æ•°ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½</li>
                    </ul>
                </div>
            </div>

            <!-- ã‚«ãƒ¡ãƒ©ç”»é¢ -->
            <div id="camera-screen" class="hidden">
                <div class="video-container mb-4">
                    <video id="camera-video" class="w-full h-full object-cover" playsinline muted webkit-playsinline></video>
                    <div class="scan-guide"></div>
                    <div class="scan-corners">
                        <div class="corner corner-tl"></div>
                        <div class="corner corner-tr"></div>
                        <div class="corner corner-bl"></div>
                        <div class="corner corner-br"></div>
                    </div>
                    <div id="scanning-animation" class="scanning-line hidden"></div>
                    
                    <!-- ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º -->
                    <div id="calibration-indicator" class="hidden absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                        <div class="bg-white rounded-lg p-6 text-center calibrating">
                            <div class="text-4xl mb-2">âš™ï¸</div>
                            <div class="text-lg font-semibold mb-1">ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­</div>
                            <div class="text-sm text-gray-600">ã‚«ãƒ¡ãƒ©ã‚’èª¿æ•´ã—ã¦ã„ã¾ã™...</div>
                        </div>
                    </div>
                    
                    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºç”¨ï¼‰ -->
                    <div id="debug-info" class="debug-info hidden">
                        <div>ReadyState: <span id="debug-ready"></span></div>
                        <div>Stream: <span id="debug-stream"></span></div>
                        <div>Detection: <span id="debug-detection"></span></div>
                        <div>Frames: <span id="debug-frames">0</span></div>
                    </div>
                    
                    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                    <div id="scan-status" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-4 py-2 rounded-full text-sm font-medium">
                        åˆæœŸåŒ–ä¸­...
                    </div>
                </div>
                
                <div class="text-center space-y-4">
                    <p class="text-gray-600">QRã‚³ãƒ¼ãƒ‰ã‚’ç”»é¢ä¸­å¤®ã®æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„</p>
                    <div class="flex gap-3 justify-center">
                        <button id="calibrate-camera" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors">
                            âš™ï¸ å†èª¿æ•´
                        </button>
                        <button id="toggle-debug" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            ğŸ› Debug
                        </button>
                        <button id="stop-scan" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                            â¹ï¸ åœæ­¢
                        </button>
                    </div>
                </div>
            </div>

            <!-- URLç¢ºèªç”»é¢ -->
            <div id="url-confirm-screen" class="hidden text-center">
                <div class="url-indicator rounded-xl shadow-sm p-8 mb-6">
                    <div class="text-6xl mb-4">ğŸŒ</div>
                    <h2 class="text-xl font-semibold mb-3 text-green-900">URLã‚’æ¤œå‡ºã—ã¾ã—ãŸ</h2>
                    
                    <div class="bg-white rounded-lg p-4 mb-6">
                        <h3 class="font-medium text-gray-700 mb-3">ğŸ“„ æ¤œå‡ºã•ã‚ŒãŸURL</h3>
                        <div class="bg-gray-50 border rounded-lg p-4 text-left">
                            <pre id="detected-url" class="whitespace-pre-wrap text-sm text-blue-600 break-all max-h-32 overflow-y-auto font-mono"></pre>
                        </div>
                        
                        <div id="url-info" class="mt-4 text-sm text-gray-600">
                            <div class="flex items-center justify-center gap-4">
                                <span id="url-protocol" class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs"></span>
                                <span id="url-domain" class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º -->
                    <div id="countdown-container" class="hidden mb-6">
                        <div class="flex items-center justify-center gap-4 mb-4">
                            <div class="countdown text-green-600" id="countdown-display">5</div>
                            <span class="text-gray-600">ç§’å¾Œã«è‡ªå‹•ã§é–‹ãã¾ã™</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="countdown-bar" class="bg-green-600 h-2 rounded-full transition-all duration-1000 pulse-green" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex gap-3">
                            <button id="open-url-now" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-colors flex-1 font-medium">
                                ğŸš€ ã™ãã«é–‹ã
                            </button>
                            <button id="cancel-open" class="bg-gray-600 text-white px-6 py-3 rounded-xl hover:bg-gray-700 transition-colors flex-1 font-medium">
                                âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                        <button id="copy-url" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors w-full">
                            ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                </div>
            </div>

            <!-- çµæœç”»é¢ï¼ˆéURLï¼‰ -->
            <div id="result-screen" class="hidden text-center">
                <div class="bg-white rounded-xl shadow-sm p-8 mb-6">
                    <div class="text-6xl mb-4">âœ…</div>
                    <h2 class="text-xl font-semibold mb-4 text-gray-900">ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†</h2>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="font-medium text-gray-700 mb-3">ğŸ“„ èª­ã¿å–ã‚Šçµæœ</h3>
                        <div class="bg-white border rounded-lg p-4 text-left">
                            <pre id="scan-result" class="whitespace-pre-wrap text-sm text-gray-800 break-all max-h-40 overflow-y-auto"></pre>
                        </div>
                        <div id="data-type" class="mt-2 text-xs text-gray-500"></div>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="copy-result" class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors w-full font-medium">
                            ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                        </button>
                        <div class="flex gap-3">
                            <button id="rescan" class="bg-gray-600 text-white px-4 py-3 rounded-xl hover:bg-gray-700 transition-colors flex-1">
                                ğŸ”„ å†ã‚¹ã‚­ãƒ£ãƒ³
                            </button>
                            <button id="share-result" class="bg-green-600 text-white px-4 py-3 rounded-xl hover:bg-green-700 transition-colors flex-1">
                                ğŸ“¤ å…±æœ‰
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼ç”»é¢ -->
            <div id="error-screen" class="hidden text-center">
                <div class="bg-white rounded-xl shadow-sm p-8 mb-6">
                    <div class="text-6xl mb-4">âŒ</div>
                    <h2 class="text-xl font-semibold mb-3 text-gray-900">ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼</h2>
                    <p id="error-message" class="text-red-600 mb-6"></p>
                    
                    <div class="permission-guide rounded-xl p-6 text-left mb-6">
                        <h3 class="font-semibold text-blue-900 mb-3">ğŸ”§ è§£æ±ºæ–¹æ³•ï¼ˆiOSï¼‰</h3>
                        <ol class="text-sm text-blue-800 space-y-2">
                            <li><strong>1.</strong> è¨­å®šã‚¢ãƒ—ãƒªã‚’é–‹ã</li>
                            <li><strong>2.</strong> Safari ã‚’é¸æŠ</li>
                            <li><strong>3.</strong> ã‚«ãƒ¡ãƒ© ã‚’é¸æŠ</li>
                            <li><strong>4.</strong> "è¨±å¯" ã¾ãŸã¯ "ç¢ºèª" ã‚’é¸æŠ</li>
                            <li><strong>5.</strong> ã“ã®ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿</li>
                        </ol>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="retry" class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors w-full">
                            ğŸ”„ å†è©¦è¡Œ
                        </button>
                        <button onclick="window.location.reload()" class="bg-gray-600 text-white px-6 py-3 rounded-xl hover:bg-gray-700 transition-colors w-full">
                            â™»ï¸ ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="bg-white border-t border-gray-200 p-4 text-center">
            <p class="text-sm text-gray-500 mb-1">ğŸ”’ HTTPSç’°å¢ƒã§å®‰å…¨ã«å‹•ä½œ</p>
            <p class="text-xs text-gray-400">Safariæœ€é©åŒ–ç‰ˆ + URLè‡ªå‹•é·ç§» v1.3</p>
        </div>
    </div>

    <script>
        class SafariOptimizedQRScannerWithURLRedirect {
            constructor() {
                this.video = document.getElementById('camera-video');
                this.stream = null;
                this.isScanning = false;
                this.qrScanner = null;
                this.currentCamera = 'environment';
                this.cameras = [];
                this.calibrationAttempts = 0;
                this.maxCalibrationAttempts = 3;
                this.frameCount = 0;
                this.lastDetectionAttempt = 0;
                this.isCalibrating = false;
                this.debugMode = false;
                this.countdownTimer = null;
                this.currentUrl = '';
                this.workerPath = './js/qr-scanner-worker.min.js';

                if (window.QrScanner && !window.QrScanner.WORKER_PATH) {
                    window.QrScanner.WORKER_PATH = this.workerPath;
                }
                
                this.initElements();
                this.initEventListeners();
                this.initPageLifecycleHandling();
                this.detectCameras();
            }

            initElements() {
                this.initialScreen = document.getElementById('initial-screen');
                this.cameraScreen = document.getElementById('camera-screen');
                this.urlConfirmScreen = document.getElementById('url-confirm-screen');
                this.resultScreen = document.getElementById('result-screen');
                this.errorScreen = document.getElementById('error-screen');
                this.scanStatus = document.getElementById('scan-status');
                this.scanResult = document.getElementById('scan-result');
                this.detectedUrl = document.getElementById('detected-url');
                this.errorMessage = document.getElementById('error-message');
                this.scanningAnimation = document.getElementById('scanning-animation');
                this.calibrationIndicator = document.getElementById('calibration-indicator');
                this.countdownContainer = document.getElementById('countdown-container');
                this.countdownDisplay = document.getElementById('countdown-display');
                this.countdownBar = document.getElementById('countdown-bar');
                this.urlInfo = document.getElementById('url-info');
                this.urlProtocol = document.getElementById('url-protocol');
                this.urlDomain = document.getElementById('url-domain');
                this.dataType = document.getElementById('data-type');
                this.debugInfo = document.getElementById('debug-info');
                this.debugElements = {
                    ready: document.getElementById('debug-ready'),
                    stream: document.getElementById('debug-stream'),
                    detection: document.getElementById('debug-detection'),
                    frames: document.getElementById('debug-frames')
                };
                
                // è¨­å®šè¦ç´ 
                this.autoOpenUrls = document.getElementById('auto-open-urls');
                this.confirmBeforeOpen = document.getElementById('confirm-before-open');
                this.countdownSeconds = document.getElementById('countdown-seconds');
            }

            initEventListeners() {
                document.getElementById('start-scan').addEventListener('click', () => this.startScan());
                document.getElementById('stop-scan').addEventListener('click', () => this.stopScan());
                document.getElementById('calibrate-camera').addEventListener('click', () => this.calibrateCamera());
                document.getElementById('toggle-debug').addEventListener('click', () => this.toggleDebug());
                document.getElementById('retry').addEventListener('click', () => this.resetAndStart());
                document.getElementById('rescan').addEventListener('click', () => this.resetAndStart());
                document.getElementById('copy-result').addEventListener('click', () => this.copyToClipboard());
                document.getElementById('copy-url').addEventListener('click', () => this.copyUrl());
                document.getElementById('share-result').addEventListener('click', () => this.shareResult());
                document.getElementById('open-url-now').addEventListener('click', () => this.openUrlNow());
                document.getElementById('cancel-open').addEventListener('click', () => this.cancelUrlOpen());
            }

            // ãƒšãƒ¼ã‚¸ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†ï¼ˆSafariæœ€é©åŒ–ï¼‰
            initPageLifecycleHandling() {
                // Page Visibility API
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        if (this.isScanning) {
                            this.pauseScanning();
                        }
                    } else {
                        if (this.isScanning) {
                            setTimeout(() => this.resumeScanning(), 500);
                        }
                    }
                });

                // Safariç”¨ã®beforeunloadå¯¾ç­–
                window.addEventListener('beforeunload', () => {
                    this.cleanupResources();
                });

                // Safariç”¨ã®pagehide/pageshowã‚¤ãƒ™ãƒ³ãƒˆ
                window.addEventListener('pagehide', () => {
                    this.cleanupResources();
                });

                window.addEventListener('pageshow', (event) => {
                    if (event.persisted) {
                        // ãƒšãƒ¼ã‚¸ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒã•ã‚ŒãŸå ´åˆ
                        this.resetAndStart();
                    }
                });
            }

            // URLæ¤œè¨¼æ©Ÿèƒ½
            isValidUrl(string) {
                try {
                    const url = new URL(string);
                    return ['http:', 'https:'].includes(url.protocol);
                } catch (error) {
                    // URLå½¢å¼ã§ãªã„å ´åˆã‚‚ã€http://ã‚„https://ã§å§‹ã¾ã‚‹æ–‡å­—åˆ—ã‚’ãƒã‚§ãƒƒã‚¯
                    const urlPattern = /^(https?:\/\/)/i;
                    return urlPattern.test(string.trim());
                }
            }

            // URLæƒ…å ±ã®æŠ½å‡º
            getUrlInfo(urlString) {
                try {
                    const url = new URL(urlString);
                    return {
                        protocol: url.protocol,
                        hostname: url.hostname,
                        pathname: url.pathname,
                        isSecure: url.protocol === 'https:'
                    };
                } catch (error) {
                    return {
                        protocol: 'unknown',
                        hostname: 'unknown',
                        pathname: '',
                        isSecure: false
                    };
                }
            }

            async detectCameras() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.cameras = devices.filter(device => device.kind === 'videoinput');
                    this.updateDebug('detection', `${this.cameras.length} cameras found`);
                } catch (error) {
                    console.warn('ã‚«ãƒ¡ãƒ©æ¤œå‡ºã‚¨ãƒ©ãƒ¼:', error);
                    this.updateDebug('detection', 'Camera detection failed');
                }
            }

            showScreen(screenName) {
                ['initial-screen', 'camera-screen', 'url-confirm-screen', 'result-screen', 'error-screen'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenName).classList.remove('hidden');
            }

            updateStatus(message) {
                this.scanStatus.textContent = message;
            }

            updateDebug(type, value) {
                if (this.debugElements[type]) {
                    this.debugElements[type].textContent = value;
                }
            }

            toggleDebug() {
                this.debugMode = !this.debugMode;
                this.debugInfo.classList.toggle('hidden', !this.debugMode);
            }

            // Safariæœ€é©åŒ–: æ®µéšçš„ãªã‚«ãƒ¡ãƒ©åˆæœŸåŒ–
            async startScan() {
                try {
                    this.calibrationAttempts = 0;
                    this.frameCount = 0;
                    this.updateStatus('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...');
                    
                    await this.initializeCamera();
                    
                } catch (error) {
                    this.handleError(error);
                }
            }

            async initializeCamera() {
                // iPhone/iPad Safariå‘ã‘ã«æ®µéšçš„ãªåˆ¶ç´„ãƒªã‚¹ãƒˆã‚’ç”¨æ„
                const constraintsList = [
                    // ãƒ¬ãƒ™ãƒ«1: æœ€é©è¨­å®šï¼ˆæ–°ã—ã„iOSå‘ã‘ï¼‰
                    {
                        video: {
                            facingMode: this.currentCamera,
                            width: { ideal: 1920, max: 1920 },
                            height: { ideal: 1080, max: 1080 },
                            frameRate: { ideal: 30, max: 30 }
                        }
                    },
                    // ãƒ¬ãƒ™ãƒ«2: æ¨™æº–HD
                    {
                        video: {
                            facingMode: this.currentCamera,
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            frameRate: { ideal: 25 }
                        }
                    },
                    // ãƒ¬ãƒ™ãƒ«3: æ¨™æº–SD
                    {
                        video: {
                            facingMode: this.currentCamera,
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    },
                    // ãƒ¬ãƒ™ãƒ«4: æœ€å°åˆ¶ç´„
                    {
                        video: { facingMode: this.currentCamera }
                    },
                    // ãƒ¬ãƒ™ãƒ«5: å®Œå…¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    { video: true }
                ];

                let lastError = null;
                for (let i = 0; i < constraintsList.length; i++) {
                    try {
                        console.log(`Attempting constraints level ${i + 1}/${constraintsList.length}`);
                        this.updateDebug('stream', `Level ${i + 1} trying...`);
                        
                        this.stream = await navigator.mediaDevices.getUserMedia(constraintsList[i]);
                        
                        // ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—æˆåŠŸ
                        const track = this.stream.getVideoTracks()[0];
                        const settings = track.getSettings();
                        
                        console.log(`Camera acquired successfully:`, {
                            level: i + 1,
                            resolution: `${settings.width}x${settings.height}`,
                            fps: settings.frameRate,
                            facingMode: settings.facingMode
                        });
                        
                        this.updateDebug('stream', `Level ${i + 1} success: ${settings.width}x${settings.height}`);
                        break;
                    } catch (error) {
                        console.log(`Constraints level ${i + 1} failed:`, error.name);
                        lastError = error;
                        
                        if (i === constraintsList.length - 1) {
                            throw lastError;
                        }
                    }
                }

                if (!this.stream) {
                    throw new Error('ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                this.video.srcObject = this.stream;
                this.updateDebug('stream', 'Connected');

                // iPhone/iPad Safariç”¨ã®ç‰¹åˆ¥ãªå±æ€§è¨­å®š
                this.video.setAttribute('playsinline', true);
                this.video.setAttribute('webkit-playsinline', true);
                this.video.setAttribute('autoplay', true);
                this.video.muted = true;
                this.video.playsInline = true;
                
                // iOSå‘ã‘ã®è¿½åŠ å±æ€§
                this.video.style.objectFit = 'cover';
                this.video.style.transform = 'scaleX(-1)'; // ãƒŸãƒ©ãƒ¼è¡¨ç¤ºã§ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š

                // ã‚ˆã‚Šç¢ºå®ŸãªåˆæœŸåŒ–å¾…æ©Ÿ
                await this.waitForVideoReady();
                
                this.showScreen('camera-screen');
                this.isScanning = true;
                
                // Safariæœ€é©åŒ–: ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                await this.calibrateCamera();
            }

            // iPhone/iPad Safariæœ€é©åŒ–: ã‚ˆã‚Šç¢ºå®Ÿãªãƒ“ãƒ‡ã‚ªæº–å‚™å¾…æ©Ÿ
            async waitForVideoReady() {
                return new Promise((resolve, reject) => {
                    let checkCount = 0;
                    const maxChecks = 200; // iPhoneå‘ã‘ã«å¢—åŠ 
                    
                    const timeout = setTimeout(() => {
                        console.log('Video initialization timeout', {
                            readyState: this.video.readyState,
                            videoWidth: this.video.videoWidth,
                            videoHeight: this.video.videoHeight,
                            streamActive: this.stream?.active,
                            checks: checkCount
                        });
                        
                        // readyState >= 2 ãªã‚‰ç¶šè¡Œã‚’è©¦ã¿ã‚‹
                        if (this.video.readyState >= 2) {
                            console.log('Timeout but video ready, continuing...');
                            resolve();
                        } else {
                            reject(new Error('ãƒ“ãƒ‡ã‚ªåˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
                        }
                    }, 30000); // 30ç§’ã«å»¶é•·

                    const checkReady = () => {
                        checkCount++;
                        this.updateDebug('ready', `${this.video.readyState} (${checkCount})`);
                        
                        // ã‚¹ãƒˆãƒªãƒ¼ãƒ çŠ¶æ…‹ç¢ºèª
                        if (!this.stream || !this.stream.active) {
                            clearTimeout(timeout);
                            reject(new Error('ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒç„¡åŠ¹ã§ã™'));
                            return;
                        }
                        
                        if (checkCount % 20 === 0) {
                            console.log(`Video check ${checkCount}:`, {
                                readyState: this.video.readyState,
                                size: `${this.video.videoWidth}x${this.video.videoHeight}`,
                                currentTime: this.video.currentTime,
                                paused: this.video.paused
                            });
                        }
                        
                        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº† & æ˜ åƒãƒ‡ãƒ¼ã‚¿ã‚ã‚Š
                        if (this.video.readyState >= 2 && 
                            this.video.videoWidth > 0 && 
                            this.video.videoHeight > 0) {
                            
                            clearTimeout(timeout);
                            
                            // å†ç”Ÿé–‹å§‹ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
                            const startPlayback = async () => {
                                try {
                                    await this.video.play();
                                    console.log('Video playback started', {
                                        size: `${this.video.videoWidth}x${this.video.videoHeight}`,
                                        readyState: this.video.readyState,
                                        currentTime: this.video.currentTime
                                    });
                                    
                                    // iPhone/iPadå‘ã‘ã®è¿½åŠ å¾…æ©Ÿæ™‚é–“
                                    const waitTime = this.isIOSDevice() ? 2000 : 1000;
                                    setTimeout(resolve, waitTime);
                                } catch (playError) {
                                    console.log('Video play failed, but continuing:', playError);
                                    
                                    // autoplayãŒåŠ¹ã„ã¦ã„ã‚‹å ´åˆã‚„ã€ã™ã§ã«å†ç”Ÿä¸­ã®å ´åˆã¯ç¶šè¡Œ
                                    if (this.video.readyState >= 2 && !this.video.paused) {
                                        console.log('Video playing without explicit play()');
                                        setTimeout(resolve, 1500);
                                    } else {
                                        // å†ç”Ÿã«å¤±æ•—ã—ãŸãŒã€æº–å‚™ã¯ã§ãã¦ã„ã‚‹ã®ã§ç¶šè¡Œ
                                        console.log('Play failed but readyState OK, continuing...');
                                        setTimeout(resolve, 1000);
                                    }
                                }
                            };
                            
                            startPlayback();
                            
                        } else if (checkCount >= maxChecks) {
                            clearTimeout(timeout);
                            reject(new Error(`ãƒ“ãƒ‡ã‚ªãŒæº–å‚™ã§ãã¾ã›ã‚“ (checks: ${checkCount})`));
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };

                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                    this.video.onloadedmetadata = () => {
                        console.log('Video metadata loaded');
                        setTimeout(checkReady, 100); // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒã‚§ãƒƒã‚¯
                    };
                    
                    this.video.oncanplay = () => {
                        console.log('Video can start playing');
                    };
                    
                    this.video.oncanplaythrough = () => {
                        console.log('Video can play through');
                    };
                    
                    this.video.onerror = (error) => {
                        console.log('Video element error:', error);
                        clearTimeout(timeout);
                        reject(new Error('ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚¨ãƒ©ãƒ¼'));
                    };
                    
                    // åˆå›ãƒã‚§ãƒƒã‚¯é–‹å§‹
                    setTimeout(checkReady, 200);
                });
            }

            // iOSåˆ¤å®šãƒ˜ãƒ«ãƒ‘ãƒ¼
            isIOSDevice() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent);
            }

            // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼ˆiPhone/iPad Safariæœ€é©åŒ–ï¼‰
            async calibrateCamera() {
                if (this.isCalibrating || this.calibrationAttempts >= this.maxCalibrationAttempts) {
                    return this.startQRDetection();
                }

                this.isCalibrating = true;
                this.calibrationAttempts++;

                this.calibrationIndicator.classList.remove('hidden');
                this.updateStatus(`ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­... (${this.calibrationAttempts}/${this.maxCalibrationAttempts})`);

                // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®çŠ¶æ…‹ç¢ºèª
                if (!this.stream || !this.stream.active) {
                    throw new Error('ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒç„¡åŠ¹ã§ã™');
                }

                if (!this.video || !this.video.srcObject) {
                    throw new Error('ãƒ“ãƒ‡ã‚ªè¦ç´ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                // iPhone/iPadå‘ã‘ã®ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“ï¼ˆé•·ã‚ã«è¨­å®šï¼‰
                const calibrationTime = this.isIOSDevice() ? 3000 : 2000;
                console.log(`Calibrating for ${calibrationTime}ms (iOS: ${this.isIOSDevice()})`);

                await new Promise(resolve => setTimeout(resolve, calibrationTime));

                this.calibrationIndicator.classList.add('hidden');
                this.isCalibrating = false;

                // ã‚«ãƒ¡ãƒ©ãŒå®Œå…¨ã«æº–å‚™ã§ãã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const isReady = this.video.readyState >= 2 &&
                               this.video.videoWidth > 0 &&
                               this.video.videoHeight > 0;

                console.log('Calibration check:', {
                    readyState: this.video.readyState,
                    size: `${this.video.videoWidth}x${this.video.videoHeight}`,
                    currentTime: this.video.currentTime,
                    attempt: this.calibrationAttempts
                });

                if (isReady) {
                    console.log('Calibration successful, waiting for frame stabilization...');
                    // åˆå›ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—å¯¾ç­–: ãƒ•ãƒ¬ãƒ¼ãƒ ãŒå®‰å®šã™ã‚‹ã¾ã§è¿½åŠ å¾…æ©Ÿ
                    // iOS Safari ã§ã¯åˆå›ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒä¸å®‰å®šãªãŸã‚ã€è¿½åŠ ã®å¾…æ©Ÿæ™‚é–“ãŒå¿…è¦
                    const frameStabilizationTime = this.isIOSDevice() ? 1500 : 800;
                    console.log(`Waiting ${frameStabilizationTime}ms for frame stabilization...`);
                    this.updateStatus(`QRã‚¹ã‚­ãƒ£ãƒ³æº–å‚™ä¸­...`);

                    await new Promise(resolve => setTimeout(resolve, frameStabilizationTime));

                    console.log('Frame stabilization complete, starting QR detection');
                    this.startQRDetection();
                } else if (this.calibrationAttempts < this.maxCalibrationAttempts) {
                    console.log('Calibration incomplete, retrying...');
                    setTimeout(() => this.calibrateCamera(), 1500);
                } else {
                    // æœ€å¤§è©¦è¡Œå›æ•°åˆ°é”
                    if (this.video.readyState >= 1) { // æœ€ä½é™ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ç¶šè¡Œ
                        console.log('Max calibration attempts but continuing...');
                        // æœ€å¤§è©¦è¡Œæ™‚ã§ã‚‚è¿½åŠ å¾…æ©Ÿã‚’å…¥ã‚Œã‚‹
                        const frameStabilizationTime = this.isIOSDevice() ? 1500 : 800;
                        this.updateStatus(`QRã‚¹ã‚­ãƒ£ãƒ³æº–å‚™ä¸­...`);
                        await new Promise(resolve => setTimeout(resolve, frameStabilizationTime));
                        this.startQRDetection();
                    } else {
                        throw new Error('ã‚«ãƒ¡ãƒ©ã®ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            }

            async startQRDetection() {
                this.updateStatus('QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...');
                this.scanningAnimation.classList.remove('hidden');
                this.updateDebug('detection', 'Starting');
                
                // QR Scannerãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
                if (typeof QrScanner !== 'undefined') {
                    try {
                        console.log('Initializing QR Scanner with library...');
                        QrScanner.WORKER_PATH = this.workerPath;
                        this.qrScanner = new QrScanner(
                            this.video,
                            result => this.handleQRResult(result.data || result),
                            {
                                returnDetailedScanResult: true,
                                highlightScanRegion: false,
                                highlightCodeOutline: false,
                                // iPhone/iPad Safariæœ€é©åŒ–è¨­å®š
                                maxScansPerSecond: this.isIOSDevice() ? 3 : 5, // iOSã§ã¯æ›´ã«é »åº¦ã‚’ä¸‹ã’ã‚‹
                                calculateScanRegion: this.calculateScanRegion.bind(this),
                                preferredCamera: 'environment'
                            }
                        );
                        
                        await this.qrScanner.start();
                        console.log('QR Scanner started successfully');
                        this.updateDebug('detection', 'QrScanner active');
                        
                        // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼é–‹å§‹
                        this.startFrameCounter();
                        
                    } catch (error) {
                        console.warn('QR Scanner library failed, using fallback:', error);
                        this.updateDebug('detection', 'Library failed, using fallback');
                        this.fallbackToManualDetection();
                    }
                } else {
                    console.log('QR Scanner library not available, using fallback');
                    this.updateDebug('detection', 'Library not available');
                    this.fallbackToManualDetection();
                }
            }

            // Safariæœ€é©åŒ–: ã‚¹ã‚­ãƒ£ãƒ³é ˜åŸŸã®è¨ˆç®—
            calculateScanRegion(video) {
                const { videoWidth, videoHeight } = video;
                const size = Math.min(videoWidth, videoHeight) * 0.6;
                const x = (videoWidth - size) / 2;
                const y = (videoHeight - size) / 2;
                
                return {
                    x: Math.round(x),
                    y: Math.round(y),
                    width: Math.round(size),
                    height: Math.round(size)
                };
            }

            // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            startFrameCounter() {
                const countFrames = () => {
                    if (this.isScanning) {
                        this.frameCount++;
                        this.updateDebug('frames', this.frameCount);
                        requestAnimationFrame(countFrames);
                    }
                };
                countFrames();
            }

            fallbackToManualDetection() {
                console.log('Attempting fallback detection methods...');
                this.updateDebug('detection', 'Fallback mode');
                
                if ('BarcodeDetector' in window) {
                    console.log('Using BarcodeDetector API');
                    
                    BarcodeDetector.getSupportedFormats().then(formats => {
                        console.log('Supported barcode formats:', formats);
                        this.updateDebug('detection', `BarcodeDetector: ${formats.length} formats`);
                    }).catch(err => {
                        console.warn('Failed to get supported formats:', err);
                    });
                    
                    const detector = new BarcodeDetector({ formats: ['qr_code'] });
                    
                    const detectQR = async () => {
                        if (this.isScanning && this.video.readyState >= 2) {
                            try {
                                const currentTime = Date.now();
                                // iPhone/iPadå‘ã‘ã«æ¤œå‡ºé–“éš”ã‚’èª¿æ•´
                                const detectionInterval = this.isIOSDevice() ? 500 : 300;
                                
                                if (currentTime - this.lastDetectionAttempt > detectionInterval) {
                                    const barcodes = await detector.detect(this.video);
                                    this.lastDetectionAttempt = currentTime;
                                    
                                    if (barcodes.length > 0) {
                                        console.log('QR code detected via BarcodeDetector:', barcodes[0].rawValue);
                                        this.handleQRResult(barcodes[0].rawValue);
                                        return;
                                    }
                                }
                            } catch (error) {
                                console.warn('BarcodeDetector error:', error);
                                // ã‚¨ãƒ©ãƒ¼ãŒé »ç™ºã™ã‚‹å ´åˆã¯æ¤œå‡ºé–“éš”ã‚’é•·ãã™ã‚‹
                                if (error.name === 'NotSupportedError') {
                                    this.updateDebug('detection', 'BarcodeDetector not supported');
                                    this.showNotSupportedError();
                                    return;
                                }
                            }
                        }
                        
                        if (this.isScanning) {
                            requestAnimationFrame(detectQR);
                        }
                    };
                    
                    detectQR();
                    this.updateStatus('QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­... (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰)');
                    console.log('BarcodeDetector fallback active');
                } else {
                    console.error('No QR detection method available');
                    this.updateDebug('detection', 'No detection API available');
                    
                    // iOS Safariã®å ´åˆã¯ã€ã‚ˆã‚Šå…·ä½“çš„ãªã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
                    if (this.isIOSDevice()) {
                        this.handleError(new Error('iOS Safari QR detection unavailable'));
                    } else {
                        this.handleError(new Error('QR detection not supported'));
                    }
                }
            }

            // iOS Safariã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆã®å°‚ç”¨ã‚¨ãƒ©ãƒ¼
            showNotSupportedError() {
                this.stopScan();
                this.errorMessage.innerHTML = `
                    <div class="mb-4">
                        <strong>iOS Safariã§ã¯ã€ã“ã®QRæ¤œå‡ºæ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</strong>
                    </div>
                    <div class="text-sm space-y-2">
                        <p>ğŸ”§ <strong>æ¨å¥¨è§£æ±ºæ–¹æ³•:</strong></p>
                        <ul class="list-disc list-inside space-y-1 text-left">
                            <li>iOSã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°</li>
                            <li>Chrome for iOSã‚„Edgeã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨</li>
                            <li>ã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒªã®æ¨™æº–QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’ä½¿ç”¨</li>
                        </ul>
                    </div>
                `;
                this.showScreen('error-screen');
            }

            handleQRResult(data) {
                // é‡è¤‡æ¤œå‡ºé˜²æ­¢
                if (!this.isScanning) return;
                
                this.updateDebug('detection', 'QR detected!');
                this.stopScan();
                
                // URLã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                if (this.isValidUrl(data)) {
                    this.handleUrlResult(data);
                } else {
                    this.handleNonUrlResult(data);
                }
            }

            // URLçµæœã®å‡¦ç†
            handleUrlResult(url) {
                this.currentUrl = url;
                this.detectedUrl.textContent = url;
                
                // URLæƒ…å ±ã‚’è¡¨ç¤º
                const urlInfo = this.getUrlInfo(url);
                this.urlProtocol.textContent = urlInfo.protocol;
                this.urlDomain.textContent = urlInfo.hostname;
                
                // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¡¨ç¤º
                if (urlInfo.isSecure) {
                    this.urlProtocol.className = 'px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs';
                } else {
                    this.urlProtocol.className = 'px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs';
                }

                this.showScreen('url-confirm-screen');

                // è‡ªå‹•é·ç§»ã®è¨­å®šã«åŸºã¥ã„ã¦å‡¦ç†
                if (this.autoOpenUrls.checked) {
                    if (this.confirmBeforeOpen.checked) {
                        // ç¢ºèªç”»é¢ã§ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹
                        this.startCountdown();
                    } else {
                        // å³åº§ã«é–‹ã
                        this.openUrl(url);
                    }
                }
            }

            // éURLçµæœã®å‡¦ç†
            handleNonUrlResult(data) {
                this.scanResult.textContent = data;
                
                // ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã®åˆ¤å®š
                let dataTypeText = 'ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿';
                if (data.includes('@') && data.includes('.')) {
                    dataTypeText = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¯èƒ½æ€§';
                } else if (/^\d+$/.test(data)) {
                    dataTypeText = 'æ•°å€¤ãƒ‡ãƒ¼ã‚¿';
                } else if (data.startsWith('tel:')) {
                    dataTypeText = 'é›»è©±ç•ªå·';
                } else if (data.startsWith('mailto:')) {
                    dataTypeText = 'ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯';
                }
                
                this.dataType.textContent = `ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—: ${dataTypeText}`;
                this.showScreen('result-screen');
            }

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹
            startCountdown() {
                const seconds = parseInt(this.countdownSeconds.value);
                let remainingSeconds = seconds;
                
                this.countdownContainer.classList.remove('hidden');
                this.countdownDisplay.textContent = remainingSeconds;
                
                this.countdownTimer = setInterval(() => {
                    remainingSeconds--;
                    this.countdownDisplay.textContent = remainingSeconds;
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–°
                    const progress = (remainingSeconds / seconds) * 100;
                    this.countdownBar.style.width = `${progress}%`;
                    
                    if (remainingSeconds <= 0) {
                        this.openUrlNow();
                    }
                }, 1000);
            }

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³åœæ­¢
            stopCountdown() {
                if (this.countdownTimer) {
                    clearInterval(this.countdownTimer);
                    this.countdownTimer = null;
                }
                this.countdownContainer.classList.add('hidden');
                this.countdownBar.style.width = '100%';
            }

            // URL ã‚’é–‹ã
            openUrl(url) {
                try {
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œ
                    const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
                    
                    if (newWindow) {
                        console.log(`URL opened in new tab: ${url}`);
                        // æˆåŠŸã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                        this.showSuccessMessage('æ–°ã—ã„ã‚¿ãƒ–ã§URLã‚’é–‹ãã¾ã—ãŸ');
                        setTimeout(() => this.resetAndStart(), 2000);
                    } else {
                        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
                        this.showPopupBlockedMessage();
                    }
                } catch (error) {
                    console.error('Failed to open URL:', error);
                    this.showErrorMessage('URLã‚’é–‹ãã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            }

            // ã™ãã«é–‹ããƒœã‚¿ãƒ³ã®å‡¦ç†
            openUrlNow() {
                this.stopCountdown();
                this.openUrl(this.currentUrl);
            }

            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®å‡¦ç†
            cancelUrlOpen() {
                this.stopCountdown();
                // é€šå¸¸ã®çµæœç”»é¢ã¨ã—ã¦è¡¨ç¤º
                this.handleNonUrlResult(this.currentUrl);
            }

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
            showSuccessMessage(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                successDiv.textContent = message;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    document.body.removeChild(successDiv);
                }, 3000);
            }

            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showPopupBlockedMessage() {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-yellow-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-sm text-center';
                blockDiv.innerHTML = `
                    <div class="font-semibold mb-1">ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ</div>
                    <div class="text-xs">ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„</div>
                `;
                document.body.appendChild(blockDiv);
                
                setTimeout(() => {
                    document.body.removeChild(blockDiv);
                }, 5000);
            }

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
            showErrorMessage(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    document.body.removeChild(errorDiv);
                }, 3000);
            }

            // Safariæœ€é©åŒ–: ã‚¹ã‚­ãƒ£ãƒ³ä¸€æ™‚åœæ­¢/å†é–‹
            pauseScanning() {
                if (this.qrScanner) {
                    this.qrScanner.stop();
                }
                this.scanningAnimation.classList.add('hidden');
                this.updateStatus('ä¸€æ™‚åœæ­¢ä¸­...');
            }

            async resumeScanning() {
                if (this.qrScanner && this.isScanning) {
                    try {
                        await this.qrScanner.start();
                        this.scanningAnimation.classList.remove('hidden');
                        this.updateStatus('QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...');
                    } catch (error) {
                        console.warn('Resume scanning failed:', error);
                        this.calibrateCamera();
                    }
                }
            }

            stopScan() {
                this.isScanning = false;
                this.isCalibrating = false;
                this.scanningAnimation.classList.add('hidden');
                this.calibrationIndicator.classList.add('hidden');
                this.stopCountdown();
                
                this.cleanupResources();
                this.showScreen('initial-screen');
            }

            cleanupResources() {
                if (this.qrScanner) {
                    this.qrScanner.stop();
                    this.qrScanner.destroy();
                    this.qrScanner = null;
                }
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                this.updateDebug('stream', 'Disconnected');
                this.updateDebug('detection', 'Stopped');
            }

            handleError(error) {
                this.stopScan();
                
                let message = 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                
                // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (error) {
                    console.error('QR Scanner Error:', error);
                    
                    switch (error.name) {
                        case 'NotAllowedError':
                            if (this.isIOSDevice()) {
                                message = `
                                    <div class="mb-4"><strong>ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ</strong></div>
                                    <div class="text-sm">
                                        iPhoneã®å ´åˆï¼š<br>
                                        è¨­å®š â†’ Safari â†’ ã‚«ãƒ¡ãƒ© â†’ "è¨±å¯" ã‚’é¸æŠã—ã¦ãã ã•ã„
                                    </div>
                                `;
                            } else {
                                message = 'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰ã‚«ãƒ¡ãƒ©ã®è¨±å¯ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚';
                            }
                            break;
                        case 'NotFoundError':
                            message = 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                            break;
                        case 'NotSupportedError':
                            if (this.isIOSDevice()) {
                                message = `
                                    <div class="mb-4"><strong>ã“ã®iOSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“</strong></div>
                                    <div class="text-sm">
                                        â€¢ iOSã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°<br>
                                        â€¢ Chrome for iOSã¾ãŸã¯Edgeã‚¢ãƒ—ãƒªã‚’è©¦ã™<br>
                                        â€¢ ã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒªã®QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’ä½¿ç”¨
                                    </div>
                                `;
                            } else {
                                message = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®Safariã€Chromeã€ã¾ãŸã¯Edgeã‚’ãŠè©¦ã—ãã ã•ã„ã€‚';
                            }
                            break;
                        case 'NotReadableError':
                            message = 'ã‚«ãƒ¡ãƒ©ãŒä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ä¸­ã§ã™ã€‚ä»–ã®ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                            break;
                        case 'SecurityError':
                            message = 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã‚ˆã‚Šã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚HTTPSç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚';
                            break;
                        case 'AbortError':
                            message = 'ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                            break;
                        default:
                            if (error.message) {
                                if (error.message.includes('iOS Safari QR detection unavailable')) {
                                    message = `
                                        <div class="mb-4"><strong>iOS Safariã®QRæ¤œå‡ºåˆ¶é™</strong></div>
                                        <div class="text-sm">
                                            ç¾åœ¨ã®iOS Safariã§ã¯QRæ¤œå‡ºAPIãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
                                            ä»£æ›¿æ‰‹æ®µã‚’ãŠè©¦ã—ãã ã•ã„ã€‚
                                        </div>
                                    `;
                                } else if (error.message.includes('QR detection not supported')) {
                                    message = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯QRã‚³ãƒ¼ãƒ‰æ¤œå‡ºã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®Safariã€Chromeã€ã¾ãŸã¯Edgeã‚’ãŠè©¦ã—ãã ã•ã„ã€‚';
                                } else {
                                    message = `ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                                }
                            }
                            break;
                    }
                }

                this.errorMessage.innerHTML = message;
                this.showScreen('error-screen');
            }

            resetAndStart() {
                this.stopScan();
                this.calibrationAttempts = 0;
                this.frameCount = 0;
                this.showScreen('initial-screen');
            }

            async copyUrl() {
                try {
                    await navigator.clipboard.writeText(this.currentUrl);
                    const button = document.getElementById('copy-url');
                    const originalText = button.textContent;
                    button.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†!';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                } catch (error) {
                    console.error('Copy failed:', error);
                }
            }

            async copyToClipboard() {
                try {
                    await navigator.clipboard.writeText(this.scanResult.textContent);
                    const button = document.getElementById('copy-result');
                    const originalText = button.textContent;
                    button.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†!';
                    button.classList.add('bg-green-600', 'hover:bg-green-700');
                    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-green-600', 'hover:bg-green-700');
                        button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }, 2000);
                } catch (error) {
                    console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', error);
                    alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            }

            async shareResult() {
                const text = this.scanResult.textContent;
                
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šçµæœ',
                            text: text
                        });
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('å…±æœ‰å¤±æ•—:', error);
                        }
                    }
                } else {
                    this.copyToClipboard();
                }
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new SafariOptimizedQRScannerWithURLRedirect();
        });

        // Safariç”¨ã®è¿½åŠ æœ€é©åŒ–
        window.addEventListener('load', () => {
            // Safariç”¨ã®ãƒ¡ãƒ¢ãƒªç®¡ç†
            if (window.performance && window.performance.navigation.type === 1) {
                // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
                console.log('Page reloaded - Safari optimization with URL redirect active');
            }
        });
    </script>
</body>
</html>