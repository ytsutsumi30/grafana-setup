<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºè·æŒ‡ç¤ºç®¡ç† </title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin: 1rem 0;
            padding: 2rem;
            min-height: 600px;
        }

        .screen.active {
            display: block;
        }

        .search-section {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #2563eb;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        input, select {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        }

        /* ç´å…¥å ´æ‰€ã‚«ãƒ¼ãƒ‰ï¼ˆæ–°è¦è¿½åŠ ï¼‰ */
        .delivery-locations {
            margin-top: 2rem;
        }

        .delivery-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .delivery-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .delivery-info h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .delivery-meta {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .item-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .summary-item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
        }

        .summary-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .item-list {
            margin-top: 2rem;
        }

        .item-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .item-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .item-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .item-info {
            flex: 1;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .item-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .item-meta {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            background: #dbeafe;
            color: #1e40af;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .camera-section {
            text-align: center;
            padding: 2rem;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .camera-area {
            width: 100%;
            max-width: 500px;
            height: 300px;
            background: #1f2937;
            border-radius: 8px;
            margin: 1rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
        }

        .picked-items {
            margin-top: 2rem;
        }

        .picked-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f0fdf4;
            border: 1px solid #dcfce7;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .qty-input {
            width: 100px;
            margin-left: 1rem;
        }

        .breadcrumb {
            background: #e5e7eb;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .breadcrumb a {
            color: #2563eb;
            text-decoration: none;
            cursor: pointer;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            align-items: end;
        }

        /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1rem;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .item-header, .delivery-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .item-actions {
                margin-top: 1rem;
            }
            
            .navigation {
                flex-direction: column;
                gap: 1rem;
            }

            .item-summary {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 1024px) {
            .form-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* åœ°å›³æ©Ÿèƒ½ã‚¹ã‚¿ã‚¤ãƒ« */
        .map-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            margin: 1rem 0;
        }
        
        .map-header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 16px 20px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .map-info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        #map {
            height: 400px;
            width: 100%;
            z-index: 1;
        }
        
        .selected-location-info {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }
        
        .selected-location-info.show {
            display: block;
        }
        
        .selected-location-info h4 {
            margin: 0 0 8px 0;
            color: #1e40af;
            font-weight: 600;
        }
        
        .selected-location-info p {
            margin: 0;
            color: #1e40af;
            font-size: 14px;
        }
        
        .clear-selection-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            float: right;
        }
        
        .clear-selection-btn:hover {
            background: #4b5563;
        }
        
        .loading-overlay {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ Leafletãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
        .leaflet-popup-content-wrapper {
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content {
            margin: 16px 20px;
            line-height: 1.4;
            min-width: 250px;
        }
        
        .popup-title {
            margin: 0 0 12px 0;
            color: #1e40af;
            font-size: 18px;
            font-weight: bold;
        }
        
        .popup-info {
            margin: 6px 0;
            font-size: 14px;
            color: #374151;
        }
        
        .popup-buttons {
            margin-top: 16px;
            display: flex;
            gap: 8px;
        }
        
        .popup-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-weight: 600;
        }
        
        .popup-button:hover {
            background: #2563eb;
        }
        
        .popup-button.select {
            background: #059669;
        }
        
        .popup-button.select:hover {
            background: #047857;
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-marker-icon {
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 3px 12px rgba(0,0,0,0.3);
        }
        
        .custom-marker-icon.main-office {
            background: #dc2626;
        }
        
        .custom-marker-icon.selected {
            background: #059669;
            transform: scale(1.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1.2); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1.2); }
        }
        
        .map-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #fee2e2;
            color: #dc2626;
            font-weight: 600;
            text-align: center;
            padding: 20px;
            border-radius: 8px;
        }

        .delivery-tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 20px;
            background-color: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            background-color: #007bff;
            color: white;
            border-bottom-color: #0056b3;
        }
        
        .tab-button:hover {
            background-color: #e9ecef;
        }
        
        .tab-button.active:hover {
            background-color: #0056b3;
        }

        .delivery-tab-content {
            display: none;
        }
        
        .delivery-tab-content.active {
            display: block;
        }

        /* QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆSafariæœ€é©åŒ–ç‰ˆï¼‰ */
        .qr-scan-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 240px;
            height: 240px;
            border: 2px dashed rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            pointer-events: none;
        }
        
        .qr-scan-corners {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 240px;
            height: 240px;
            pointer-events: none;
        }
        
        .qr-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #60a5fa;
        }
        
        .qr-corner-tl { top: -3px; left: -3px; border-right: none; border-bottom: none; }
        .qr-corner-tr { top: -3px; right: -3px; border-left: none; border-bottom: none; }
        .qr-corner-bl { bottom: -3px; left: -3px; border-right: none; border-top: none; }
        .qr-corner-br { bottom: -3px; right: -3px; border-left: none; border-top: none; }
        
        @keyframes qr-scanning {
            0% { background-position: 0% 0%; }
            100% { background-position: 0% 100%; }
        }
        
        @keyframes qr-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes qr-pulse-green {
            0%, 100% { background-color: #16a34a; }
            50% { background-color: #22c55e; }
        }
        
        .qr-scanning-line {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 240px;
            height: 240px;
            background: linear-gradient(180deg, transparent 0%, transparent 45%, #60a5fa 50%, transparent 55%, transparent 100%);
            background-size: 100% 200%;
            animation: qr-scanning 2s linear infinite;
            border-radius: 12px;
            pointer-events: none;
        }
        
        .qr-calibrating {
            animation: qr-pulse 1s ease-in-out infinite;
        }
        
        .qr-pulse-green {
            animation: qr-pulse-green 1s ease-in-out infinite;
        }
        
        .qr-video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .qr-debug-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-family: monospace;
            max-width: 200px;
        }
        
        .qr-status {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .qr-calibration-indicator {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }
        
        .qr-success-overlay {
            position: absolute;
            inset: 0;
            background: rgba(34, 197, 94, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
        }
        
        .qr-success-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .qr-error-overlay {
            position: absolute;
            inset: 0;
            background: rgba(239, 68, 68, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
        }
        
        .qr-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .qr-result-display {
            background: #f0fdf4;
            border: 2px solid #22c55e;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            display: none;
        }
        
        .qr-result-display.show {
            display: block;
        }
        
        .qr-result-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .qr-result-title {
            font-size: 18px;
            font-weight: 600;
            color: #15803d;
        }
        
        .qr-result-data {
            background: white;
            border: 1px solid #bbf7d0;
            border-radius: 6px;
            padding: 12px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸšš å‡ºè·æŒ‡ç¤ºç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  </h1>
    </div>

    <div class="container">
        <!-- å‡ºè·æŒ‡ç¤ºä¸€è¦§ç”»é¢ï¼ˆç´å…¥å ´æ‰€åˆ¥è¡¨ç¤ºï¼‰ -->
        <div id="shipping-screen" class="screen active">
            <div class="breadcrumb">
                ãƒ›ãƒ¼ãƒ  > å‡ºè·ç®¡ç† > <strong>å‡ºè·æŒ‡ç¤º</strong>
            </div>
            
            <h2>ğŸ“¦ å‡ºè·æŒ‡ç¤ºæ¤œç´¢</h2>
            
            <div class="search-section">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="ship-location">å‡ºè·å ´æ‰€</label>
                        <select id="ship-location">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="MAIN">æœ¬ç¤¾å€‰åº«</option>
                            <option value="SUB1">ç¬¬1å€‰åº«</option>
                            <option value="SUB2">ç¬¬2å€‰åº«</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="delivery-location">ç´å…¥å ´æ‰€</label>
                        <input type="text" id="delivery-location" placeholder="ä¾‹ï¼šæ±äº¬å–¶æ¥­æ‰€">
                    </div>
                    <div class="form-group">
                        <label for="scheduled-date">å‡ºè·äºˆå®šæ—¥</label>
                        <input type="date" id="scheduled-date">
                    </div>
                    <div class="form-group">
                        <label for="status">å‡ºè·æŒ‡ç¤º</label>
                        <select id="status">
                            <option value="PENDING">æœªæ¸ˆ</option>
                            <option value="COMPLETED">å®Œäº†</option>
                            <option value="ALL">ã™ã¹ã¦</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="searchShipments()">
                    ğŸ” æ¤œç´¢
                </button>
            </div>

            <!-- ç´å…¥å ´æ‰€åˆ¥è¡¨ç¤º -->
            <div class="delivery-locations" id="delivery-locations">
                <div class="delivery-card fade-in">
                    <div class="delivery-header">
                        <div class="delivery-info">
                            <h3>ğŸ¢ æ±äº¬å–¶æ¥­æ‰€</h3>
                            <div class="delivery-meta">
                                ä½æ‰€: æ±äº¬éƒ½åƒä»£ç”°åŒºä¸¸ã®å†…1-1-1 | TEL: 03-1234-5678<br>
                                æ‹…å½“è€…: ç”°ä¸­æ§˜ | å‡ºè·äºˆå®šæ—¥: 2024-08-27
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-info" onclick="goToDeliveryDetail('TOKYO')">
                                ğŸ“‹ ç´å…¥å ´æ‰€è©³ç´°
                            </button>
                        </div>
                    </div>
                    
                    <div class="item-summary">
                        <div class="summary-item">
                            <div class="summary-value">3</div>
                            <div class="summary-label">å“ç›®æ•°</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">250</div>
                            <div class="summary-label">åˆè¨ˆæ•°é‡</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value status-pending">æœªæ¸ˆ</div>
                            <div class="summary-label">çŠ¶æ³</div>
                        </div>
                    </div>
                </div>

                <div class="delivery-card fade-in">
                    <div class="delivery-header">
                        <div class="delivery-info">
                            <h3>ğŸ­ å¤§é˜ªå–¶æ¥­æ‰€</h3>
                            <div class="delivery-meta">
                                ä½æ‰€: å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—åŒºæ¢…ç”°2-2-2 | TEL: 06-7890-1234<br>
                                æ‹…å½“è€…: ä½è—¤æ§˜ | å‡ºè·äºˆå®šæ—¥: 2024-08-28
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-info" onclick="goToDeliveryDetail('OSAKA')">
                                ğŸ“‹ ç´å…¥å ´æ‰€è©³ç´°
                            </button>
                        </div>
                    </div>
                    
                    <div class="item-summary">
                        <div class="summary-item">
                            <div class="summary-value">2</div>
                            <div class="summary-label">å“ç›®æ•°</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">150</div>
                            <div class="summary-label">åˆè¨ˆæ•°é‡</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value status-completed">å®Œäº†</div>
                            <div class="summary-label">çŠ¶æ³</div>
                        </div>
                    </div>
                </div>

                <div class="delivery-card fade-in">
                    <div class="delivery-header">
                        <div class="delivery-info">
                            <h3>ğŸª åå¤å±‹å–¶æ¥­æ‰€</h3>
                            <div class="delivery-meta">
                                ä½æ‰€: æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­æ‘åŒºåé§…3-3-3 | TEL: 052-3456-7890<br>
                                æ‹…å½“è€…: éˆ´æœ¨æ§˜ | å‡ºè·äºˆå®šæ—¥: 2024-08-29
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-info" onclick="goToDeliveryDetail('NAGOYA')">
                                ğŸ“‹ ç´å…¥å ´æ‰€è©³ç´°
                            </button>
                        </div>
                    </div>
                    
                    <div class="item-summary">
                        <div class="summary-item">
                            <div class="summary-value">4</div>
                            <div class="summary-label">å“ç›®æ•°</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">320</div>
                            <div class="summary-label">åˆè¨ˆæ•°é‡</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value status-pending">æœªæ¸ˆ</div>
                            <div class="summary-label">çŠ¶æ³</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="pagination">
                <button class="btn btn-secondary">â¬… å‰ã¸</button>
                <div class="pagination-info">1 / 3 ãƒšãƒ¼ã‚¸</div>
                <button class="btn btn-secondary">æ¬¡ã¸ â¡</button>
            </div>
        </div>

        <!-- ç´å…¥å ´æ‰€è©³ç´°ç”»é¢ï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
        <div id="delivery-detail-screen" class="screen">
            <div class="breadcrumb">
                <a onclick="goToShipping()">å‡ºè·æŒ‡ç¤º</a> > <strong>ç´å…¥å ´æ‰€è©³ç´°</strong>
            </div>
            
            <h2>ğŸ¢ ç´å…¥å ´æ‰€è©³ç´° - <span id="delivery-name">æ±äº¬å–¶æ¥­æ‰€</span></h2>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="delivery-tabs">
                <button type="button" class="tab-button active" data-tab="info">é…é€å…ˆæƒ…å ±</button>
                <button type="button" class="tab-button" data-tab="map">åœ°å›³è¡¨ç¤º</button>
            </div>

            <!-- é…é€å…ˆæƒ…å ±ã‚¿ãƒ– -->
            <div class="delivery-tab-content active" id="info-content">
                <div class="delivery-card">
                    <div class="delivery-info">
                        <h3>ğŸ“ é…é€å…ˆæƒ…å ±</h3>
                        <div class="delivery-meta">
                            <strong>ä½æ‰€:</strong> æ±äº¬éƒ½åƒä»£ç”°åŒºä¸¸ã®å†…1-1-1<br>
                            <strong>é›»è©±ç•ªå·:</strong> 03-1234-5678<br>
                            <strong>æ‹…å½“è€…:</strong> ç”°ä¸­æ§˜<br>
                            <strong>å‡ºè·äºˆå®šæ—¥:</strong> 2024-08-27<br>
                            <strong>é…é€æ–¹æ³•:</strong> å®…é…ä¾¿
                        </div>
                    </div>
                </div>
            </div>

            <!-- åœ°å›³è¡¨ç¤ºã‚¿ãƒ– -->
            <div class="delivery-tab-content" id="map-content">
                <!-- é¸æŠã•ã‚ŒãŸå ´æ‰€ã®æƒ…å ± -->
                <div id="selectedLocationInfo" class="selected-location-info">
                    <button type="button" class="clear-selection-btn" onclick="DeliveryMap.clearLocationSelection()">ã‚¯ãƒªã‚¢</button>
                    <h4 id="selectedLocationTitle">é¸æŠã•ã‚ŒãŸå ´æ‰€</h4>
                    <p id="selectedLocationDetails">è©³ç´°æƒ…å ±</p>
                </div>
                
                <div class="map-section">
                    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                    <div class="loading-overlay" id="mapLoadingOverlay" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    
                    <div class="map-header">
                        <span>æ—¥æœ¬æ‹ ç‚¹åœ°å›³</span>
                        <span class="map-info" id="mapInfo">èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                    <div id="map"></div>
                </div>
            </div>
            
            <div class="item-list" id="delivery-item-list">
                <h3>ğŸ“¦ å‡ºè·å“ç›®ä¸€è¦§</h3>
                
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-info">
                            <div class="item-title">å“ç›®A-001 - ç‰¹æ®Šéƒ¨å“</div>
                            <div class="item-meta">å®¢å…ˆæ³¨ç•ª: ORD-2024-001 | å‡ºè·äºˆå®šæ•°: 100å€‹</div>
                            <div class="item-meta">å“ç›®é‡é‡: 0.5kg | æ¢±åŒ…ã‚µã‚¤ã‚º: 20x15x10cm</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-warning" onclick="goToPicking('A-001')">
                                ğŸ“‹ ãƒ”ãƒƒã‚­ãƒ³ã‚°
                            </button>
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="form-group">
                            <label for="tracking-1">é€ã‚ŠçŠ¶ç•ªå·</label>
                            <input type="text" id="tracking-1" placeholder="é€ã‚ŠçŠ¶ç•ªå·ã‚’å…¥åŠ›">
                        </div>
                        <button class="btn btn-success">
                            âœ… å‡ºè·æŒ‡ç¤º
                        </button>
                    </div>
                </div>

                <div class="item-card">
                    <div class="item-header">
                        <div class="item-info">
                            <div class="item-title">å“ç›®B-002 - æ¨™æº–éƒ¨å“</div>
                            <div class="item-meta">å®¢å…ˆæ³¨ç•ª: ORD-2024-002 | å‡ºè·äºˆå®šæ•°: 75å€‹</div>
                            <div class="item-meta">å“ç›®é‡é‡: 0.3kg | æ¢±åŒ…ã‚µã‚¤ã‚º: 15x10x8cm</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-warning" onclick="goToPicking('B-002')">
                                ğŸ“‹ ãƒ”ãƒƒã‚­ãƒ³ã‚°
                            </button>
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="form-group">
                            <label for="tracking-2">é€ã‚ŠçŠ¶ç•ªå·</label>
                            <input type="text" id="tracking-2" placeholder="é€ã‚ŠçŠ¶ç•ªå·ã‚’å…¥åŠ›">
                        </div>
                        <button class="btn btn-success">
                            âœ… å‡ºè·æŒ‡ç¤º
                        </button>
                    </div>
                </div>

                <div class="item-card">
                    <div class="item-header">
                        <div class="item-info">
                            <div class="item-title">å“ç›®C-003 - æ¶ˆè€—å“</div>
                            <div class="item-meta">å®¢å…ˆæ³¨ç•ª: ORD-2024-003 | å‡ºè·äºˆå®šæ•°: 75å€‹</div>
                            <div class="item-meta">å“ç›®é‡é‡: 0.1kg | æ¢±åŒ…ã‚µã‚¤ã‚º: 10x8x5cm</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-warning" onclick="goToPicking('C-003')">
                                ğŸ“‹ ãƒ”ãƒƒã‚­ãƒ³ã‚°
                            </button>
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="form-group">
                            <label for="tracking-3">é€ã‚ŠçŠ¶ç•ªå·</label>
                            <input type="text" id="tracking-3" placeholder="é€ã‚ŠçŠ¶ç•ªå·ã‚’å…¥åŠ›">
                        </div>
                        <button class="btn btn-success">
                            âœ… å‡ºè·æŒ‡ç¤º
                        </button>
                    </div>
                </div>
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToShipping()">
                    â¬… å‡ºè·æŒ‡ç¤ºä¸€è¦§ã«æˆ»ã‚‹
                </button>
                <div class="item-summary">
                    <div class="summary-item">
                        <div class="summary-value">3</div>
                        <div class="summary-label">å“ç›®æ•°</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">250</div>
                        <div class="summary-label">åˆè¨ˆæ•°é‡</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ”ãƒƒã‚­ãƒ³ã‚°ç”»é¢ -->
        <div id="picking-screen" class="screen">
            <div class="breadcrumb">
                <a onclick="goToShipping()">å‡ºè·æŒ‡ç¤º</a> > 
                <a onclick="goToDeliveryDetail()">ç´å…¥å ´æ‰€è©³ç´°</a> >
                <strong>ãƒ”ãƒƒã‚­ãƒ³ã‚°</strong>
            </div>
            
            <h2>ğŸ“‹ ãƒ”ãƒƒã‚­ãƒ³ã‚°ä½œæ¥­</h2>
            
            <div class="item-card">
                <div class="item-title">å“ç›®A-001 - ç‰¹æ®Šéƒ¨å“</div>
                <div class="item-meta">å®¢å…ˆæ³¨ç•ª: ORD-2024-001 | å‡ºè·æŒ‡ç¤ºæ•°: 100å€‹</div>
                <div class="item-meta">ç´å…¥å ´æ‰€: æ±äº¬å–¶æ¥­æ‰€ | å‡ºè·äºˆå®šæ—¥: 2024-08-27</div>
                <div style="margin: 1rem 0;">
                    <button class="btn btn-warning" onclick="goToVerification()">
                        ğŸ” ç…§åˆ
                    </button>
                    <button class="btn btn-success" onclick="savePicking()">
                        ğŸ’¾ ä¿å­˜
                    </button>
                </div>
            </div>

            <div class="picked-items" id="picked-items">
                <h3>ğŸ“¦ ãƒ”ãƒƒã‚­ãƒ³ã‚°æ¸ˆã¿å“ç›®</h3>
                <div class="picked-item">
                    <div>
                        <strong>è£½å“æœ¬ä½“: LOT-2024-001</strong><br>
                        ä¿ç®¡å€‰åº«: æœ¬ç¤¾å€‰åº« (A-01)
                    </div>
                    <div>
                        <input type="number" class="qty-input" value="30" min="0" max="30">
                        <span>/ 30å€‹</span>
                    </div>
                </div>
                <div class="picked-item">
                    <div>
                        <strong>è£½å“ãƒãƒ‹ãƒ¥ã‚¢ãƒ«: LOT-2024-002</strong><br>
                        ä¿ç®¡å€‰åº«: æœ¬ç¤¾å€‰åº« (A-02)
                    </div>
                    <div>
                        <input type="number" class="qty-input" value="70" min="0" max="70">
                        <span>/ 70å€‹</span>
                    </div>
                </div>
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToDeliveryDetail()">
                    â¬… ç´å…¥å ´æ‰€è©³ç´°ã«æˆ»ã‚‹
                </button>
                <div>
                    åˆè¨ˆ: <strong>100å€‹</strong> / 100å€‹
                </div>
            </div>
        </div>

        <!-- ç…§åˆç”»é¢ -->
        <div id="verification-screen" class="screen">
            <div class="breadcrumb">
                <a onclick="goToShipping()">å‡ºè·æŒ‡ç¤º</a> > 
                <a onclick="goToDeliveryDetail()">ç´å…¥å ´æ‰€è©³ç´°</a> >
                <a onclick="goToPicking()">ãƒ”ãƒƒã‚­ãƒ³ã‚°</a> > 
                <strong>ç…§åˆ</strong>
            </div>
            
            <h2>ğŸ” åœ¨åº«ç…§åˆï¼ˆSafariæœ€é©åŒ–QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ï¼‰</h2>
            
            <!-- QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼è¨­å®šãƒ‘ãƒãƒ« -->
            <div class="search-section">
                <h3>ğŸ”§ ã‚¹ã‚­ãƒ£ãƒ³è¨­å®š</h3>
                <div class="form-grid">
                    <label class="flex items-center gap-3">
                        <input type="checkbox" id="auto-verify-inventory" checked>
                        <span>åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã¨è‡ªå‹•ç…§åˆ</span>
                    </label>
                    <label class="flex items-center gap-3">
                        <input type="checkbox" id="enable-debug-mode">
                        <span>ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰</span>
                    </label>
                    <div class="form-group">
                        <label for="scan-timeout">ã‚¹ã‚­ãƒ£ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰</label>
                        <select id="scan-timeout">
                            <option value="30">30ç§’</option>
                            <option value="60" selected>60ç§’</option>
                            <option value="120">120ç§’</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
            <div id="qr-scanner-main" class="camera-section">
                <!-- åˆæœŸç”»é¢ -->
                <div id="qr-initial-screen">
                    <h3>ğŸ“± QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆåœ¨åº«ç…§åˆï¼‰</h3>
                    <div class="qr-controls">
                        <button id="start-qr-scan" class="btn">
                            ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
                        </button>
                        <button id="manual-lot-input" class="btn btn-secondary">
                            âŒ¨ æ‰‹å‹•å…¥åŠ›
                        </button>
                    </div>
                    
                </div>

                <!-- ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ -->
                <div id="qr-camera-screen" class="hidden">
                    <div class="qr-video-container">
                        <video id="qr-camera-video" class="qr-video" playsinline muted webkit-playsinline></video>
                        <div class="qr-scan-guide"></div>
                        <div class="qr-scan-corners">
                            <div class="qr-corner qr-corner-tl"></div>
                            <div class="qr-corner qr-corner-tr"></div>
                            <div class="qr-corner qr-corner-bl"></div>
                            <div class="qr-corner qr-corner-br"></div>
                        </div>
                        <div id="qr-scanning-animation" class="qr-scanning-line hidden"></div>
                        
                        <!-- ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º -->
                        <div id="qr-calibration-indicator" class="qr-calibration-indicator hidden">
                            <div>
                                <div style="font-size: 24px; margin-bottom: 8px;">âš™ï¸</div>
                                <div>ã‚«ãƒ¡ãƒ©ã‚’èª¿æ•´ä¸­...</div>
                                <div style="font-size: 12px; margin-top: 4px;">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</div>
                            </div>
                        </div>
                        
                        <!-- æˆåŠŸè¡¨ç¤º -->
                        <div id="qr-success-overlay" class="qr-success-overlay hidden">
                            <div class="qr-success-icon">âœ…</div>
                            <div>QRã‚³ãƒ¼ãƒ‰æ¤œå‡ºæˆåŠŸ!</div>
                        </div>
                        
                        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
                        <div id="qr-error-overlay" class="qr-error-overlay hidden">
                            <div style="font-size: 32px; margin-bottom: 12px;">âŒ</div>
                            <div id="qr-error-message">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>
                        </div>
                        
                        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
                        <div id="qr-debug-info" class="qr-debug-info hidden">
                            <div>Status: <span id="debug-status">Ready</span></div>
                            <div>Stream: <span id="debug-stream">Disconnected</span></div>
                            <div>Detection: <span id="debug-detection">Stopped</span></div>
                            <div>Frames: <span id="debug-frames">0</span></div>
                        </div>
                        
                        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                        <div id="qr-scan-status" class="qr-status">
                            ã‚«ãƒ¡ãƒ©ã‚’æº–å‚™ä¸­...
                        </div>
                    </div>
                    
                    <div class="qr-controls">
                        <button id="stop-qr-scan" class="btn btn-secondary">
                            ğŸ›‘ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢
                        </button>
                        <button id="calibrate-qr-camera" class="btn btn-info">
                            âš™ï¸ ã‚«ãƒ¡ãƒ©èª¿æ•´
                        </button>
                        <button id="toggle-qr-debug" class="btn btn-warning">
                            ğŸ”§ ãƒ‡ãƒãƒƒã‚°
                        </button>
                    </div>
                </div>

                <!-- çµæœè¡¨ç¤º -->
                <div id="qr-result-display" class="qr-result-display">
                    <div class="qr-result-header">
                        <div class="qr-result-title">ğŸ“¦ ã‚¹ã‚­ãƒ£ãƒ³çµæœ</div>
                        <button id="clear-qr-result" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;">
                            ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                    <div id="qr-result-data" class="qr-result-data">
                        ã‚¹ã‚­ãƒ£ãƒ³çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                    <div style="margin-top: 12px;">
                        <strong>ç…§åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span id="verification-status">å¾…æ©Ÿä¸­</span>
                    </div>
                </div>
            </div>

            <div class="item-list" id="verified-items">
                <h3>âœ… ç…§åˆæ¸ˆã¿å“ç›®</h3>
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-info">
                            <div class="item-title">è£½å“æœ¬ä½“: LOT-2024-001</div>
                            <div class="item-meta">å“ç›®A-001 - ç‰¹æ®Šéƒ¨å“</div>
                            <div class="item-meta">ä¿ç®¡å€‰åº«: æœ¬ç¤¾å€‰åº« (A-01) | åœ¨åº«æ•°: 30å€‹</div>
                            <div class="status-badge status-completed">ç…§åˆå®Œäº†</div>
                        </div>
                    </div>
                </div>
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-info">
                            <div class="item-title">è£½å“ãƒãƒ‹ãƒ¥ã‚¢ãƒ«: LOT-2024-002</div>
                            <div class="item-meta">å“ç›®A-001 - ç‰¹æ®Šéƒ¨å“</div>
                            <div class="item-meta">ä¿ç®¡å€‰åº«: æœ¬ç¤¾å€‰åº« (A-02) | åœ¨åº«æ•°: 70å€‹</div>
                            <div class="status-badge status-completed">ç…§åˆå®Œäº†</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPicking()">
                    â¬… ãƒ”ãƒƒã‚­ãƒ³ã‚°ã«æˆ»ã‚‹
                </button>
                <button class="btn btn-success">
                    ğŸ’¾ ç…§åˆçµæœä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <script>
        // ç¾åœ¨ã®ç´å…¥å ´æ‰€
        let currentDeliveryLocation = '';
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            document.getElementById(screenId).classList.add('fade-in');
        }

        function goToShipping() {
            showScreen('shipping-screen');
        }

        function goToDeliveryDetail(locationCode = '') {
            if (locationCode) {
                currentDeliveryLocation = locationCode;
            }
            
            // ç´å…¥å ´æ‰€åã‚’è¨­å®š
            const locationNames = {
                'TOKYO': 'æ±äº¬å–¶æ¥­æ‰€',
                'OSAKA': 'å¤§é˜ªå–¶æ¥­æ‰€',
                'NAGOYA': 'åå¤å±‹å–¶æ¥­æ‰€'
            };
            
            const deliveryName = document.getElementById('delivery-name');
            if (deliveryName && locationNames[currentDeliveryLocation]) {
                deliveryName.textContent = locationNames[currentDeliveryLocation];
            }
            
            showScreen('delivery-detail-screen');
        }

        function goToPicking(itemCode = '') {
            showScreen('picking-screen');
        }

        function goToVerification() {
            showScreen('verification-screen');
        }

        function searchShipments() {
            // IDOé€£æºã§ã®æ¤œç´¢å‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            console.log('SyteLine IDOã‹ã‚‰å‡ºè·æŒ‡ç¤ºãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ä¸­...');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const deliveryLocations = document.getElementById('delivery-locations');
            deliveryLocations.innerHTML = '<div style="text-align: center; padding: 2rem;">ğŸ” æ¤œç´¢ä¸­...</div>';
            
            // æ¤œç´¢çµæœã‚’æ¨¡æ“¬çš„ã«è¡¨ç¤º
            setTimeout(() => {
                location.reload(); // å®Ÿéš›ã®å®Ÿè£…ã§ã¯æ¤œç´¢çµæœã‚’å‹•çš„ã«æ›´æ–°
            }, 1500);
        }

        function startCamera() {
            // æ–°ã—ã„QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚¯ãƒ©ã‚¹ã§å‡¦ç†
            if (window.inventoryQRScanner) {
                window.inventoryQRScanner.startScan();
            }
        }

        function manualInput() {
            const lotNumber = prompt('ãƒ­ãƒƒãƒˆç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (lotNumber) {
                if (window.inventoryQRScanner) {
                    window.inventoryQRScanner.handleManualInput(lotNumber);
                } else {
                    alert(`ãƒ­ãƒƒãƒˆç•ªå· "${lotNumber}" ã§åœ¨åº«ã‚’ç…§åˆã—ã¾ã™ã€‚\n\nSyteLineåœ¨åº«ç®¡ç†IDOã¨é€£æºã—ã¦ç…§åˆå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`);
                }
            }
        }

        function savePicking() {
            alert('ãƒ”ãƒƒã‚­ãƒ³ã‚°æƒ…å ±ã‚’SyteLineå‡ºè·æŒ‡ç¤ºIDOã«ä¿å­˜ã—ã¾ã—ãŸã€‚\n\nãƒ»ãƒ”ãƒƒã‚­ãƒ³ã‚°è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°\nãƒ»åœ¨åº«æ•°é‡ã®å¼•å½“å‡¦ç†\nãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°');
        }

        // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®åˆæœŸåŒ–
        window.addEventListener('load', function() {
            // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ
            if ('ontouchstart' in window) {
                document.body.classList.add('touch-device');
            }
            
            // ç¾åœ¨ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«è¨­å®š
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('scheduled-date').value = today;
            
            // PWAå¯¾å¿œã®åˆæœŸåŒ–
            initializePWA();
        });

        // PWAåˆæœŸåŒ–
        function initializePWA() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => console.log('SW registered:', registration))
                    .catch(error => console.log('SW registration failed:', error));
            }
            
            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
            window.addEventListener('online', () => {
                console.log('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸ');
                syncOfflineData();
            });
            
            window.addEventListener('offline', () => {
                console.log('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã—ãŸ');
            });
        }

        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿åŒæœŸ
        function syncOfflineData() {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åŒæœŸ
            console.log('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’SyteLineã¨åŒæœŸä¸­...');
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
        window.addEventListener('load', () => {
            if ('performance' in window) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log(`Page load time: ${loadTime}ms`);
            }
        });
    </script>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        // é…é€åœ°å›³ç®¡ç†ã‚¯ãƒ©ã‚¹ (shipping_search_with_map.htmlã®å®Ÿè£…ã‚’å‚è€ƒ)
        var DeliveryMap = {
            
            // Leafleté–¢é€£
            map: null,
            markers: [],
            selectedLocation: null,
            selectedMarker: null,
            
            // å–¶æ¥­æ‰€ãƒ‡ãƒ¼ã‚¿ï¼ˆshipping_search_with_map.htmlã‹ã‚‰ï¼‰
            branchLocations: [
                {
                    name: "æ±äº¬å–¶æ¥­æ‰€",
                    code: "TKY001",
                    address: "æ±äº¬éƒ½æ¸¯åŒºèµ¤å‚1-1-1",
                    phone: "03-1234-5678",
                    type: "main_office",
                    capacity: 1000,
                    coordinates: [35.6762, 139.7380]
                },
                {
                    name: "ç›¸æ¨¡å–¶æ¥­æ‰€",
                    code: "SGM001",
                    address: "ç¥å¥ˆå·çœŒç›¸æ¨¡åŸå¸‚ä¸­å¤®åŒºç›¸æ¨¡åŸ1-1-1",
                    phone: "042-123-4567",
                    type: "branch",
                    capacity: 500,
                    coordinates: [35.5756, 139.3697]
                },
                {
                    name: "å¤§é˜ªå–¶æ¥­æ‰€",
                    code: "OSK001",
                    address: "å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—åŒºæ¢…ç”°1-1-1",
                    phone: "06-1234-5678",
                    type: "branch",
                    capacity: 800,
                    coordinates: [34.7024, 135.4960]
                },
                {
                    name: "åå¤å±‹å–¶æ¥­æ‰€",
                    code: "NGY001",
                    address: "æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­æ‘åŒºåé§…1-1-1",
                    phone: "052-123-4567",
                    type: "branch",
                    capacity: 600,
                    coordinates: [35.1709, 136.8816]
                },
                {
                    name: "ç¦å²¡å–¶æ¥­æ‰€",
                    code: "FUK001",
                    address: "ç¦å²¡çœŒç¦å²¡å¸‚åšå¤šåŒºåšå¤šé§…å‰1-1-1",
                    phone: "092-123-4567",
                    type: "branch",
                    capacity: 400,
                    coordinates: [33.5904, 130.4017]
                }
            ],
            
            // åˆæœŸåŒ–
            init: function() {
                console.log('Delivery Map initialized');
                this.waitForLeaflet();
            },
            
            // Leafletèª­ã¿è¾¼ã¿å¾…æ©Ÿ
            waitForLeaflet: function() {
                var self = this;
                var checkInterval = setInterval(function() {
                    if (typeof L !== 'undefined') {
                        clearInterval(checkInterval);
                        self.initializeMap();
                    }
                }, 100);
                
                // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                setTimeout(function() {
                    if (typeof L === 'undefined') {
                        clearInterval(checkInterval);
                        self.handleMapError('Leafletãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }, 10000);
            },
            
            // Leafletåœ°å›³åˆæœŸåŒ–
            initializeMap: function() {
                try {
                    document.getElementById('mapLoadingOverlay').style.display = 'flex';
                    document.getElementById('mapInfo').textContent = 'åœ°å›³ã‚’åˆæœŸåŒ–ä¸­...';
                    
                    // æ—¥æœ¬ä¸­å¿ƒã®åœ°å›³ã‚’ä½œæˆ
                    this.map = L.map('map', {
                        center: [36.2048, 138.2529], // æ—¥æœ¬ã®ä¸­å¿ƒéƒ¨
                        zoom: 6,
                        zoomControl: true,
                        scrollWheelZoom: true,
                        doubleClickZoom: true,
                        dragging: true,
                        touchZoom: true,
                        boxZoom: true,
                        keyboard: true
                    });
                    
                    // OpenStreetMapã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 18,
                        minZoom: 3
                    }).addTo(this.map);
                    
                    // åœ°å›³ãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«ãƒãƒ¼ã‚«ãƒ¼ã‚’é…ç½®
                    this.map.whenReady(() => {
                        this.loadBranchMarkers();
                        document.getElementById('mapLoadingOverlay').style.display = 'none';
                        document.getElementById('mapInfo').textContent = 'å–¶æ¥­æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ';
                        console.log('Map initialized successfully');
                    });
                    
                } catch (error) {
                    console.error('Map initialization error:', error);
                    this.handleMapError('åœ°å›³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            },
            
            // åœ°å›³ã‚¨ãƒ©ãƒ¼å‡¦ç†
            handleMapError: function(message) {
                document.getElementById('map').innerHTML = '<div class="map-error">' + message + '<br>ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„</div>';
                document.getElementById('mapLoadingOverlay').style.display = 'none';
                document.getElementById('mapInfo').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            },
            
            // å–¶æ¥­æ‰€ãƒãƒ¼ã‚«ãƒ¼èª­ã¿è¾¼ã¿
            loadBranchMarkers: function() {
                var self = this;
                
                this.branchLocations.forEach(function(location) {
                    var lat = location.coordinates[0];
                    var lng = location.coordinates[1];
                    
                    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆ
                    var iconClass = location.type === 'main_office' ? 'main-office' : 'branch';
                    var iconSize = location.type === 'main_office' ? [24, 24] : [20, 20];
                    
                    var customIcon = L.divIcon({
                        className: 'custom-marker-icon ' + iconClass,
                        iconSize: iconSize,
                        iconAnchor: [iconSize[0]/2, iconSize[1]/2]
                    });
                    
                    var marker = L.marker([lat, lng], { icon: customIcon }).addTo(self.map);
                    
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…å®¹ã‚’ä½œæˆ
                    var popupContent = self.createPopupContent(location);
                    marker.bindPopup(popupContent);
                    
                    // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                    marker.on('click', function() {
                        self.selectLocation(location, marker);
                    });
                    
                    // ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
                    self.markers.push({
                        marker: marker,
                        location: location
                    });
                });
                
                console.log('Loaded', this.markers.length, 'markers');
            },
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…å®¹ä½œæˆ
            createPopupContent: function(location) {
                var typeText = location.type === 'main_office' ? 'æœ¬ç¤¾' : 'æ”¯ç¤¾';
                
                return `
                    <div>
                        <h3 class="popup-title">${location.name}</h3>
                        <p class="popup-info"><strong>ã‚³ãƒ¼ãƒ‰:</strong> ${location.code}</p>
                        <p class="popup-info"><strong>ä½æ‰€:</strong> ${location.address}</p>
                        <p class="popup-info"><strong>é›»è©±:</strong> ${location.phone}</p>
                        <p class="popup-info"><strong>å‡¦ç†èƒ½åŠ›:</strong> ${location.capacity}ä»¶/æ—¥</p>
                        <p class="popup-info"><strong>ã‚¿ã‚¤ãƒ—:</strong> ${typeText}</p>
                        <div class="popup-buttons">
                            <button class="popup-button select" onclick="DeliveryMap.selectFromPopup('${location.code}')">
                                é…é€å…ˆã«é¸æŠ
                            </button>
                        </div>
                    </div>
                `;
            },
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰é¸æŠ
            selectFromPopup: function(locationCode) {
                var locationData = this.branchLocations.find(function(loc) {
                    return loc.code === locationCode;
                });
                
                var markerData = this.markers.find(function(item) {
                    return item.location.code === locationCode;
                });
                
                if (locationData && markerData) {
                    this.selectLocation(locationData, markerData.marker);
                    this.map.closePopup();
                }
            },
            
            // å ´æ‰€é¸æŠ
            selectLocation: function(location, marker) {
                console.log('Location selected:', location.name);
                
                // å‰å›é¸æŠã‚’ã‚¯ãƒªã‚¢
                this.clearLocationSelection();
                
                // æ–°ã—ã„é¸æŠã‚’è¨­å®š
                this.selectedLocation = location;
                this.selectedMarker = marker;
                
                // ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                var iconClass = location.type === 'main_office' ? 'main-office selected' : 'branch selected';
                var iconSize = location.type === 'main_office' ? [30, 30] : [26, 26];
                
                var selectedIcon = L.divIcon({
                    className: 'custom-marker-icon ' + iconClass,
                    iconSize: iconSize,
                    iconAnchor: [iconSize[0]/2, iconSize[1]/2]
                });
                
                marker.setIcon(selectedIcon);
                
                // åœ°å›³ã‚’ä¸­å¤®ã«ç§»å‹•ãƒ»ã‚ºãƒ¼ãƒ 
                this.map.setView([location.coordinates[0], location.coordinates[1]], 10);
                
                // é¸æŠæƒ…å ±è¡¨ç¤º
                this.showSelectedLocationInfo(location);
                
                // é…é€å…ˆæƒ…å ±ã‚‚æ›´æ–°
                this.updateDeliveryInfo(location);
            },
            
            // é¸æŠã•ã‚ŒãŸå ´æ‰€ã®æƒ…å ±è¡¨ç¤º
            showSelectedLocationInfo: function(location) {
                var infoDiv = document.getElementById('selectedLocationInfo');
                var titleElement = document.getElementById('selectedLocationTitle');
                var detailsElement = document.getElementById('selectedLocationDetails');
                
                titleElement.textContent = 'é¸æŠä¸­: ' + location.name;
                detailsElement.innerHTML = `
                    <strong>ã‚³ãƒ¼ãƒ‰:</strong> ${location.code}<br>
                    <strong>ä½æ‰€:</strong> ${location.address}<br>
                    <strong>é›»è©±:</strong> ${location.phone}<br>
                    <strong>å‡¦ç†èƒ½åŠ›:</strong> ${location.capacity}ä»¶/æ—¥
                `;
                
                infoDiv.classList.add('show');
            },
            
            // é…é€å…ˆæƒ…å ±ã‚’æ›´æ–°
            updateDeliveryInfo: function(location) {
                var deliveryNameElement = document.getElementById('delivery-name');
                if (deliveryNameElement) {
                    deliveryNameElement.textContent = location.name;
                }
                
                // é…é€å…ˆæƒ…å ±ã‚¿ãƒ–ã®å†…å®¹ã‚‚æ›´æ–°
                var deliveryMetaElements = document.querySelectorAll('.delivery-meta');
                deliveryMetaElements.forEach(function(element) {
                    element.innerHTML = `
                        <strong>ä½æ‰€:</strong> ${location.address}<br>
                        <strong>é›»è©±ç•ªå·:</strong> ${location.phone}<br>
                        <strong>æ‹…å½“è€…:</strong> å–¶æ¥­æ‰€ã‚¹ã‚¿ãƒƒãƒ•<br>
                        <strong>å‡ºè·äºˆå®šæ—¥:</strong> 2024-08-27<br>
                        <strong>é…é€æ–¹æ³•:</strong> å®…é…ä¾¿
                    `;
                });
            },
            
            // å ´æ‰€é¸æŠã‚¯ãƒªã‚¢
            clearLocationSelection: function() {
                if (this.selectedLocation && this.selectedMarker) {
                    // ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’å…ƒã«æˆ»ã™
                    var iconClass = this.selectedLocation.type === 'main_office' ? 'main-office' : 'branch';
                    var iconSize = this.selectedLocation.type === 'main_office' ? [24, 24] : [20, 20];
                    
                    var originalIcon = L.divIcon({
                        className: 'custom-marker-icon ' + iconClass,
                        iconSize: iconSize,
                        iconAnchor: [iconSize[0]/2, iconSize[1]/2]
                    });
                    
                    this.selectedMarker.setIcon(originalIcon);
                }
                
                this.selectedLocation = null;
                this.selectedMarker = null;
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
                if (this.map) {
                    this.map.closePopup();
                }
                
                // é¸æŠæƒ…å ±éè¡¨ç¤º
                document.getElementById('selectedLocationInfo').classList.remove('show');
                
                // åœ°å›³ã‚’æ—¥æœ¬å…¨ä½“ã«æˆ»ã™
                if (this.map) {
                    this.map.setView([36.2048, 138.2529], 6);
                }
            }
        };
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’è¿½åŠ 
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.delivery-tab-content');
            
            // ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(targetTab + '-content').classList.add('active');
                    
                    // åœ°å›³ã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€åœ°å›³ã‚’åˆæœŸåŒ–
                    if (targetTab === 'map' && !DeliveryMap.map) {
                        DeliveryMap.init();
                    }
                });
            });
        });
    </script>

    <!-- åœ¨åº«ç…§åˆç”¨QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚¯ãƒ©ã‚¹ï¼ˆSafariæœ€é©åŒ–ç‰ˆï¼‰ -->
    <script>
        class InventoryQRScanner {
            constructor() {
                this.video = document.getElementById('qr-camera-video');
                this.stream = null;
                this.isScanning = false;
                this.qrScanner = null;
                this.currentCamera = 'environment';
                this.cameras = [];
                this.calibrationAttempts = 0;
                this.maxCalibrationAttempts = 3;
                this.frameCount = 0;
                this.lastDetectionAttempt = 0;
                this.isCalibrating = false;
                this.debugMode = false;
                this.scanTimeout = null;
                
                // åœ¨åº«ç…§åˆç”¨ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
                this.expectedItems = [
                    { lotNumber: 'LOT-2024-001', itemCode: 'A-001', name: 'ç‰¹æ®Šéƒ¨å“', location: 'A-01' },
                    { lotNumber: 'LOT-2024-002', itemCode: 'A-001', name: 'ç‰¹æ®Šéƒ¨å“ãƒãƒ‹ãƒ¥ã‚¢ãƒ«', location: 'A-02' },
                    { lotNumber: 'LOT-2024-003', itemCode: 'B-002', name: 'æ¨™æº–éƒ¨å“', location: 'B-01' },
                    { lotNumber: 'LOT-2024-004', itemCode: 'C-003', name: 'æ¶ˆè€—å“', location: 'C-01' }
                ];
                this.verifiedItems = [];
                
                this.initElements();
                this.initEventListeners();
                this.initPageLifecycleHandling();
                this.detectCameras();
            }

            initElements() {
                this.initialScreen = document.getElementById('qr-initial-screen');
                this.cameraScreen = document.getElementById('qr-camera-screen');
                this.resultDisplay = document.getElementById('qr-result-display');
                this.scanStatus = document.getElementById('qr-scan-status');
                this.resultData = document.getElementById('qr-result-data');
                this.verificationStatus = document.getElementById('verification-status');
                this.scanningAnimation = document.getElementById('qr-scanning-animation');
                this.calibrationIndicator = document.getElementById('qr-calibration-indicator');
                this.successOverlay = document.getElementById('qr-success-overlay');
                this.errorOverlay = document.getElementById('qr-error-overlay');
                this.errorMessage = document.getElementById('qr-error-message');
                this.debugInfo = document.getElementById('qr-debug-info');
                this.debugElements = {
                    status: document.getElementById('debug-status'),
                    stream: document.getElementById('debug-stream'),
                    detection: document.getElementById('debug-detection'),
                    frames: document.getElementById('debug-frames')
                };
                
                // è¨­å®šè¦ç´ 
                this.autoVerifyInventory = document.getElementById('auto-verify-inventory');
                this.enableDebugMode = document.getElementById('enable-debug-mode');
                this.scanTimeoutSelect = document.getElementById('scan-timeout');
            }

            initEventListeners() {
                document.getElementById('start-qr-scan').addEventListener('click', () => this.startScan());
                document.getElementById('stop-qr-scan').addEventListener('click', () => this.stopScan());
                document.getElementById('calibrate-qr-camera').addEventListener('click', () => this.calibrateCamera());
                document.getElementById('toggle-qr-debug').addEventListener('click', () => this.toggleDebug());
                document.getElementById('clear-qr-result').addEventListener('click', () => this.clearResult());
                document.getElementById('manual-lot-input').addEventListener('click', () => this.showManualInput());
                
                // è¨­å®šå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
                this.enableDebugMode.addEventListener('change', (e) => {
                    this.debugMode = e.target.checked;
                    this.debugInfo.classList.toggle('hidden', !this.debugMode);
                });
            }

            // ãƒšãƒ¼ã‚¸ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†ï¼ˆSafariæœ€é©åŒ–ï¼‰
            initPageLifecycleHandling() {
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pauseScanning();
                    } else {
                        this.resumeScanning();
                    }
                });

                window.addEventListener('beforeunload', () => {
                    this.cleanupResources();
                });

                window.addEventListener('pagehide', () => {
                    this.cleanupResources();
                });

                window.addEventListener('pageshow', (event) => {
                    if (event.persisted) {
                        this.resetScanner();
                    }
                });
            }

            async detectCameras() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.cameras = devices.filter(device => device.kind === 'videoinput');
                    this.updateDebug('status', `${this.cameras.length} cameras found`);
                } catch (error) {
                    console.warn('ã‚«ãƒ¡ãƒ©æ¤œå‡ºã‚¨ãƒ©ãƒ¼:', error);
                    this.updateDebug('status', 'Camera detection failed');
                }
            }

            showScreen(screenName) {
                this.initialScreen.classList.add('hidden');
                this.cameraScreen.classList.add('hidden');
                
                if (screenName === 'initial') {
                    this.initialScreen.classList.remove('hidden');
                } else if (screenName === 'camera') {
                    this.cameraScreen.classList.remove('hidden');
                }
            }

            updateStatus(message) {
                this.scanStatus.textContent = message;
            }

            updateDebug(type, value) {
                if (this.debugElements[type]) {
                    this.debugElements[type].textContent = value;
                }
            }

            toggleDebug() {
                this.debugMode = !this.debugMode;
                this.debugInfo.classList.toggle('hidden', !this.debugMode);
                this.enableDebugMode.checked = this.debugMode;
            }

            // Safariæœ€é©åŒ–: æ®µéšçš„ãªã‚«ãƒ¡ãƒ©åˆæœŸåŒ–
            async startScan() {
                try {
                    this.showScreen('camera');
                    this.hideAllOverlays();
                    await this.initializeCamera();
                    this.setupScanTimeout();
                } catch (error) {
                    this.handleError(error);
                }
            }

            async initializeCamera() {
                const constraints = {
                    video: {
                        facingMode: this.currentCamera,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                this.video.srcObject = this.stream;
                this.updateDebug('stream', 'Connected');

                this.video.setAttribute('playsinline', true);
                this.video.setAttribute('webkit-playsinline', true);
                this.video.muted = true;

                await this.waitForVideoReady();
                
                this.isScanning = true;
                await this.calibrateCamera();
            }

            async waitForVideoReady() {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Video initialization timeout'));
                    }, 10000);

                    const checkReady = () => {
                        if (this.video.readyState === 4 && this.video.videoWidth > 0) {
                            clearTimeout(timeout);
                            this.updateDebug('status', 'Video ready');
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });
            }

            async calibrateCamera() {
                if (this.isCalibrating || this.calibrationAttempts >= this.maxCalibrationAttempts) {
                    return;
                }

                this.isCalibrating = true;
                this.calibrationAttempts++;
                
                this.calibrationIndicator.classList.remove('hidden');
                this.updateStatus(`ã‚«ãƒ¡ãƒ©èª¿æ•´ä¸­... (${this.calibrationAttempts}/${this.maxCalibrationAttempts})`);

                await new Promise(resolve => setTimeout(resolve, 2000));

                this.calibrationIndicator.classList.add('hidden');
                this.isCalibrating = false;

                if (this.video.readyState === 4 && this.video.videoWidth > 0) {
                    this.startQRDetection();
                } else {
                    setTimeout(() => this.calibrateCamera(), 1000);
                }
            }

            async startQRDetection() {
                this.updateStatus('åœ¨åº«QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...');
                this.scanningAnimation.classList.remove('hidden');
                this.updateDebug('detection', 'Starting');
                
                if (typeof QrScanner !== 'undefined') {
                    try {
                        this.qrScanner = new QrScanner(
                            this.video,
                            result => this.handleQRResult(result.data),
                            {
                                returnDetailedScanResult: true,
                                highlightScanRegion: false,
                                highlightCodeOutline: false,
                                maxScansPerSecond: 10,
                                calculateScanRegion: this.calculateScanRegion.bind(this)
                            }
                        );
                        
                        await this.qrScanner.start();
                        this.updateDebug('detection', 'QrScanner active');
                        this.startFrameCounter();
                        
                    } catch (error) {
                        console.warn('QR Scanner failed, using fallback:', error);
                        this.fallbackToManualDetection();
                    }
                } else {
                    this.fallbackToManualDetection();
                }
            }

            calculateScanRegion(video) {
                const { videoWidth, videoHeight } = video;
                const size = Math.min(videoWidth, videoHeight) * 0.6;
                const x = (videoWidth - size) / 2;
                const y = (videoHeight - size) / 2;
                
                return {
                    x: Math.round(x),
                    y: Math.round(y),
                    width: Math.round(size),
                    height: Math.round(size)
                };
            }

            startFrameCounter() {
                const countFrames = () => {
                    if (this.isScanning) {
                        this.frameCount++;
                        this.updateDebug('frames', this.frameCount);
                        requestAnimationFrame(countFrames);
                    }
                };
                countFrames();
            }

            fallbackToManualDetection() {
                if ('BarcodeDetector' in window) {
                    const detector = new BarcodeDetector({ formats: ['qr_code', 'code_128', 'code_39'] });
                    
                    const detectQR = async () => {
                        if (this.isScanning && this.video.readyState === 4) {
                            try {
                                const currentTime = Date.now();
                                if (currentTime - this.lastDetectionAttempt > 200) {
                                    const barcodes = await detector.detect(this.video);
                                    this.lastDetectionAttempt = currentTime;
                                    
                                    if (barcodes.length > 0) {
                                        this.handleQRResult(barcodes[0].rawValue);
                                        return;
                                    }
                                }
                            } catch (error) {
                                console.warn('Manual detection error:', error);
                            }
                        }
                        
                        if (this.isScanning) {
                            requestAnimationFrame(detectQR);
                        }
                    };
                    
                    detectQR();
                    this.updateDebug('detection', 'Manual fallback active');
                } else {
                    this.handleError(new Error('QRã‚³ãƒ¼ãƒ‰æ¤œå‡ºæ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“'));
                }
            }

            handleQRResult(data) {
                if (!this.isScanning) return;
                
                this.updateDebug('detection', 'QR detected!');
                this.showSuccessOverlay();
                
                setTimeout(() => {
                    this.stopScan();
                    this.processInventoryData(data);
                }, 1500);
            }

            processInventoryData(data) {
                console.log('å‡¦ç†ä¸­ã®ãƒ‡ãƒ¼ã‚¿:', data);
                
                this.resultData.textContent = data;
                this.resultDisplay.classList.add('show');
                
                if (this.autoVerifyInventory.checked) {
                    this.verifyWithInventory(data);
                } else {
                    this.verificationStatus.textContent = 'æ‰‹å‹•ç¢ºèªå¾…ã¡';
                    this.verificationStatus.style.color = '#f59e0b';
                }
                
                this.addToVerifiedList(data);
            }

            verifyWithInventory(scannedData) {
                // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã¨ã®ç…§åˆå‡¦ç†
                const matchedItem = this.expectedItems.find(item => 
                    scannedData.includes(item.lotNumber) || 
                    scannedData.includes(item.itemCode)
                );
                
                if (matchedItem) {
                    this.verificationStatus.textContent = `âœ… ç…§åˆæˆåŠŸ: ${matchedItem.name}`;
                    this.verificationStatus.style.color = '#16a34a';
                    
                    // SyteLine IDOã¨ã®é€£æºã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                    this.updateSyteLineInventory(matchedItem, scannedData);
                } else {
                    this.verificationStatus.textContent = 'âŒ ç…§åˆå¤±æ•—: è©²å½“ã™ã‚‹åœ¨åº«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    this.verificationStatus.style.color = '#dc2626';
                }
            }

            updateSyteLineInventory(item, scannedData) {
                console.log('SyteLine IDOæ›´æ–°:', {
                    item: item,
                    scannedData: scannedData,
                    timestamp: new Date().toISOString()
                });
                
                // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã“ã“ã§SyteLine IDOã®APIã‚’å‘¼ã³å‡ºã™
                setTimeout(() => {
                    alert(`åœ¨åº«ç…§åˆå®Œäº†!\n\nå“ç›®: ${item.name}\nãƒ­ãƒƒãƒˆ: ${item.lotNumber}\nä¿ç®¡å ´æ‰€: ${item.location}\n\nâœ… SyteLineåœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²ã•ã‚Œã¾ã—ãŸã€‚`);
                }, 500);
            }

            addToVerifiedList(data) {
                // ç…§åˆæ¸ˆã¿å“ç›®ãƒªã‚¹ãƒˆã«è¿½åŠ 
                const verifiedItemsContainer = document.getElementById('verified-items');
                if (verifiedItemsContainer) {
                    const timestamp = new Date().toLocaleTimeString('ja-JP');
                    const newItem = document.createElement('div');
                    newItem.className = 'item-card fade-in';
                    newItem.innerHTML = `
                        <div class="item-header">
                            <div class="item-info">
                                <div class="item-title">ğŸ“¦ ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿: ${data}</div>
                                <div class="item-meta">ç…§åˆæ™‚åˆ»: ${timestamp}</div>
                                <div class="item-meta">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${this.verificationStatus.textContent}</div>
                                <div class="status-badge status-completed">ç…§åˆå®Œäº†</div>
                            </div>
                        </div>
                    `;
                    
                    // æœ€æ–°ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å…ˆé ­ã«æŒ¿å…¥
                    const firstChild = verifiedItemsContainer.querySelector('.item-card');
                    if (firstChild) {
                        verifiedItemsContainer.insertBefore(newItem, firstChild);
                    } else {
                        verifiedItemsContainer.appendChild(newItem);
                    }
                }
            }

            handleManualInput(lotNumber) {
                console.log('æ‰‹å‹•å…¥åŠ›:', lotNumber);
                this.processInventoryData(lotNumber);
            }

            showManualInput() {
                const lotNumber = prompt('ãƒ­ãƒƒãƒˆç•ªå·ã¾ãŸã¯ã‚¢ã‚¤ãƒ†ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                if (lotNumber && lotNumber.trim()) {
                    this.handleManualInput(lotNumber.trim());
                }
            }

            setupScanTimeout() {
                const timeoutSeconds = parseInt(this.scanTimeoutSelect.value) * 1000;
                this.scanTimeout = setTimeout(() => {
                    if (this.isScanning) {
                        this.handleError(new Error('ã‚¹ã‚­ãƒ£ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'));
                    }
                }, timeoutSeconds);
            }

            clearScanTimeout() {
                if (this.scanTimeout) {
                    clearTimeout(this.scanTimeout);
                    this.scanTimeout = null;
                }
            }

            showSuccessOverlay() {
                this.hideAllOverlays();
                this.successOverlay.classList.remove('hidden');
                setTimeout(() => {
                    this.successOverlay.classList.add('hidden');
                }, 2000);
            }

            showErrorOverlay(message) {
                this.hideAllOverlays();
                this.errorMessage.textContent = message;
                this.errorOverlay.classList.remove('hidden');
                setTimeout(() => {
                    this.errorOverlay.classList.add('hidden');
                }, 3000);
            }

            hideAllOverlays() {
                this.calibrationIndicator.classList.add('hidden');
                this.successOverlay.classList.add('hidden');
                this.errorOverlay.classList.add('hidden');
            }

            pauseScanning() {
                if (this.qrScanner) {
                    this.qrScanner.stop();
                }
                this.scanningAnimation.classList.add('hidden');
                this.updateStatus('ä¸€æ™‚åœæ­¢ä¸­...');
            }

            async resumeScanning() {
                if (this.qrScanner && this.isScanning) {
                    try {
                        await this.qrScanner.start();
                        this.scanningAnimation.classList.remove('hidden');
                        this.updateStatus('åœ¨åº«QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...');
                    } catch (error) {
                        console.warn('Resume scanning failed:', error);
                        this.calibrateCamera();
                    }
                }
            }

            stopScan() {
                this.isScanning = false;
                this.isCalibrating = false;
                this.scanningAnimation.classList.add('hidden');
                this.hideAllOverlays();
                this.clearScanTimeout();
                
                this.cleanupResources();
                this.showScreen('initial');
            }

            cleanupResources() {
                if (this.qrScanner) {
                    this.qrScanner.stop();
                    this.qrScanner.destroy();
                    this.qrScanner = null;
                }
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                this.updateDebug('stream', 'Disconnected');
                this.updateDebug('detection', 'Stopped');
            }

            handleError(error) {
                this.stopScan();
                
                let message = 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                
                switch (error.name) {
                    case 'NotAllowedError':
                        message = 'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰ã‚«ãƒ¡ãƒ©ã®è¨±å¯ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚';
                        break;
                    case 'NotFoundError':
                        message = 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        break;
                    case 'NotSupportedError':
                        message = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®Safariã€Chromeã€ã¾ãŸã¯Edgeã‚’ãŠè©¦ã—ãã ã•ã„ã€‚';
                        break;
                    case 'NotReadableError':
                        message = 'ã‚«ãƒ¡ãƒ©ãŒä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ä¸­ã§ã™ã€‚ä»–ã®ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                        break;
                    case 'SecurityError':
                        message = 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã‚ˆã‚Šã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚HTTPSç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚';
                        break;
                    default:
                        if (error.message) {
                            message = error.message;
                        }
                        break;
                }

                this.showErrorOverlay(message);
                console.error('QR Scanner Error:', error);
            }

            resetScanner() {
                this.stopScan();
                this.calibrationAttempts = 0;
                this.frameCount = 0;
                this.showScreen('initial');
            }

            clearResult() {
                this.resultDisplay.classList.remove('show');
                this.resultData.textContent = '';
                this.verificationStatus.textContent = 'å¾…æ©Ÿä¸­';
                this.verificationStatus.style.color = '#6b7280';
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–æ™‚ã«QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’ä½œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            // ç…§åˆç”»é¢ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸæ™‚ã«QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’åˆæœŸåŒ–
            const originalGoToVerification = window.goToVerification;
            window.goToVerification = function() {
                if (originalGoToVerification) {
                    originalGoToVerification();
                }
                
                // QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’åˆæœŸåŒ–ï¼ˆä¸€åº¦ã ã‘ï¼‰
                if (!window.inventoryQRScanner) {
                    window.inventoryQRScanner = new InventoryQRScanner();
                }
            };
        });
    </script>
</body>
</html>